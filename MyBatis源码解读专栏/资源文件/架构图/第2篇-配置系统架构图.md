# ç¬¬2ç¯‡ï¼šMyBatis é…ç½®ç³»ç»Ÿæ¶æ„å›¾

## ğŸ¯ æ¶æ„å›¾è¯´æ˜

æœ¬æ¶æ„å›¾å±•ç¤ºäº† MyBatis é…ç½®ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶å’Œäº¤äº’å…³ç³»ï¼Œå¸®åŠ©ç†è§£é…ç½®ç³»ç»Ÿçš„æ•´ä½“è®¾è®¡ã€‚

## ğŸ“Š é…ç½®ç³»ç»Ÿæ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "é…ç½®ç³»ç»Ÿå…¥å£"
        A[XMLConfigBuilder] --> B[Configuration]
        C[XMLMapperBuilder] --> B
        D[MapperAnnotationBuilder] --> B
    end
    
    subgraph "é…ç½®è§£æå±‚"
        E[Propertiesè§£æ] --> F[Settingsè§£æ]
        F --> G[TypeAliasesè§£æ]
        G --> H[Pluginsè§£æ]
        H --> I[Environmentsè§£æ]
        I --> J[TypeHandlersè§£æ]
        J --> K[Mappersè§£æ]
    end
    
    subgraph "é…ç½®å­˜å‚¨å±‚"
        B --> L[StrictMapå­˜å‚¨]
        L --> M[MappedStatements]
        L --> N[ResultMaps]
        L --> O[ParameterMaps]
        L --> P[Caches]
        L --> Q[KeyGenerators]
    end
    
    subgraph "é…ç½®ç®¡ç†å±‚"
        B --> R[MapperRegistry]
        B --> S[TypeHandlerRegistry]
        B --> T[TypeAliasRegistry]
        B --> U[InterceptorChain]
        B --> V[LanguageRegistry]
    end
    
    subgraph "é…ç½®éªŒè¯å±‚"
        B --> W[é…ç½®éªŒè¯]
        W --> X[å¿…éœ€é…ç½®æ£€æŸ¥]
        W --> Y[é…ç½®å€¼éªŒè¯]
        W --> Z[ä¾èµ–å…³ç³»éªŒè¯]
    end
    
    A --> E
    C --> K
    D --> K
```

## ğŸ”§ é…ç½®è§£ææµç¨‹æ¶æ„

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant XCB as XMLConfigBuilder
    participant Config as Configuration
    participant XMB as XMLMapperBuilder
    participant MAB as MapperAnnotationBuilder
    
    App->>XCB: åˆ›å»ºè§£æå™¨
    XCB->>XCB: è§£æProperties
    XCB->>XCB: è§£æSettings
    XCB->>XCB: è§£æTypeAliases
    XCB->>XCB: è§£æPlugins
    XCB->>XCB: è§£æEnvironments
    XCB->>XCB: è§£æTypeHandlers
    XCB->>XCB: è§£æMappers
    XCB->>Config: æ„å»ºConfiguration
    Config->>Config: éªŒè¯é…ç½®
    Config->>App: è¿”å›Configuration
    
    Note over XMB: Mapper XMLè§£æ
    XMB->>XMB: è§£æå‘½åç©ºé—´
    XMB->>XMB: è§£æSQLè¯­å¥
    XMB->>Config: æ³¨å†ŒMappedStatement
    
    Note over MAB: æ³¨è§£é…ç½®è§£æ
    MAB->>MAB: æ‰«ææ–¹æ³•æ³¨è§£
    MAB->>MAB: è§£æSQLæ³¨è§£
    MAB->>Config: æ³¨å†ŒMappedStatement
```

## ğŸ“‹ Configuration ç±»ç»“æ„å›¾

```mermaid
classDiagram
    class Configuration {
        -Environment environment
        -boolean safeRowBoundsEnabled
        -boolean safeResultHandlerEnabled
        -boolean mapUnderscoreToCamelCase
        -boolean aggressiveLazyLoading
        -boolean multipleResultSetsEnabled
        -boolean useGeneratedKeys
        -boolean useColumnLabel
        -boolean callSettersOnNulls
        -boolean useActualParamName
        -boolean returnInstanceForEmptyRow
        -String logPrefix
        -Class<? extends Log> logImpl
        -boolean cacheEnabled
        -LocalCacheScope localCacheScope
        -JdbcType jdbcTypeForNull
        -Set<String> lazyLoadTriggerMethods
        -Integer defaultStatementTimeout
        -Integer defaultFetchSize
        -ResultSetType defaultResultSetType
        -ExecutorType defaultExecutorType
        -AutoMappingBehavior autoMappingBehavior
        -AutoMappingUnknownColumnBehavior autoMappingUnknownColumnBehavior
        -ReflectorFactory reflectorFactory
        -ObjectFactory objectFactory
        -ObjectWrapperFactory objectWrapperFactory
        -MapperRegistry mapperRegistry
        -InterceptorChain interceptorChain
        -TypeHandlerRegistry typeHandlerRegistry
        -TypeAliasRegistry typeAliasRegistry
        -LanguageDriverRegistry languageRegistry
        -Map<String, MappedStatement> mappedStatements
        -Map<String, Cache> caches
        -Map<String, ResultMap> resultMaps
        -Map<String, ParameterMap> parameterMaps
        -Map<String, KeyGenerator> keyGenerators
        -Properties variables
        -Set<String> loadedResources
        -String databaseId
        -Class<?> configurationFactory
        -Map<String, String> cacheRefMap
        +addMappedStatement(MappedStatement ms)
        +getMappedStatement(String id)
        +addMapper(Class<T> type)
        +getMapper(Class<T> type, SqlSession sqlSession)
        +validate()
        +setVariables(Properties variables)
        +getVariables()
        +addLoadedResource(String resource)
        +isResourceLoaded(String resource)
    }
    
    class StrictMap {
        -String name
        +put(String key, V value)
        +get(String key)
        +getShortName(String key)
    }
    
    class MapperRegistry {
        -Map<Class<?>, MapperProxyFactory<?>> knownMappers
        +addMapper(Class<T> type)
        +getMapper(Class<T> type, SqlSession sqlSession)
    }
    
    class TypeHandlerRegistry {
        -Map<JdbcType, TypeHandler<?>> jdbcTypeHandlerMap
        -Map<Type, Map<JdbcType, TypeHandler<?>>> typeHandlerMap
        +register(TypeHandler<?> typeHandler)
        +getTypeHandler(Type type, JdbcType jdbcType)
    }
    
    class TypeAliasRegistry {
        -Map<String, Class<?>> typeAliases
        +registerAlias(String alias, Class<?> value)
        +resolveAlias(String string)
    }
    
    class InterceptorChain {
        -List<Interceptor> interceptors
        +addInterceptor(Interceptor interceptor)
        +pluginAll(Object target)
    }
    
    Configuration --> StrictMap
    Configuration --> MapperRegistry
    Configuration --> TypeHandlerRegistry
    Configuration --> TypeAliasRegistry
    Configuration --> InterceptorChain
```

## ğŸ”„ é…ç½®è§£æå™¨å…³ç³»å›¾

```mermaid
graph TD
    subgraph "é…ç½®è§£æå™¨ä½“ç³»"
        A[BaseBuilder] --> B[XMLConfigBuilder]
        A --> C[XMLMapperBuilder]
        A --> D[MapperAnnotationBuilder]
        A --> E[XMLStatementBuilder]
        A --> F[XMLResultMapBuilder]
        A --> G[XMLCacheRefBuilder]
    end
    
    subgraph "è§£æå™¨èŒè´£"
        B --> H[ä¸»é…ç½®æ–‡ä»¶è§£æ]
        C --> I[Mapper XMLè§£æ]
        D --> J[æ³¨è§£é…ç½®è§£æ]
        E --> K[SQLè¯­å¥è§£æ]
        F --> L[ç»“æœæ˜ å°„è§£æ]
        G --> M[ç¼“å­˜å¼•ç”¨è§£æ]
    end
    
    subgraph "è§£æç»“æœ"
        H --> N[Configurationå¯¹è±¡]
        I --> O[MappedStatement]
        J --> O
        K --> O
        L --> P[ResultMap]
        M --> Q[Cache]
    end
```

## ğŸ¯ é…ç½®é¡¹ç”Ÿå‘½å‘¨æœŸå›¾

```mermaid
stateDiagram-v2
    [*] --> è§£æé˜¶æ®µ
    è§£æé˜¶æ®µ --> å­˜å‚¨é˜¶æ®µ
    å­˜å‚¨é˜¶æ®µ --> éªŒè¯é˜¶æ®µ
    éªŒè¯é˜¶æ®µ --> ä½¿ç”¨é˜¶æ®µ
    ä½¿ç”¨é˜¶æ®µ --> é”€æ¯é˜¶æ®µ
    é”€æ¯é˜¶æ®µ --> [*]
    
    è§£æé˜¶æ®µ : ä»XML/æ³¨è§£è§£æé…ç½®é¡¹
    å­˜å‚¨é˜¶æ®µ : å­˜å‚¨åˆ°Configurationå¯¹è±¡
    éªŒè¯é˜¶æ®µ : éªŒè¯é…ç½®æ­£ç¡®æ€§
    ä½¿ç”¨é˜¶æ®µ : è¿è¡Œæ—¶ä½¿ç”¨é…ç½®é¡¹
    é”€æ¯é˜¶æ®µ : åº”ç”¨å…³é—­æ—¶æ¸…ç†
```

## ğŸ”§ é…ç½®æ‰©å±•æœºåˆ¶å›¾

```mermaid
graph TB
    subgraph "æ‰©å±•ç‚¹"
        A[æ’ä»¶ç³»ç»Ÿ] --> B[Interceptor]
        C[è‡ªå®šä¹‰é…ç½®] --> D[Properties]
        E[ç±»å‹å¤„ç†å™¨] --> F[TypeHandler]
        G[å¯¹è±¡å·¥å‚] --> H[ObjectFactory]
        I[è¯­è¨€é©±åŠ¨] --> J[LanguageDriver]
    end
    
    subgraph "é›†æˆæœºåˆ¶"
        B --> K[InterceptorChain]
        D --> L[Configuration.variables]
        F --> M[TypeHandlerRegistry]
        H --> N[Configuration.objectFactory]
        J --> O[LanguageDriverRegistry]
    end
    
    subgraph "ä½¿ç”¨åœºæ™¯"
        K --> P[SQLæ‰§è¡Œæ‹¦æˆª]
        L --> Q[è‡ªå®šä¹‰é…ç½®é¡¹]
        M --> R[ç±»å‹è½¬æ¢]
        N --> S[å¯¹è±¡åˆ›å»º]
        O --> T[SQLè¯­è¨€å¤„ç†]
    end
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ¶æ„å›¾

```mermaid
graph TB
    subgraph "æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"
        A[æ‡’åŠ è½½æœºåˆ¶] --> B[å»¶è¿ŸåŠ è½½éå¿…éœ€é…ç½®]
        C[ç¼“å­˜æœºåˆ¶] --> D[é…ç½®å¯¹è±¡ç¼“å­˜]
        E[æ‰¹é‡å¤„ç†] --> F[æ‰¹é‡è§£æç›¸å…³é…ç½®]
        G[å†…å­˜ä¼˜åŒ–] --> H[ä¼˜åŒ–å†…å­˜ä½¿ç”¨]
    end
    
    subgraph "ä¼˜åŒ–å®ç°"
        B --> I[æŒ‰éœ€åŠ è½½]
        D --> J[StrictMapç¼“å­˜]
        F --> K[æ‰¹é‡è§£ææ–¹æ³•]
        H --> L[å¯¹è±¡æ± æŠ€æœ¯]
    end
    
    subgraph "æ€§èƒ½æŒ‡æ ‡"
        I --> M[å¯åŠ¨æ—¶é—´ä¼˜åŒ–]
        J --> N[å†…å­˜ä½¿ç”¨ä¼˜åŒ–]
        K --> O[è§£ææ•ˆç‡æå‡]
        L --> P[GCå‹åŠ›å‡å°‘]
    end
```

## ğŸ¯ å­¦ä¹ é‡ç‚¹æç¤º

### 1. æ ¸å¿ƒç»„ä»¶ç†è§£

- **Configuration ç±»**ï¼šé…ç½®ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®é¡¹
- **XMLConfigBuilder**ï¼šä¸»é…ç½®æ–‡ä»¶è§£æå™¨
- **XMLMapperBuilder**ï¼šMapper XML è§£æå™¨
- **MapperAnnotationBuilder**ï¼šæ³¨è§£é…ç½®è§£æå™¨

### 2. å…³é”®æµç¨‹æŒæ¡

- **é…ç½®è§£ææµç¨‹**ï¼šä» XML åˆ° Configuration å¯¹è±¡çš„å®Œæ•´è¿‡ç¨‹
- **é…ç½®éªŒè¯æµç¨‹**ï¼šé…ç½®é¡¹éªŒè¯å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- **é…ç½®ä½¿ç”¨æµç¨‹**ï¼šé…ç½®é¡¹åœ¨è¿è¡Œæ—¶å¦‚ä½•ä½¿ç”¨

### 3. è®¾è®¡æ¨¡å¼åº”ç”¨

- **Builder æ¨¡å¼**ï¼šç”¨äºæ„å»ºå¤æ‚çš„é…ç½®å¯¹è±¡
- **Factory æ¨¡å¼**ï¼šç”¨äºåˆ›å»ºå„ç§å¯¹è±¡å®ä¾‹
- **Registry æ¨¡å¼**ï¼šç”¨äºç®¡ç†å„ç§æ³¨å†Œè¡¨
- **Strategy æ¨¡å¼**ï¼šç”¨äºé€‰æ‹©ä¸åŒçš„å¤„ç†ç­–ç•¥

### 4. æ‰©å±•æœºåˆ¶ç†è§£

- **æ’ä»¶ç³»ç»Ÿ**ï¼šå¦‚ä½•é€šè¿‡æ’ä»¶æ‰©å±•åŠŸèƒ½
- **è‡ªå®šä¹‰é…ç½®**ï¼šå¦‚ä½•æ·»åŠ è‡ªå®šä¹‰é…ç½®é¡¹
- **ç±»å‹å¤„ç†**ï¼šå¦‚ä½•è‡ªå®šä¹‰ç±»å‹è½¬æ¢

---

**é€šè¿‡æ¶æ„å›¾ç†è§£é…ç½®ç³»ç»Ÿçš„æ•´ä½“è®¾è®¡ï¼Œä¸ºæ·±å…¥æºç åˆ†æå¥ å®šåŸºç¡€ï¼** ğŸš€

