# StatementHandlerè¯­å¥å¤„ç†å™¨æ¶æ„æ€»è§ˆåˆ†æ

## ğŸ“‹ ç›®å½•
1. [StatementHandlerä½“ç³»æ¶æ„](#1-statementhandlerä½“ç³»æ¶æ„)
2. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#2-æ ¸å¿ƒç»„ä»¶åˆ†æ)
3. [å¤„ç†æµç¨‹æ¶æ„](#3-å¤„ç†æµç¨‹æ¶æ„)
4. [åä½œå…³ç³»åˆ†æ](#4-åä½œå…³ç³»åˆ†æ)
5. [è®¾è®¡æ¨¡å¼åº”ç”¨](#5-è®¾è®¡æ¨¡å¼åº”ç”¨)
6. [æ€§èƒ½ç‰¹å¾åˆ†æ](#6-æ€§èƒ½ç‰¹å¾åˆ†æ)

## 1. StatementHandlerä½“ç³»æ¶æ„

### 1.1 æ•´ä½“æ¶æ„å›¾

```mermaid
classDiagram
    class StatementHandler {
        <<interface>>
        +prepare(Connection, Integer) Statement
        +parameterize(Statement) void
        +query(Statement, ResultHandler) List~E~
        +update(Statement) int
        +batch(Statement) void
        +queryCursor(Statement) Cursor~E~
        +getBoundSql() BoundSql
    }
    
    class BaseStatementHandler {
        <<abstract>>
        #configuration Configuration
        #objectFactory ObjectFactory
        #typeHandlerRegistry TypeHandlerRegistry
        #resultSetHandler ResultSetHandler
        #parameterHandler ParameterHandler
        #executor Executor
        #mappedStatement MappedStatement
        #rowBounds RowBounds
        #boundSql BoundSql
        +prepare(Connection, Integer) Statement
        +parameterize(Statement) void
        +getBoundSql() BoundSql
        #instantiateStatement(Connection) Statement
        #setStatementTimeout(Statement) void
        #setFetchSize(Statement) void
    }
    
    class SimpleStatementHandler {
        +update(Statement) int
        +batch(Statement) void
        +query(Statement, ResultHandler) List~E~
        +queryCursor(Statement) Cursor~E~
        #instantiateStatement(Connection) Statement
    }
    
    class PreparedStatementHandler {
        +update(Statement) int
        +batch(Statement) void
        +query(Statement, ResultHandler) List~E~
        +queryCursor(Statement) Cursor~E~
        #instantiateStatement(Connection) Statement
    }
    
    class CallableStatementHandler {
        +update(Statement) int
        +batch(Statement) void
        +query(Statement, ResultHandler) List~E~
        +queryCursor(Statement) Cursor~E~
        #instantiateStatement(Connection) Statement
    }
    
    class RoutingStatementHandler {
        -delegate StatementHandler
        +prepare(Connection, Integer) Statement
        +parameterize(Statement) void
        +query(Statement, ResultHandler) List~E~
        +update(Statement) int
        +batch(Statement) void
        +queryCursor(Statement) Cursor~E~
        +getBoundSql() BoundSql
    }
    
    StatementHandler <|.. BaseStatementHandler
    BaseStatementHandler <|-- SimpleStatementHandler
    BaseStatementHandler <|-- PreparedStatementHandler
    BaseStatementHandler <|-- CallableStatementHandler
    StatementHandler <|.. RoutingStatementHandler
    RoutingStatementHandler --> StatementHandler : delegates to
```

### 1.2 ç±»èŒè´£åˆ†å·¥

| ç»„ä»¶ | èŒè´£ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **StatementHandler** | å®šä¹‰è¯­å¥å¤„ç†å™¨æ¥å£ | ç»Ÿä¸€æŠ½è±¡ | æ‰€æœ‰åœºæ™¯çš„åŸºç¡€æ¥å£ |
| **BaseStatementHandler** | æä¾›é€šç”¨åŠŸèƒ½å®ç° | æ¨¡æ¿æ–¹æ³•æ¨¡å¼ | å­ç±»çš„å…±åŒåŸºç¡€ |
| **SimpleStatementHandler** | å¤„ç†ç®€å•SQLè¯­å¥ | æ¯æ¬¡ç¼–è¯‘SQL | åŠ¨æ€SQLã€ç®€å•æŸ¥è¯¢ |
| **PreparedStatementHandler** | å¤„ç†é¢„ç¼–è¯‘è¯­å¥ | SQLé¢„ç¼–è¯‘ | å¤§å¤šæ•°åœºæ™¯çš„é¦–é€‰ |
| **CallableStatementHandler** | å¤„ç†å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ | æ”¯æŒIN/OUTå‚æ•° | å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ |
| **RoutingStatementHandler** | è·¯ç”±åˆ°å…·ä½“å¤„ç†å™¨ | å§”æ‰˜æ¨¡å¼ | ç»Ÿä¸€å…¥å£ç‚¹ |

## 2. æ ¸å¿ƒç»„ä»¶åˆ†æ

### 2.1 StatementHandleræ¥å£è®¾è®¡

```java
/**
 * StatementHandleræ ¸å¿ƒæ¥å£
 * å®šä¹‰äº†SQLè¯­å¥å¤„ç†çš„æ ‡å‡†æµç¨‹
 */
public interface StatementHandler {
    // Statementå‡†å¤‡é˜¶æ®µ
    Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException;
    
    // å‚æ•°è®¾ç½®é˜¶æ®µ
    void parameterize(Statement statement) throws SQLException;
    
    // æŸ¥è¯¢æ‰§è¡Œé˜¶æ®µ
    <E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException;
    
    // æ›´æ–°æ‰§è¡Œé˜¶æ®µ
    int update(Statement statement) throws SQLException;
    
    // æ‰¹é‡æ“ä½œé˜¶æ®µ
    void batch(Statement statement) throws SQLException;
    
    // æ¸¸æ ‡æŸ¥è¯¢é˜¶æ®µ
    <E> Cursor<E> queryCursor(Statement statement) throws SQLException;
    
    // è·å–ç»‘å®šSQL
    BoundSql getBoundSql();
}
```

### 2.2 BaseStatementHandleræŠ½è±¡åŸºç±»

```java
/**
 * åŸºç¡€StatementHandlerå®ç°
 * é‡‡ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå®šä¹‰é€šç”¨å¤„ç†æµç¨‹
 */
public abstract class BaseStatementHandler implements StatementHandler {
    // æ ¸å¿ƒç»„ä»¶ä¾èµ–
    protected final Configuration configuration;
    protected final ObjectFactory objectFactory;
    protected final TypeHandlerRegistry typeHandlerRegistry;
    protected final ResultSetHandler resultSetHandler;
    protected final ParameterHandler parameterHandler;
    
    // æ‰§è¡Œä¸Šä¸‹æ–‡
    protected final Executor executor;
    protected final MappedStatement mappedStatement;
    protected final RowBounds rowBounds;
    protected final BoundSql boundSql;
    
    // æ¨¡æ¿æ–¹æ³•ï¼šStatementå‡†å¤‡
    @Override
    public Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException {
        Statement statement = null;
        try {
            // å­ç±»å®ç°å…·ä½“çš„Statementåˆ›å»ºé€»è¾‘
            statement = instantiateStatement(connection);
            // è®¾ç½®è¶…æ—¶æ—¶é—´
            setStatementTimeout(statement, transactionTimeout);
            // è®¾ç½®è·å–å¤§å°
            setFetchSize(statement);
            return statement;
        } catch (SQLException e) {
            closeStatement(statement);
            throw e;
        } catch (Exception e) {
            closeStatement(statement);
            throw new ExecutorException("Error preparing statement.  Cause: " + e, e);
        }
    }
    
    // æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å®ç°å…·ä½“çš„Statementåˆ›å»º
    protected abstract Statement instantiateStatement(Connection connection) throws SQLException;
}
```

### 2.3 è·¯ç”±StatementHandler

```java
/**
 * è·¯ç”±StatementHandler
 * æ ¹æ®StatementTypeé€‰æ‹©å…·ä½“çš„å¤„ç†å™¨å®ç°
 */
public class RoutingStatementHandler implements StatementHandler {
    private final StatementHandler delegate;
    
    public RoutingStatementHandler(Executor executor, MappedStatement ms, Object parameter, 
                                   RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) {
        // æ ¹æ®è¯­å¥ç±»å‹åˆ›å»ºå¯¹åº”çš„å¤„ç†å™¨
        switch (ms.getStatementType()) {
            case STATEMENT:
                delegate = new SimpleStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);
                break;
            case PREPARED:
                delegate = new PreparedStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);
                break;
            case CALLABLE:
                delegate = new CallableStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);
                break;
            default:
                throw new ExecutorException("Unknown statement type: " + ms.getStatementType());
        }
    }
    
    // å§”æ‰˜ç»™å…·ä½“çš„å¤„ç†å™¨
    @Override
    public Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException {
        return delegate.prepare(connection, transactionTimeout);
    }
    
    // ... å…¶ä»–æ–¹æ³•éƒ½æ˜¯å§”æ‰˜è°ƒç”¨
}
```

## 3. å¤„ç†æµç¨‹æ¶æ„

### 3.1 StatementHandleræ‰§è¡Œæµç¨‹

```mermaid
sequenceDiagram
    participant Executor as Executor
    participant Router as RoutingStatementHandler
    participant Handler as BaseStatementHandler
    participant PH as ParameterHandler
    participant RSH as ResultSetHandler
    participant JDBC as JDBC Statement
    
    Executor->>Router: newStatementHandler()
    Router->>Handler: create specific handler
    
    Executor->>Router: prepare(connection, timeout)
    Router->>Handler: prepare(connection, timeout)
    Handler->>Handler: instantiateStatement(connection)
    Handler->>JDBC: create Statement
    Handler->>Handler: setStatementTimeout()
    Handler->>Handler: setFetchSize()
    Handler-->>Router: Statement
    Router-->>Executor: Statement
    
    Executor->>Router: parameterize(statement)
    Router->>Handler: parameterize(statement)
    Handler->>PH: setParameters(statement)
    PH->>JDBC: setParameter(index, value)
    
    Executor->>Router: query/update(statement)
    Router->>Handler: query/update(statement)
    Handler->>JDBC: execute()
    JDBC-->>Handler: ResultSet/UpdateCount
    Handler->>RSH: handleResultSets(statement)
    RSH-->>Handler: List<Object>
    Handler-->>Router: result
    Router-->>Executor: result
```

### 3.2 ä¸åŒStatementHandlerçš„å¤„ç†å·®å¼‚

```mermaid
graph TD
    A[SQLæ‰§è¡Œè¯·æ±‚] --> B{StatementType}
    
    B -->|STATEMENT| C[SimpleStatementHandler]
    B -->|PREPARED| D[PreparedStatementHandler]
    B -->|CALLABLE| E[CallableStatementHandler]
    
    C --> C1[åˆ›å»ºStatement]
    C1 --> C2[ç›´æ¥æ‰§è¡ŒSQL+å‚æ•°]
    C2 --> C3[å¤„ç†ç»“æœ]
    
    D --> D1[åˆ›å»ºPreparedStatement]
    D1 --> D2[é¢„ç¼–è¯‘SQL]
    D2 --> D3[è®¾ç½®å‚æ•°]
    D3 --> D4[æ‰§è¡Œè¯­å¥]
    D4 --> D5[å¤„ç†ç»“æœ]
    
    E --> E1[åˆ›å»ºCallableStatement]
    E1 --> E2[é¢„ç¼–è¯‘å­˜å‚¨è¿‡ç¨‹]
    E2 --> E3[è®¾ç½®INå‚æ•°]
    E3 --> E4[æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹]
    E4 --> E5[è·å–OUTå‚æ•°]
    E5 --> E6[å¤„ç†ç»“æœ]
```

## 4. åä½œå…³ç³»åˆ†æ

### 4.1 StatementHandlerç”Ÿæ€ç³»ç»Ÿ

```mermaid
graph LR
    subgraph "Executor Layer"
        EX[Executor]
    end
    
    subgraph "StatementHandler Layer"
        SH[StatementHandler]
        RSH[RoutingStatementHandler]
        BSH[BaseStatementHandler]
        SSH[SimpleStatementHandler]
        PSH[PreparedStatementHandler]
        CSH[CallableStatementHandler]
    end
    
    subgraph "Helper Layer"
        PH[ParameterHandler]
        RSEH[ResultSetHandler]
        TH[TypeHandler]
    end
    
    subgraph "JDBC Layer"
        STMT[Statement]
        PSTMT[PreparedStatement]
        CSTMT[CallableStatement]
    end
    
    EX --> RSH
    RSH --> SSH
    RSH --> PSH
    RSH --> CSH
    BSH --> PH
    BSH --> RSEH
    PH --> TH
    SSH --> STMT
    PSH --> PSTMT
    CSH --> CSTMT
```

### 4.2 ç»„ä»¶åä½œèŒè´£

| åä½œå…³ç³» | èŒè´£åˆ†å·¥ | äº¤äº’æ–¹å¼ |
|----------|----------|----------|
| **Executor â†” StatementHandler** | Executorè´Ÿè´£æ•´ä½“æµç¨‹ï¼ŒStatementHandlerè´Ÿè´£SQLå¤„ç† | æ–¹æ³•è°ƒç”¨ |
| **StatementHandler â†” ParameterHandler** | StatementHandlerç®¡ç†Statementï¼ŒParameterHandlerè®¾ç½®å‚æ•° | å§”æ‰˜è°ƒç”¨ |
| **StatementHandler â†” ResultSetHandler** | StatementHandleræ‰§è¡ŒSQLï¼ŒResultSetHandlerå¤„ç†ç»“æœ | å§”æ‰˜è°ƒç”¨ |
| **RoutingStatementHandler â†” å…·ä½“Handler** | Routerè´Ÿè´£è·¯ç”±ï¼Œå…·ä½“Handlerè´Ÿè´£å®ç° | å§”æ‰˜æ¨¡å¼ |

## 5. è®¾è®¡æ¨¡å¼åº”ç”¨

### 5.1 æ¨¡æ¿æ–¹æ³•æ¨¡å¼

```java
// BaseStatementHandlerä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼
public abstract class BaseStatementHandler implements StatementHandler {
    
    // æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰ç®—æ³•éª¨æ¶
    @Override
    public Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException {
        Statement statement = null;
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºStatementï¼ˆå­ç±»å®ç°ï¼‰
            statement = instantiateStatement(connection);
            // æ­¥éª¤2ï¼šè®¾ç½®è¶…æ—¶ï¼ˆé€šç”¨é€»è¾‘ï¼‰
            setStatementTimeout(statement, transactionTimeout);
            // æ­¥éª¤3ï¼šè®¾ç½®è·å–å¤§å°ï¼ˆé€šç”¨é€»è¾‘ï¼‰
            setFetchSize(statement);
            return statement;
        } catch (Exception e) {
            closeStatement(statement);
            throw new ExecutorException("Error preparing statement.", e);
        }
    }
    
    // æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å®ç°å…·ä½“æ­¥éª¤
    protected abstract Statement instantiateStatement(Connection connection) throws SQLException;
}
```

### 5.2 ç­–ç•¥æ¨¡å¼

```java
// ä¸åŒçš„StatementHandlerå®ç°ä¸åŒçš„å¤„ç†ç­–ç•¥
public class PreparedStatementHandler extends BaseStatementHandler {
    @Override
    protected Statement instantiateStatement(Connection connection) throws SQLException {
        String sql = boundSql.getSql();
        if (mappedStatement.getKeyGenerator() instanceof Jdbc3KeyGenerator) {
            String[] keyColumnNames = mappedStatement.getKeyColumns();
            if (keyColumnNames == null) {
                return connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
            } else {
                return connection.prepareStatement(sql, keyColumnNames);
            }
        } else if (mappedStatement.getResultSetType() == ResultSetType.DEFAULT) {
            return connection.prepareStatement(sql);
        } else {
            return connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), 
                                               ResultSet.CONCUR_READ_ONLY);
        }
    }
}
```

### 5.3 å§”æ‰˜æ¨¡å¼

```java
// RoutingStatementHandlerä½¿ç”¨å§”æ‰˜æ¨¡å¼
public class RoutingStatementHandler implements StatementHandler {
    private final StatementHandler delegate;
    
    // æ‰€æœ‰æ–¹æ³•éƒ½å§”æ‰˜ç»™å…·ä½“çš„StatementHandler
    @Override
    public Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException {
        return delegate.prepare(connection, transactionTimeout);
    }
    
    @Override
    public void parameterize(Statement statement) throws SQLException {
        delegate.parameterize(statement);
    }
    
    // ... å…¶ä»–å§”æ‰˜æ–¹æ³•
}
```

## 6. æ€§èƒ½ç‰¹å¾åˆ†æ

### 6.1 ä¸åŒStatementHandleræ€§èƒ½å¯¹æ¯”

| StatementHandler | SQLç¼–è¯‘ | å‚æ•°å¤„ç† | æ€§èƒ½ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------------------|---------|----------|----------|----------|
| **SimpleStatementHandler** | æ¯æ¬¡ç¼–è¯‘ | å­—ç¬¦ä¸²æ‹¼æ¥ | çµæ´»ä½†æ…¢ | åŠ¨æ€SQLï¼Œå°‘é‡æ‰§è¡Œ |
| **PreparedStatementHandler** | é¢„ç¼–è¯‘ç¼“å­˜ | å‚æ•°ç»‘å®š | å¿«é€Ÿå®‰å…¨ | å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ |
| **CallableStatementHandler** | é¢„ç¼–è¯‘ç¼“å­˜ | IN/OUTå‚æ•° | åŠŸèƒ½å®Œæ•´ | å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ |

### 6.2 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

```java
// PreparedStatementHandlerçš„æ€§èƒ½ä¼˜åŠ¿
public class PreparedStatementHandler extends BaseStatementHandler {
    
    @Override
    protected Statement instantiateStatement(Connection connection) throws SQLException {
        String sql = boundSql.getSql();
        
        // 1. SQLé¢„ç¼–è¯‘ï¼Œé¿å…é‡å¤è§£æ
        PreparedStatement ps = connection.prepareStatement(sql);
        
        // 2. æ”¯æŒå‚æ•°ç»‘å®šï¼Œé˜²æ­¢SQLæ³¨å…¥
        // 3. æ•°æ®åº“å¯ä»¥ç¼“å­˜æ‰§è¡Œè®¡åˆ’
        // 4. æ”¯æŒæ‰¹é‡æ“ä½œä¼˜åŒ–
        
        return ps;
    }
    
    @Override
    public void parameterize(Statement statement) throws SQLException {
        // ä½¿ç”¨ParameterHandlerè®¾ç½®å‚æ•°ï¼Œç±»å‹å®‰å…¨
        parameterHandler.setParameters((PreparedStatement) statement);
    }
}
```

### 6.3 å†…å­˜å’Œèµ„æºç®¡ç†

```java
// BaseStatementHandlerä¸­çš„èµ„æºç®¡ç†
public abstract class BaseStatementHandler implements StatementHandler {
    
    @Override
    public Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException {
        Statement statement = null;
        try {
            statement = instantiateStatement(connection);
            setStatementTimeout(statement, transactionTimeout);
            setFetchSize(statement);
            return statement;
        } catch (SQLException e) {
            // å¼‚å¸¸æ—¶ç¡®ä¿èµ„æºé‡Šæ”¾
            closeStatement(statement);
            throw e;
        } catch (Exception e) {
            // ä»»ä½•å¼‚å¸¸éƒ½è¦æ¸…ç†èµ„æº
            closeStatement(statement);
            throw new ExecutorException("Error preparing statement.  Cause: " + e, e);
        }
    }
    
    protected void closeStatement(Statement statement) {
        try {
            if (statement != null) {
                statement.close();
            }
        } catch (SQLException e) {
            // ignore
        }
    }
}
```

## ğŸ“Š æ¶æ„æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
1. **ç»Ÿä¸€æŠ½è±¡**: StatementHandleræ¥å£æä¾›ç»Ÿä¸€çš„SQLå¤„ç†æŠ½è±¡
2. **çµæ´»æ‰©å±•**: åŸºäºæ¥å£å’ŒæŠ½è±¡ç±»çš„è®¾è®¡æ”¯æŒçµæ´»æ‰©å±•
3. **èŒè´£åˆ†ç¦»**: ä¸åŒHandlerä¸“æ³¨ä¸åŒç±»å‹çš„SQLå¤„ç†
4. **æ€§èƒ½ä¼˜åŒ–**: PreparedStatementé¢„ç¼–è¯‘æä¾›æœ€ä½³æ€§èƒ½
5. **èµ„æºç®¡ç†**: å®Œå–„çš„èµ„æºåˆ›å»ºå’Œé‡Šæ”¾æœºåˆ¶

### è®¾è®¡ç²¾é«“
1. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**: å®šä¹‰å¤„ç†æµç¨‹ï¼Œå­ç±»å®ç°å…·ä½“é€»è¾‘
2. **ç­–ç•¥æ¨¡å¼**: ä¸åŒHandlerå®ç°ä¸åŒçš„å¤„ç†ç­–ç•¥
3. **å§”æ‰˜æ¨¡å¼**: Routerç»Ÿä¸€å…¥å£ï¼Œå§”æ‰˜ç»™å…·ä½“å¤„ç†å™¨
4. **ç»„åˆæ¨¡å¼**: ä¸ParameterHandlerã€ResultSetHandleråä½œ

### æ‰©å±•è¦ç‚¹
1. **è‡ªå®šä¹‰StatementHandler**: ç»§æ‰¿BaseStatementHandlerå®ç°ç‰¹æ®Šéœ€æ±‚
2. **æ’ä»¶æ‹¦æˆª**: å¯ä»¥æ‹¦æˆªStatementHandlerçš„å…³é”®æ–¹æ³•
3. **æ€§èƒ½ç›‘æ§**: åœ¨prepareã€executeç­‰å…³é”®ç‚¹æ·»åŠ ç›‘æ§
4. **è¿æ¥æ± ä¼˜åŒ–**: åˆç†è®¾ç½®Statementç›¸å…³å‚æ•°

è¿™ä¸ªæ¶æ„è®¾è®¡ä½“ç°äº†MyBatisåœ¨SQLå¤„ç†å±‚é¢çš„æ·±åº¦æ€è€ƒï¼Œä¸ºä¸åŒåœºæ™¯æä¾›äº†æœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆã€‚