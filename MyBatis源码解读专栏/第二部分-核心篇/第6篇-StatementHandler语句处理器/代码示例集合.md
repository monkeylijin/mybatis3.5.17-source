# ç¬¬6ç¯‡ï¼šStatementHandlerè¯­å¥å¤„ç†å™¨ - ä»£ç ç¤ºä¾‹é›†åˆ

## ğŸ“‹ ç¤ºä¾‹æ¦‚è§ˆ

æœ¬æ–‡æ¡£æä¾›å®Œæ•´å¯è¿è¡Œçš„ä»£ç ç¤ºä¾‹ï¼Œæ¶µç›–StatementHandlerçš„å„ç§ä½¿ç”¨åœºæ™¯ã€‚

## 1. PreparedStatementHandleråŸºæœ¬ç¤ºä¾‹

```java
/**
 * PreparedStatementä½¿ç”¨ç¤ºä¾‹
 * æ ¸å¿ƒç‰¹ç‚¹ï¼šSQLé¢„ç¼–è¯‘ã€å‚æ•°ç»‘å®šã€é˜²SQLæ³¨å…¥
 */
public class PreparedStatementExample {
    public static void main(String[] args) throws Exception {
        SqlSessionFactory factory = new SqlSessionFactoryBuilder()
            .build(Resources.getResourceAsStream("mybatis-config.xml"));
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // å•å‚æ•°æŸ¥è¯¢
            User user = mapper.findById(1L);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
            
            // å¤šå‚æ•°æŸ¥è¯¢
            List<User> users = mapper.findByNameAndStatus("å¼ ä¸‰", 1);
            
            // æ’å…¥å¹¶è¿”å›ä¸»é”®
            User newUser = new User("æå››", "lisi@example.com", 25);
            mapper.insert(newUser);
            System.out.println("ç”ŸæˆID: " + newUser.getId());
            
            session.commit();
        }
    }
}
```

## 2. æ‰¹é‡æ“ä½œç¤ºä¾‹

```java
/**
 * æ‰¹é‡æ“ä½œç¤ºä¾‹
 * æ¼”ç¤ºBatchExecutorçš„é«˜æ€§èƒ½æ‰¹é‡å¤„ç†
 */
public class BatchOperationExample {
    public static void main(String[] args) throws Exception {
        SqlSessionFactory factory = buildFactory();
        
        try (SqlSession session = factory.openSession(ExecutorType.BATCH)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // æ‰¹é‡æ’å…¥1000æ¡æ•°æ®
            for (int i = 0; i < 1000; i++) {
                User user = new User("ç”¨æˆ·" + i, "user" + i + "@test.com", 20 + i % 50);
                mapper.insert(user);
            }
            
            session.flushStatements();  // æ‰§è¡Œæ‰¹æ¬¡
            session.commit();
        }
    }
}
```

## 3. è‡ªå®šä¹‰ç›‘æ§StatementHandler

```java
/**
 * SQLæ‰§è¡Œç›‘æ§Handler
 * åŠŸèƒ½ï¼šè®°å½•æ‰§è¡Œæ—¶é—´ã€ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ã€æ£€æµ‹æ…¢SQL
 */
public class MonitoringStatementHandler implements StatementHandler {
    private final StatementHandler delegate;
    private long startTime;
    
    @Override
    public Statement prepare(Connection conn, Integer timeout) throws Exception {
        startTime = System.currentTimeMillis();
        return delegate.prepare(conn, timeout);
    }
    
    @Override
    public <E> List<E> query(Statement stmt, ResultHandler handler) throws Exception {
        List<E> results = delegate.query(stmt, handler);
        long cost = System.currentTimeMillis() - startTime;
        System.out.println("SQLæ‰§è¡Œè€—æ—¶: " + cost + "ms, ç»“æœæ•°: " + results.size());
        return results;
    }
    
    // å…¶ä»–æ–¹æ³•å§”æ‰˜ç»™delegate...
}
```

## 4. æ€§èƒ½å¯¹æ¯”æµ‹è¯•

```java
/**
 * Statementå¤ç”¨æ€§èƒ½æµ‹è¯•
 */
public class PerformanceTest {
    public static void main(String[] args) throws Exception {
        SqlSessionFactory factory = buildFactory();
        
        // SimpleExecutoræµ‹è¯•
        long simpleTime = testExecutor(factory, ExecutorType.SIMPLE, 1000);
        
        // ReuseExecutoræµ‹è¯•
        long reuseTime = testExecutor(factory, ExecutorType.REUSE, 1000);
        
        System.out.println("SimpleExecutor: " + simpleTime + "ms");
        System.out.println("ReuseExecutor: " + reuseTime + "ms");
        System.out.println("æ€§èƒ½æå‡: " + ((simpleTime - reuseTime) * 100.0 / simpleTime) + "%");
    }
    
    private static long testExecutor(SqlSessionFactory factory, ExecutorType type, int times) {
        try (SqlSession session = factory.openSession(type)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            long start = System.currentTimeMillis();
            for (int i = 0; i < times; i++) {
                mapper.findById(1L);
            }
            return System.currentTimeMillis() - start;
        }
    }
}
```

## 5. CallableStatementå­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹

```java
/**
 * å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ç¤ºä¾‹
 */
public class CallableStatementExample {
    public static void main(String[] args) throws Exception {
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            Map<String, Object> params = new HashMap<>();
            params.put("status", 1);      // INå‚æ•°
            params.put("userCount", null); // OUTå‚æ•°
            
            mapper.countUsersByStatus(params);
            
            Integer count = (Integer) params.get("userCount");
            System.out.println("ç”¨æˆ·æ•°é‡: " + count);
        }
    }
}
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

æ‰€æœ‰ç¤ºä¾‹éƒ½éœ€è¦é…ç½®ï¼š
1. mybatis-config.xmlé…ç½®æ–‡ä»¶
2. UserMapper.xmlæ˜ å°„æ–‡ä»¶
3. Userå®ä½“ç±»å’ŒUserMapperæ¥å£

è¯¦ç»†é…ç½®è¯·å‚è€ƒå®è·µä»»åŠ¡æŒ‡å¯¼æ–‡æ¡£ã€‚
