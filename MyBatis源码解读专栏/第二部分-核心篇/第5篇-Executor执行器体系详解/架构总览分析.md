# Executorä½“ç³»æ¶æ„æ€»è§ˆ

## ğŸ—ï¸ æ‰§è¡Œå™¨ç»§æ‰¿å…³ç³»

MyBatisçš„Executorä½“ç³»é‡‡ç”¨äº†å¤šå±‚æ¬¡çš„è®¾è®¡ï¼Œé€šè¿‡æ¥å£å®šä¹‰è§„èŒƒï¼ŒæŠ½è±¡ç±»æä¾›é€šç”¨åŠŸèƒ½ï¼Œå…·ä½“ç±»å®ç°ç‰¹å®šç­–ç•¥ã€‚

### ç±»å›¾å…³ç³»

```mermaid
classDiagram
    class Executor {
        <<interface>>
        +update(MappedStatement, Object) int
        +query(MappedStatement, Object, RowBounds, ResultHandler) List~E~
        +queryCursor(MappedStatement, Object, RowBounds) Cursor~E~
        +flushStatements() List~BatchResult~
        +commit(boolean) void
        +rollback(boolean) void
        +createCacheKey(MappedStatement, Object, RowBounds, BoundSql) CacheKey
        +clearLocalCache() void
        +getTransaction() Transaction
        +close(boolean) void
        +isClosed() boolean
    }
    
    class BaseExecutor {
        <<abstract>>
        #localCache PerpetualCache
        #localOutputParameterCache PerpetualCache
        #deferredLoads List~DeferredLoad~
        #queryStack int
        #closed boolean
        +query() List~E~
        +update() int
        +createCacheKey() CacheKey
        #doQuery()* List~E~
        #doUpdate()* int
        #doFlushStatements()* List~BatchResult~
    }
    
    class SimpleExecutor {
        +doQuery() List~E~
        +doUpdate() int
        +doFlushStatements() List~BatchResult~
        -prepareStatement() Statement
        -closeStatement() void
    }
    
    class ReuseExecutor {
        -statementMap Map~String,Statement~
        +doQuery() List~E~
        +doUpdate() int
        +doFlushStatements() List~BatchResult~
        -hasStatementFor() boolean
        -getStatement() Statement
        -putStatement() void
    }
    
    class BatchExecutor {
        -statementList List~Statement~
        -batchResultList List~BatchResult~
        -currentSql String
        -currentStatement MappedStatement
        +doQuery() List~E~
        +doUpdate() int
        +doFlushStatements() List~BatchResult~
    }
    
    class CachingExecutor {
        -delegate Executor
        -transactionalCacheManager TransactionalCacheManager
        +query() List~E~
        +update() int
        +commit() void
        +rollback() void
        -flushCacheIfRequired() void
        -ensureNoOutParams() void
    }
    
    Executor <|.. BaseExecutor
    BaseExecutor <|-- SimpleExecutor
    BaseExecutor <|-- ReuseExecutor
    BaseExecutor <|-- BatchExecutor
    Executor <|.. CachingExecutor
    CachingExecutor --> Executor : delegates to
```

## ğŸ¯ æ‰§è¡Œå™¨èŒè´£åˆ†å·¥

### æ ¸å¿ƒç»„ä»¶èŒè´£

| ç»„ä»¶ | ä¸»è¦èŒè´£ | è®¾è®¡æ¨¡å¼ | å…³é”®ç‰¹æ€§ |
|------|---------|---------|---------|
| **Executoræ¥å£** | å®šä¹‰æ‰§è¡Œå™¨è§„èŒƒ | æ¥å£æ¨¡å¼ | ç»Ÿä¸€çš„æ‰§è¡Œå™¨å¥‘çº¦ |
| **BaseExecutor** | æä¾›é€šç”¨åŠŸèƒ½å’Œä¸€çº§ç¼“å­˜ | æ¨¡æ¿æ–¹æ³•æ¨¡å¼ | ç¼“å­˜ç®¡ç†ã€å»¶è¿ŸåŠ è½½ |
| **SimpleExecutor** | ç®€å•ç›´æ¥çš„SQLæ‰§è¡Œ | å…·ä½“å®ç° | æ¯æ¬¡åˆ›å»ºæ–°Statement |
| **ReuseExecutor** | Statementé‡ç”¨ä¼˜åŒ– | å…·ä½“å®ç° | Statementç¼“å­˜æ±  |
| **BatchExecutor** | æ‰¹é‡æ“ä½œä¼˜åŒ– | å…·ä½“å®ç° | JDBCæ‰¹é‡å¤„ç† |
| **CachingExecutor** | äºŒçº§ç¼“å­˜ç®¡ç† | è£…é¥°å™¨æ¨¡å¼ | é€æ˜çš„ç¼“å­˜å¢å¼º |

### æ‰§è¡Œæµç¨‹æ¦‚è§ˆ

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant SqlSession as SqlSession
    participant Executor as Executor
    participant SH as StatementHandler
    participant DB as Database
    
    Client->>SqlSession: è°ƒç”¨æŸ¥è¯¢æ–¹æ³•
    SqlSession->>Executor: query(ms, param, rowBounds, handler)
    
    alt æ£€æŸ¥ä¸€çº§ç¼“å­˜
        Executor->>Executor: æ£€æŸ¥localCache
        Note over Executor: å¦‚æœå‘½ä¸­ç¼“å­˜ç›´æ¥è¿”å›
    end
    
    Executor->>SH: åˆ›å»ºStatementHandler
    SH->>DB: å‡†å¤‡å’Œæ‰§è¡ŒSQL
    DB-->>SH: è¿”å›ResultSet
    SH-->>Executor: å¤„ç†åçš„ç»“æœ
    
    Executor->>Executor: ç»“æœæ”¾å…¥ç¼“å­˜
    Executor-->>SqlSession: è¿”å›ç»“æœ
    SqlSession-->>Client: è¿”å›æœ€ç»ˆç»“æœ
```

## ğŸ”§ æ‰§è¡Œå™¨é€‰æ‹©ç­–ç•¥

### é»˜è®¤æ‰§è¡Œå™¨åˆ›å»ºé€»è¾‘

```java
public Executor newExecutor(Transaction transaction, ExecutorType execType) {
    execType = execType == null ? defaultExecutorType : execType;
    execType = execType == null ? ExecutorType.SIMPLE : execType;
    
    Executor executor;
    if (ExecutorType.BATCH == execType) {
        executor = new BatchExecutor(this, transaction);
    } else if (ExecutorType.REUSE == execType) {
        executor = new ReuseExecutor(this, transaction);
    } else {
        executor = new SimpleExecutor(this, transaction);
    }
    
    // å¦‚æœå¯ç”¨äº†äºŒçº§ç¼“å­˜ï¼Œç”¨CachingExecutorè£…é¥°
    if (cacheEnabled) {
        executor = new CachingExecutor(executor);
    }
    
    // åº”ç”¨æ’ä»¶æ‹¦æˆªå™¨
    executor = (Executor) interceptorChain.pluginAll(executor);
    return executor;
}
```

### é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[å¼€å§‹é€‰æ‹©æ‰§è¡Œå™¨] --> B{æ˜¯å¦éœ€è¦äºŒçº§ç¼“å­˜?}
    B -->|æ˜¯| C[CachingExecutorè£…é¥°]
    B -->|å¦| D[ç›´æ¥é€‰æ‹©åŸºç¡€æ‰§è¡Œå™¨]
    
    C --> D
    D --> E{ä¸šåŠ¡åœºæ™¯ç±»å‹?}
    
    E -->|ä¸€èˆ¬ä¸šåŠ¡æŸ¥è¯¢| F[SimpleExecutor]
    E -->|é¢‘ç¹é‡å¤SQL| G[ReuseExecutor]
    E -->|å¤§é‡æ‰¹é‡æ“ä½œ| H[BatchExecutor]
    
    F --> I[âœ“ ç®€å•å¯é <br/>âœ“ èµ„æºåŠæ—¶é‡Šæ”¾<br/>âœ— æ¯æ¬¡åˆ›å»ºStatement]
    G --> J[âœ“ Statementé‡ç”¨<br/>âœ“ å‡å°‘åˆ›å»ºå¼€é”€<br/>âœ— å†…å­˜å ç”¨å¢åŠ ]
    H --> K[âœ“ æ‰¹é‡å¤„ç†é«˜æ•ˆ<br/>âœ“ å‡å°‘ç½‘ç»œå¾€è¿”<br/>âœ— ä½¿ç”¨å¤æ‚åº¦é«˜]
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§å¯¹æ¯”

### æ‰§è¡Œå™¨æ€§èƒ½çŸ©é˜µ

| ç‰¹æ€§ç»´åº¦ | SimpleExecutor | ReuseExecutor | BatchExecutor |
|---------|---------------|---------------|---------------|
| **åˆ›å»ºå¼€é”€** | æ¯æ¬¡åˆ›å»º | é‡ç”¨Statement | æ‰¹é‡åˆ›å»º |
| **å†…å­˜ä½¿ç”¨** | ä½ | ä¸­ç­‰ | é«˜ï¼ˆæ‰¹é‡æ—¶ï¼‰ |
| **ç½‘ç»œå¾€è¿”** | æ¯æ¬¡ä¸€æ¬¡ | æ¯æ¬¡ä¸€æ¬¡ | æ‰¹é‡ä¸€æ¬¡ |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨æŸ¥è¯¢ | é‡å¤SQL | æ‰¹é‡æ“ä½œ |
| **å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | å¤æ‚ |
| **äº‹åŠ¡å®‰å…¨** | é«˜ | é«˜ | éœ€æ³¨æ„å¼‚å¸¸å¤„ç† |

### ç¼“å­˜å±‚æ¬¡ç»“æ„

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[äºŒçº§ç¼“å­˜ - CachingExecutor]
    B --> C[ä¸€çº§ç¼“å­˜ - BaseExecutor]
    C --> D[æ•°æ®åº“å±‚]
    
    B1[Namespaceçº§åˆ«] --> B
    B2[åº”ç”¨ç”Ÿå‘½å‘¨æœŸ] --> B
    B3[äº‹åŠ¡æ§åˆ¶] --> B
    
    C1[SqlSessionçº§åˆ«] --> C
    C2[ä¼šè¯ç”Ÿå‘½å‘¨æœŸ] --> C
    C3[è‡ªåŠ¨ç®¡ç†] --> C
```

## ğŸ”„ ç»„ä»¶åä½œå…³ç³»

### æ ¸å¿ƒåä½œæ¨¡å¼

1. **å§”æ‰˜æ¨¡å¼**ï¼šCachingExecutorå§”æ‰˜ç»™åŸºç¡€æ‰§è¡Œå™¨
2. **æ¨¡æ¿æ–¹æ³•**ï¼šBaseExecutorå®šä¹‰æ ‡å‡†æµç¨‹
3. **ç­–ç•¥æ¨¡å¼**ï¼šæ ¹æ®ExecutorTypeé€‰æ‹©å…·ä½“å®ç°
4. **è£…é¥°å™¨æ¨¡å¼**ï¼šCachingExecutorå¢å¼ºåŸºç¡€åŠŸèƒ½

### æ•°æ®æµè½¬è¿‡ç¨‹

```mermaid
graph LR
    A[SQLè¯·æ±‚] --> B[Executor.query/update]
    B --> C{æ˜¯å¦æœ‰äºŒçº§ç¼“å­˜?}
    C -->|æ˜¯| D[CachingExecutorå¤„ç†]
    C -->|å¦| E[BaseExecutorå¤„ç†]
    D --> F{ç¼“å­˜å‘½ä¸­?}
    F -->|æ˜¯| G[è¿”å›ç¼“å­˜ç»“æœ]
    F -->|å¦| E
    E --> H{ä¸€çº§ç¼“å­˜å‘½ä¸­?}
    H -->|æ˜¯| I[è¿”å›ç¼“å­˜ç»“æœ]
    H -->|å¦| J[æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢]
    J --> K[StatementHandler]
    K --> L[æ•°æ®åº“]
    L --> M[ResultSetå¤„ç†]
    M --> N[ç»“æœè¿”å›å¹¶ç¼“å­˜]
```

## ğŸš€ æ‰©å±•ç‚¹ä¸æ’ä»¶æœºåˆ¶

### å¯æ‹¦æˆªçš„Executoræ–¹æ³•

```java
// å¸¸è§çš„æ‹¦æˆªç‚¹
@Intercepts({
    @Signature(type = Executor.class, method = "update", 
               args = {MappedStatement.class, Object.class}),
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class CustomExecutorInterceptor implements Interceptor {
    // è‡ªå®šä¹‰æ‹¦æˆªé€»è¾‘
}
```

### è‡ªå®šä¹‰æ‰§è¡Œå™¨æ‰©å±•

å¼€å‘è€…å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰©å±•Executorï¼š

1. **ç»§æ‰¿BaseExecutor**ï¼šå®ç°è‡ªå®šä¹‰çš„æ‰§è¡Œé€»è¾‘
2. **å®ç°Executoræ¥å£**ï¼šå®Œå…¨è‡ªå®šä¹‰çš„æ‰§è¡Œå™¨
3. **ä½¿ç”¨æ’ä»¶æœºåˆ¶**ï¼šåœ¨ç°æœ‰æ‰§è¡Œå™¨åŸºç¡€ä¸Šå¢å¼ºåŠŸèƒ½
4. **è£…é¥°å™¨æ¨¡å¼**ï¼šç±»ä¼¼CachingExecutorçš„åŠŸèƒ½å¢å¼º

---

**é€šè¿‡è¿™ä¸ªæ¶æ„æ€»è§ˆï¼Œä½ åº”è¯¥å¯¹Executorä½“ç³»æœ‰äº†å…¨é¢çš„è®¤è¯†ï¼** ğŸ¯