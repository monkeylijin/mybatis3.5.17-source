# ç¬¬5ç¯‡å­¦ä¹ æ£€éªŒä¸æ€»ç»“

## ğŸ“Š å­¦ä¹ æˆæœæ£€éªŒ

### âœ… åŸºç¡€æ¦‚å¿µæŒæ¡åº¦è‡ªæ£€

è¯·åœ¨å­¦ä¹ å®Œæˆåï¼Œå¯¹ä»¥ä¸‹æ¦‚å¿µè¿›è¡Œè‡ªæˆ‘è¯„ä¼°ï¼š

- [ ] **Executoræ¥å£çš„æ ¸å¿ƒæ–¹æ³•** - èƒ½å¤Ÿè¯´å‡ºä¸»è¦æ–¹æ³•çš„ä½œç”¨
- [ ] **BaseExecutorçš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼** - ç†è§£æ¨¡æ¿æ–¹æ³•çš„å®ç°æœºåˆ¶
- [ ] **ä¸€çº§ç¼“å­˜çš„å·¥ä½œåŸç†** - æŒæ¡PerpetualCacheçš„ä½¿ç”¨
- [ ] **CacheKeyçš„ç”Ÿæˆè§„åˆ™** - äº†è§£ç¼“å­˜é”®çš„æ„æˆè¦ç´ 
- [ ] **SimpleExecutorçš„æ‰§è¡Œæµç¨‹** - ç†è§£ç®€å•æ‰§è¡Œå™¨çš„å·¥ä½œæ–¹å¼
- [ ] **ReuseExecutorçš„Statementé‡ç”¨æœºåˆ¶** - æŒæ¡Statementç¼“å­˜ç­–ç•¥
- [ ] **BatchExecutorçš„æ‰¹é‡æ‰§è¡ŒåŸç†** - ç†è§£æ‰¹é‡æ“ä½œçš„å®ç°
- [ ] **CachingExecutorçš„è£…é¥°å™¨æ¨¡å¼** - æŒæ¡äºŒçº§ç¼“å­˜çš„å·¥ä½œæœºåˆ¶
- [ ] **TransactionalCacheManagerçš„ä½œç”¨** - ç†è§£äº‹åŠ¡ç¼“å­˜ç®¡ç†
- [ ] **æ‰§è¡Œå™¨é€‰æ‹©ç­–ç•¥** - èƒ½å¤Ÿæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æ‰§è¡Œå™¨

## ğŸ“ æ ¸å¿ƒçŸ¥è¯†ç‚¹æ€»ç»“

### 1. Executorä½“ç³»æ¶æ„

```
Executor (æ¥å£)
â”œâ”€â”€ BaseExecutor (æŠ½è±¡ç±»)
â”‚   â”œâ”€â”€ SimpleExecutor (ç®€å•æ‰§è¡Œå™¨)
â”‚   â”œâ”€â”€ ReuseExecutor (é‡ç”¨æ‰§è¡Œå™¨)
â”‚   â””â”€â”€ BatchExecutor (æ‰¹é‡æ‰§è¡Œå™¨)
â””â”€â”€ CachingExecutor (ç¼“å­˜è£…é¥°å™¨)
```

### 2. è®¾è®¡æ¨¡å¼åº”ç”¨

| è®¾è®¡æ¨¡å¼ | åº”ç”¨ç±» | ä½œç”¨ |
|---------|--------|------|
| **æ¨¡æ¿æ–¹æ³•æ¨¡å¼** | BaseExecutor | å®šä¹‰æ‰§è¡Œæµç¨‹ï¼Œå­ç±»å®ç°å…·ä½“é€»è¾‘ |
| **è£…é¥°å™¨æ¨¡å¼** | CachingExecutor | ä¸ºæ‰§è¡Œå™¨æ·»åŠ ç¼“å­˜åŠŸèƒ½ |
| **ç­–ç•¥æ¨¡å¼** | ExecutorTypeæšä¸¾ | è¿è¡Œæ—¶é€‰æ‹©ä¸åŒçš„æ‰§è¡Œç­–ç•¥ |

### 3. ç¼“å­˜æœºåˆ¶å¯¹æ¯”

| ç¼“å­˜ç±»å‹ | ä½œç”¨åŸŸ | ç®¡ç†è€… | ç”Ÿå‘½å‘¨æœŸ | é…ç½®æ–¹å¼ |
|---------|--------|--------|---------|---------|
| **ä¸€çº§ç¼“å­˜** | SqlSession | BaseExecutor | ä¼šè¯çº§åˆ« | é»˜è®¤å¼€å¯ |
| **äºŒçº§ç¼“å­˜** | Namespace | CachingExecutor | åº”ç”¨çº§åˆ« | éœ€è¦é…ç½® |

### 4. æ‰§è¡Œå™¨é€‰æ‹©æŒ‡å—

```mermaid
flowchart TD
    A[é€‰æ‹©æ‰§è¡Œå™¨] --> B{æ˜¯å¦éœ€è¦ç¼“å­˜?}
    B -->|æ˜¯| C[å¼€å¯CachingExecutor]
    B -->|å¦| D[é€‰æ‹©åŸºç¡€æ‰§è¡Œå™¨]
    
    C --> D
    D --> E{æ‰§è¡Œåœºæ™¯?}
    
    E -->|ä¸€èˆ¬æŸ¥è¯¢| F[SimpleExecutor]
    E -->|é‡å¤SQL| G[ReuseExecutor]
    E -->|æ‰¹é‡æ“ä½œ| H[BatchExecutor]
    
    F --> I[ç®€å•å¯é <br/>é€‚åˆå¤§å¤šæ•°åœºæ™¯]
    G --> J[Statementé‡ç”¨<br/>å‡å°‘åˆ›å»ºå¼€é”€]
    H --> K[æ‰¹é‡æ‰§è¡Œ<br/>å¤§å¹…æå‡æ€§èƒ½]
```

## ğŸ§© é‡è¦æºç ç‰‡æ®µ

### BaseExecutoræ¨¡æ¿æ–¹æ³•å®ç°

```java
// æŸ¥è¯¢æ¨¡æ¿æ–¹æ³•
@Override
public <E> List<E> query(MappedStatement ms, Object parameter, 
                        RowBounds rowBounds, ResultHandler resultHandler, 
                        CacheKey cacheKey, BoundSql boundSql) throws SQLException {
    // 1. é”™è¯¯æ£€æŸ¥
    if (closed) {
        throw new ExecutorException("Executor was closed.");
    }
    
    // 2. ç¼“å­˜æ¸…ç†æ£€æŸ¥
    if (queryStack == 0 && ms.isFlushCacheRequired()) {
        clearLocalCache();
    }
    
    List<E> list;
    try {
        queryStack++;
        // 3. å°è¯•ä»ç¼“å­˜è·å–
        list = resultHandler == null ? (List<E>) localCache.getObject(cacheKey) : null;
        if (list != null) {
            handleLocallyCachedOutputParameters(ms, cacheKey, parameter, boundSql);
        } else {
            // 4. ä»æ•°æ®åº“æŸ¥è¯¢
            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, cacheKey, boundSql);
        }
    } finally {
        queryStack--;
    }
    
    // 5. å»¶è¿ŸåŠ è½½å¤„ç†
    if (queryStack == 0) {
        for (DeferredLoad deferredLoad : deferredLoads) {
            deferredLoad.load();
        }
        deferredLoads.clear();
        if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
            clearLocalCache();
        }
    }
    return list;
}
```

### CacheKeyç”Ÿæˆé€»è¾‘

```java
@Override
public CacheKey createCacheKey(MappedStatement ms, Object parameterObject, 
                              RowBounds rowBounds, BoundSql boundSql) {
    CacheKey cacheKey = new CacheKey();
    // å½±å“ç¼“å­˜Keyçš„å› ç´ 
    cacheKey.update(ms.getId());              // SQL ID
    cacheKey.update(rowBounds.getOffset());   // åˆ†é¡µåç§»
    cacheKey.update(rowBounds.getLimit());    // åˆ†é¡µå¤§å°
    cacheKey.update(boundSql.getSql());       // SQLè¯­å¥
    
    // å‚æ•°å€¼ä¹Ÿæ˜¯ç¼“å­˜Keyçš„ä¸€éƒ¨åˆ†
    List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
    for (ParameterMapping parameterMapping : parameterMappings) {
        if (parameterMapping.getMode() != ParameterMode.OUT) {
            Object value = getParameterValue(parameterMapping, parameterObject, boundSql);
            cacheKey.update(value);
        }
    }
    
    // ç¯å¢ƒIDä¹Ÿå½±å“ç¼“å­˜Key
    if (configuration.getEnvironment() != null) {
        cacheKey.update(configuration.getEnvironment().getId());
    }
    return cacheKey;
}
```

## ğŸš€ å®è·µå¿ƒå¾—è®°å½•

### æ‰§è¡Œå™¨æ€§èƒ½æµ‹è¯•ç»“æœ

| æ‰§è¡Œå™¨ç±»å‹ | 1000æ¬¡æŸ¥è¯¢è€—æ—¶ | 1000æ¬¡æ‰¹é‡æ’å…¥è€—æ—¶ | å†…å­˜ä½¿ç”¨æƒ…å†µ |
|-----------|---------------|------------------|-------------|
| SimpleExecutor | ___ ms | ___ ms | ___ MB |
| ReuseExecutor | ___ ms | ___ ms | ___ MB |
| BatchExecutor | ___ ms | ___ ms | ___ MB |

### ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•

| åœºæ™¯ | ä¸€çº§ç¼“å­˜å‘½ä¸­ç‡ | äºŒçº§ç¼“å­˜å‘½ä¸­ç‡ | è¯´æ˜ |
|------|---------------|---------------|------|
| ç›¸åŒå‚æ•°é‡å¤æŸ¥è¯¢ | __% | __% | |
| ä¸åŒå‚æ•°æŸ¥è¯¢ | __% | __% | |
| è·¨ä¼šè¯æŸ¥è¯¢ | __% | __% | |

### é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1. **é—®é¢˜**: ________________
   **è§£å†³æ–¹æ¡ˆ**: ________________

2. **é—®é¢˜**: ________________
   **è§£å†³æ–¹æ¡ˆ**: ________________

## ğŸ’¡ å…³é”®ç†è§£ç‚¹

### 1. ä¸ºä»€ä¹ˆéœ€è¦å¤šç§æ‰§è¡Œå™¨ï¼Ÿ

- **èŒè´£å•ä¸€**: æ¯ç§æ‰§è¡Œå™¨ä¸“æ³¨äºç‰¹å®šåœºæ™¯
- **æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹ä¸åŒåœºæ™¯æä¾›æœ€ä¼˜çš„æ‰§è¡Œç­–ç•¥
- **çµæ´»é…ç½®**: å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ‰§è¡Œå™¨

### 2. BaseExecutorçš„è®¾è®¡å·§æ€

- **æ¨¡æ¿æ–¹æ³•**: ç»Ÿä¸€æ‰§è¡Œæµç¨‹ï¼Œå­ç±»å®ç°å·®å¼‚åŒ–é€»è¾‘
- **ç¼“å­˜ç®¡ç†**: å†…ç½®ä¸€çº§ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- **å»¶è¿ŸåŠ è½½**: æ”¯æŒæ‡’åŠ è½½ï¼Œé¿å…ä¸å¿…è¦çš„æŸ¥è¯¢

### 3. CachingExecutorçš„è£…é¥°å™¨ä»·å€¼

- **åŠŸèƒ½å¢å¼º**: ä¸ºä»»æ„æ‰§è¡Œå™¨æ·»åŠ äºŒçº§ç¼“å­˜èƒ½åŠ›
- **é€æ˜ä»£ç†**: å¯¹åŸæ‰§è¡Œå™¨çš„è°ƒç”¨è€…å®Œå…¨é€æ˜
- **äº‹åŠ¡å®‰å…¨**: é€šè¿‡TransactionalCacheManagerä¿è¯äº‹åŠ¡ä¸€è‡´æ€§

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ è®¡åˆ’

åŸºäºæœ¬ç¯‡å­¦ä¹ ï¼Œå»ºè®®æ¥ä¸‹æ¥é‡ç‚¹å…³æ³¨ï¼š

1. **StatementHandler**: äº†è§£SQLè¯­å¥çš„é¢„å¤„ç†å’Œæ‰§è¡Œ
2. **ParameterHandler**: å­¦ä¹ å‚æ•°è®¾ç½®å’Œç±»å‹è½¬æ¢
3. **ResultSetHandler**: æŒæ¡ç»“æœé›†æ˜ å°„å’Œå¤„ç†
4. **TypeHandler**: ç†è§£Javaç±»å‹ä¸JDBCç±»å‹çš„è½¬æ¢

## âœï¸ å­¦ä¹ åæ€

### æœ¬ç¯‡æœ€å¤§æ”¶è·æ˜¯ä»€ä¹ˆï¼Ÿ

```
è¯·åœ¨æ­¤è®°å½•ä½ æœ¬ç¯‡å­¦ä¹ çš„æœ€å¤§æ”¶è·...
```

### è¿˜æœ‰å“ªäº›åœ°æ–¹éœ€è¦åŠ å¼ºï¼Ÿ

```
è¯·åœ¨æ­¤è®°å½•éœ€è¦è¿›ä¸€æ­¥å­¦ä¹ çš„å†…å®¹...
```

### å¦‚ä½•åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­ï¼Ÿ

```
è¯·åœ¨æ­¤è®°å½•å¦‚ä½•å°†æ‰€å­¦çŸ¥è¯†åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­...
```

---

**æ­å–œå®Œæˆç¬¬5ç¯‡çš„å­¦ä¹ ï¼ç»§ç»­ä¿æŒå­¦ä¹ çƒ­æƒ…ï¼Œè¿æ¥ä¸‹ä¸€ä¸ªæŒ‘æˆ˜ï¼** ğŸ‰