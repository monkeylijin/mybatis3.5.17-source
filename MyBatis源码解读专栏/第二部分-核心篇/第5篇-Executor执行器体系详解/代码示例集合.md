# ç¬¬5ç¯‡ä»£ç ç¤ºä¾‹é›†åˆ

## ğŸ”§ å®Œæ•´å¯è¿è¡Œçš„ç¤ºä¾‹ä»£ç 

### ç¤ºä¾‹1ï¼šæ‰§è¡Œå™¨æ€§èƒ½å¯¹æ¯”æµ‹è¯•

#### æµ‹è¯•ç¯å¢ƒæ­å»º

```java
package com.example.executor.performance;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.*;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;

/**
 * Executoræ€§èƒ½å¯¹æ¯”æµ‹è¯•
 * 
 * æµ‹è¯•ç¯å¢ƒï¼š
 * - Java 8+
 * - MyBatis 3.5.17
 * - H2å†…å­˜æ•°æ®åº“
 */
@SpringBootTest
public class ExecutorPerformanceTest {
    
    private SqlSessionFactory sqlSessionFactory;
    private static final int ITERATION_COUNT = 1000;
    
    @BeforeEach
    public void setUp() throws Exception {
        String resource = "mybatis-config.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        
        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
        initTestData();
    }
    
    /**
     * åˆå§‹åŒ–æµ‹è¯•æ•°æ®
     */
    private void initTestData() {
        try (SqlSession session = sqlSessionFactory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // åˆ›å»ºæµ‹è¯•è¡¨
            session.getConnection().createStatement().execute(
                "CREATE TABLE IF NOT EXISTS user (" +
                "id BIGINT PRIMARY KEY AUTO_INCREMENT, " +
                "name VARCHAR(100), " +
                "email VARCHAR(100))"
            );
            
            // æ’å…¥æµ‹è¯•æ•°æ®
            for (int i = 1; i <= 10; i++) {
                User user = new User();
                user.setName("TestUser" + i);
                user.setEmail("test" + i + "@example.com");
                mapper.insertUser(user);
            }
            session.commit();
        } catch (Exception e) {
            throw new RuntimeException("åˆå§‹åŒ–æµ‹è¯•æ•°æ®å¤±è´¥", e);
        }
    }
    
    /**
     * æµ‹è¯•SimpleExecutoræ€§èƒ½
     */
    @Test
    public void testSimpleExecutorPerformance() {
        System.out.println("=== SimpleExecutoræ€§èƒ½æµ‹è¯• ===");
        
        long startTime = System.currentTimeMillis();
        
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.SIMPLE)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // æ‰§è¡Œ1000æ¬¡ç›¸åŒæŸ¥è¯¢
            for (int i = 0; i < ITERATION_COUNT; i++) {
                User user = mapper.findById(1L);
                assert user != null : "æŸ¥è¯¢ç»“æœä¸èƒ½ä¸ºç©º";
            }
        }
        
        long endTime = System.currentTimeMillis();
        long duration = endTime - startTime;
        
        System.out.println("SimpleExecutoræ‰§è¡Œ" + ITERATION_COUNT + "æ¬¡æŸ¥è¯¢è€—æ—¶: " + duration + "ms");
        System.out.println("å¹³å‡æ¯æ¬¡æŸ¥è¯¢è€—æ—¶: " + (duration * 1.0 / ITERATION_COUNT) + "ms");
    }
    
    /**
     * æµ‹è¯•ReuseExecutoræ€§èƒ½
     */
    @Test
    public void testReuseExecutorPerformance() {
        System.out.println("=== ReuseExecutoræ€§èƒ½æµ‹è¯• ===");
        
        long startTime = System.currentTimeMillis();
        
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.REUSE)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // æ‰§è¡Œ1000æ¬¡ç›¸åŒæŸ¥è¯¢ï¼ˆStatementä¼šè¢«é‡ç”¨ï¼‰
            for (int i = 0; i < ITERATION_COUNT; i++) {
                User user = mapper.findById(1L);
                assert user != null : "æŸ¥è¯¢ç»“æœä¸èƒ½ä¸ºç©º";
            }
        }
        
        long endTime = System.currentTimeMillis();
        long duration = endTime - startTime;
        
        System.out.println("ReuseExecutoræ‰§è¡Œ" + ITERATION_COUNT + "æ¬¡æŸ¥è¯¢è€—æ—¶: " + duration + "ms");
        System.out.println("å¹³å‡æ¯æ¬¡æŸ¥è¯¢è€—æ—¶: " + (duration * 1.0 / ITERATION_COUNT) + "ms");
    }
    
    /**
     * æµ‹è¯•BatchExecutoræ€§èƒ½
     */
    @Test
    public void testBatchExecutorPerformance() {
        System.out.println("=== BatchExecutoræ€§èƒ½æµ‹è¯• ===");
        
        // å…ˆæ¸…ç†æµ‹è¯•æ•°æ®
        cleanTestData();
        
        long startTime = System.currentTimeMillis();
        
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // æ‰¹é‡æ’å…¥1000æ¡æ•°æ®
            for (int i = 1; i <= ITERATION_COUNT; i++) {
                User user = new User();
                user.setName("BatchUser" + i);
                user.setEmail("batch" + i + "@example.com");
                mapper.insertUser(user);
            }
            
            // æ‰§è¡Œæ‰¹é‡æ“ä½œ
            List<BatchResult> results = session.flushStatements();
            session.commit();
            
            // åˆ†ææ‰¹é‡ç»“æœ
            System.out.println("æ‰¹é‡ç»“æœæ•°é‡: " + results.size());
            for (BatchResult result : results) {
                System.out.println("SQL: " + result.getSql());
                System.out.println("å‚æ•°æ•°é‡: " + result.getParameterObjects().size());
            }
        }
        
        long endTime = System.currentTimeMillis();
        long duration = endTime - startTime;
        
        System.out.println("BatchExecutoræ‰¹é‡æ’å…¥" + ITERATION_COUNT + "æ¡æ•°æ®è€—æ—¶: " + duration + "ms");
        System.out.println("å¹³å‡æ¯æ¡æ•°æ®è€—æ—¶: " + (duration * 1.0 / ITERATION_COUNT) + "ms");
    }
    
    /**
     * å¯¹æ¯”å•æ¡æ’å…¥ä¸æ‰¹é‡æ’å…¥æ€§èƒ½
     */
    @Test
    public void compareSingleVsBatchInsert() {
        System.out.println("=== å•æ¡æ’å…¥ vs æ‰¹é‡æ’å…¥æ€§èƒ½å¯¹æ¯” ===");
        
        final int dataCount = 500; // å‡å°‘æ•°æ®é‡ï¼Œé¿å…æµ‹è¯•æ—¶é—´è¿‡é•¿
        
        // æµ‹è¯•å•æ¡æ’å…¥
        cleanTestData();
        long singleStartTime = System.currentTimeMillis();
        
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.SIMPLE)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            for (int i = 1; i <= dataCount; i++) {
                User user = new User();
                user.setName("SingleUser" + i);
                user.setEmail("single" + i + "@example.com");
                mapper.insertUser(user);
                session.commit(); // æ¯æ¡éƒ½æäº¤
            }
        }
        
        long singleEndTime = System.currentTimeMillis();
        long singleDuration = singleEndTime - singleStartTime;
        
        // æµ‹è¯•æ‰¹é‡æ’å…¥
        cleanTestData();
        long batchStartTime = System.currentTimeMillis();
        
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            for (int i = 1; i <= dataCount; i++) {
                User user = new User();
                user.setName("BatchUser" + i);
                user.setEmail("batch" + i + "@example.com");
                mapper.insertUser(user);
            }
            
            session.flushStatements();
            session.commit(); // æ‰¹é‡æäº¤
        }
        
        long batchEndTime = System.currentTimeMillis();
        long batchDuration = batchEndTime - batchStartTime;
        
        // æ€§èƒ½å¯¹æ¯”åˆ†æ
        System.out.println("å•æ¡æ’å…¥" + dataCount + "æ¡æ•°æ®è€—æ—¶: " + singleDuration + "ms");
        System.out.println("æ‰¹é‡æ’å…¥" + dataCount + "æ¡æ•°æ®è€—æ—¶: " + batchDuration + "ms");
        System.out.println("æ€§èƒ½æå‡: " + ((singleDuration - batchDuration) * 100.0 / singleDuration) + "%");
        System.out.println("é€Ÿåº¦æ¯”ä¾‹: " + (singleDuration * 1.0 / batchDuration) + ":1");
    }
    
    /**
     * æ¸…ç†æµ‹è¯•æ•°æ®
     */
    private void cleanTestData() {
        try (SqlSession session = sqlSessionFactory.openSession()) {
            session.getConnection().createStatement().execute("DELETE FROM user");
            session.commit();
        } catch (Exception e) {
            System.err.println("æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: " + e.getMessage());
        }
    }
}
```

#### å®ä½“ç±»å’ŒMapperæ¥å£

```java
package com.example.executor.model;

/**
 * ç”¨æˆ·å®ä½“ç±»
 */
public class User {
    private Long id;
    private String name;
    private String email;
    
    // æ„é€ å‡½æ•°
    public User() {}
    
    public User(Long id, String name, String email) {
        this.id = id;
        this.name = name;
        this.email = email;
    }
    
    // Getterå’ŒSetteræ–¹æ³•
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    
    @Override
    public String toString() {
        return "User{id=" + id + ", name='" + name + "', email='" + email + "'}";
    }
}
```

```java
package com.example.executor.mapper;

import com.example.executor.model.User;
import org.apache.ibatis.annotations.*;

import java.util.List;

/**
 * ç”¨æˆ·æ•°æ®è®¿é—®æ¥å£
 */
public interface UserMapper {
    
    @Select("SELECT * FROM user WHERE id = #{id}")
    User findById(@Param("id") Long id);
    
    @Select("SELECT * FROM user")
    List<User> findAll();
    
    @Insert("INSERT INTO user(name, email) VALUES(#{name}, #{email})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insertUser(User user);
    
    @Update("UPDATE user SET name = #{name}, email = #{email} WHERE id = #{id}")
    int updateUser(User user);
    
    @Delete("DELETE FROM user WHERE id = #{id}")
    int deleteUser(@Param("id") Long id);
}
```

### ç¤ºä¾‹2ï¼šç¼“å­˜æœºåˆ¶åˆ†æ

```java
package com.example.executor.cache;

import com.example.executor.mapper.UserMapper;
import com.example.executor.model.User;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

/**
 * ç¼“å­˜æœºåˆ¶åˆ†ææµ‹è¯•
 */
@SpringBootTest
public class CacheAnalysisTest {
    
    @Autowired
    private SqlSessionFactory sqlSessionFactory;
    
    /**
     * æµ‹è¯•ä¸€çº§ç¼“å­˜ï¼ˆåŒä¸€SqlSessionå†…çš„ç¼“å­˜ï¼‰
     */
    @Test
    public void testFirstLevelCache() {
        System.out.println("=== ä¸€çº§ç¼“å­˜æµ‹è¯• ===");
        
        try (SqlSession session = sqlSessionFactory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            System.out.println("ç¬¬ä¸€æ¬¡æŸ¥è¯¢...");
            User user1 = mapper.findById(1L);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user1);
            
            System.out.println("ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆç›¸åŒå‚æ•°ï¼‰...");
            User user2 = mapper.findById(1L);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user2);
            
            // éªŒè¯æ˜¯å¦ä»ç¼“å­˜è·å–ï¼ˆå¼•ç”¨ç›¸ç­‰ï¼‰
            System.out.println("æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰: " + (user1 == user2));
            System.out.println("å¯¹è±¡å†…å®¹æ˜¯å¦ç›¸ç­‰: " + user1.equals(user2));
        }
    }
    
    /**
     * æµ‹è¯•ä¸åŒå‚æ•°çš„ç¼“å­˜è¡Œä¸º
     */
    @Test
    public void testDifferentParameterCache() {
        System.out.println("=== ä¸åŒå‚æ•°ç¼“å­˜æµ‹è¯• ===");
        
        try (SqlSession session = sqlSessionFactory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            System.out.println("æŸ¥è¯¢ç”¨æˆ·1...");
            User user1 = mapper.findById(1L);
            
            System.out.println("æŸ¥è¯¢ç”¨æˆ·2...");
            User user2 = mapper.findById(2L);
            
            System.out.println("å†æ¬¡æŸ¥è¯¢ç”¨æˆ·1...");
            User user1Again = mapper.findById(1L);
            
            // éªŒè¯ç¼“å­˜è¡Œä¸º
            System.out.println("ç”¨æˆ·1ä¸¤æ¬¡æŸ¥è¯¢æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: " + (user1 == user1Again));
            System.out.println("ç”¨æˆ·1å’Œç”¨æˆ·2æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: " + (user1 == user2));
        }
    }
    
    /**
     * æµ‹è¯•UPDATEæ“ä½œå¯¹ç¼“å­˜çš„å½±å“
     */
    @Test
    public void testUpdateClearCache() {
        System.out.println("=== UPDATEæ“ä½œç¼“å­˜æ¸…ç†æµ‹è¯• ===");
        
        try (SqlSession session = sqlSessionFactory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼Œå»ºç«‹ç¼“å­˜
            System.out.println("ç¬¬ä¸€æ¬¡æŸ¥è¯¢å»ºç«‹ç¼“å­˜...");
            User user1 = mapper.findById(1L);
            System.out.println("ç”¨æˆ·ä¿¡æ¯: " + user1);
            
            // æ‰§è¡Œæ›´æ–°æ“ä½œï¼ˆä¼šæ¸…ç†ç¼“å­˜ï¼‰
            System.out.println("æ‰§è¡Œæ›´æ–°æ“ä½œ...");
            User updateUser = new User(1L, "UpdatedName", "updated@example.com");
            mapper.updateUser(updateUser);
            
            // å†æ¬¡æŸ¥è¯¢ï¼ˆåº”è¯¥ä»æ•°æ®åº“é‡æ–°è·å–ï¼‰
            System.out.println("æ›´æ–°åå†æ¬¡æŸ¥è¯¢...");
            User user2 = mapper.findById(1L);
            System.out.println("ç”¨æˆ·ä¿¡æ¯: " + user2);
            
            // éªŒè¯ç¼“å­˜æ˜¯å¦è¢«æ¸…ç†
            System.out.println("ä¸¤æ¬¡æŸ¥è¯¢æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: " + (user1 == user2));
            System.out.println("ç”¨æˆ·åæ˜¯å¦å·²æ›´æ–°: " + user2.getName());
            
            session.rollback(); // å›æ»šæ›´æ–°ï¼Œä¿æŒæµ‹è¯•æ•°æ®ä¸€è‡´æ€§
        }
    }
    
    /**
     * æµ‹è¯•è·¨SqlSessionçš„ç¼“å­˜éš”ç¦»
     */
    @Test
    public void testCrossSessionCacheIsolation() {
        System.out.println("=== è·¨SqlSessionç¼“å­˜éš”ç¦»æµ‹è¯• ===");
        
        User user1, user2;
        
        // ç¬¬ä¸€ä¸ªSqlSession
        try (SqlSession session1 = sqlSessionFactory.openSession()) {
            UserMapper mapper1 = session1.getMapper(UserMapper.class);
            System.out.println("Session1 - ç¬¬ä¸€æ¬¡æŸ¥è¯¢...");
            user1 = mapper1.findById(1L);
        }
        
        // ç¬¬äºŒä¸ªSqlSession
        try (SqlSession session2 = sqlSessionFactory.openSession()) {
            UserMapper mapper2 = session2.getMapper(UserMapper.class);
            System.out.println("Session2 - æŸ¥è¯¢ç›¸åŒç”¨æˆ·...");
            user2 = mapper2.findById(1L);
        }
        
        // éªŒè¯ä¸åŒSessionçš„ç¼“å­˜éš”ç¦»
        System.out.println("ä¸åŒSessionæŸ¥è¯¢ç»“æœæ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡: " + (user1 == user2));
        System.out.println("ç”¨æˆ·å†…å®¹æ˜¯å¦ç›¸åŒ: " + user1.toString().equals(user2.toString()));
    }
}
```

### ç¤ºä¾‹3ï¼šè‡ªå®šä¹‰æ€§èƒ½ç›‘æ§æ‰§è¡Œå™¨

```java
package com.example.executor.monitor;

import org.apache.ibatis.executor.Executor;
import org.apache.ibatis.mapping.MappedStatement;
import org.apache.ibatis.plugin.*;
import org.apache.ibatis.session.ResultHandler;
import org.apache.ibatis.session.RowBounds;

import java.util.Properties;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;

/**
 * SQLæ‰§è¡Œæ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨
 * 
 * åŠŸèƒ½ï¼š
 * 1. è®°å½•SQLæ‰§è¡Œæ—¶é—´
 * 2. ç»Ÿè®¡SQLæ‰§è¡Œæ¬¡æ•°
 * 3. æ…¢æŸ¥è¯¢æ£€æµ‹å’ŒæŠ¥è­¦
 * 4. æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š
 */
@Intercepts({
    @Signature(type = Executor.class, method = "update", 
               args = {MappedStatement.class, Object.class}),
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class PerformanceMonitorInterceptor implements Interceptor {
    
    // æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    private long slowQueryThreshold = 1000;
    
    // æ€§èƒ½ç»Ÿè®¡æ•°æ®
    private final ConcurrentHashMap<String, SqlStatistics> statisticsMap = new ConcurrentHashMap<>();
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        // è·å–SQLä¿¡æ¯
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        String sqlId = ms.getId();
        String methodName = invocation.getMethod().getName();
        
        Object result = null;
        Throwable exception = null;
        
        try {
            // æ‰§è¡ŒåŸæ–¹æ³•
            result = invocation.proceed();
            return result;
        } catch (Throwable e) {
            exception = e;
            throw e;
        } finally {
            long endTime = System.currentTimeMillis();
            long executionTime = endTime - startTime;
            
            // è®°å½•æ‰§è¡Œç»Ÿè®¡
            recordStatistics(sqlId, executionTime, exception == null);
            
            // æ‰§è¡Œæ—¶é—´æ—¥å¿—
            logExecutionTime(sqlId, methodName, executionTime);
            
            // æ…¢æŸ¥è¯¢æ£€æµ‹
            if (executionTime > slowQueryThreshold) {
                logSlowQuery(sqlId, methodName, executionTime);
            }
        }
    }
    
    /**
     * è®°å½•SQLæ‰§è¡Œç»Ÿè®¡
     */
    private void recordStatistics(String sqlId, long executionTime, boolean success) {
        statisticsMap.computeIfAbsent(sqlId, k -> new SqlStatistics())
                    .addExecution(executionTime, success);
    }
    
    /**
     * è®°å½•æ‰§è¡Œæ—¶é—´
     */
    private void logExecutionTime(String sqlId, String methodName, long executionTime) {
        System.out.printf("[SQL-MONITOR] %s.%s executed in %d ms%n", 
                         sqlId, methodName, executionTime);
    }
    
    /**
     * æ…¢æŸ¥è¯¢æŠ¥è­¦
     */
    private void logSlowQuery(String sqlId, String methodName, long executionTime) {
        System.err.printf("[SLOW-QUERY] ALERT: %s.%s executed in %d ms (threshold: %d ms)%n", 
                         sqlId, methodName, executionTime, slowQueryThreshold);
    }
    
    /**
     * è·å–æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š
     */
    public void printStatisticsReport() {
        System.out.println("\n=== SQLæ‰§è¡Œæ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š ===");
        
        statisticsMap.forEach((sqlId, stats) -> {
            System.out.printf("SQL ID: %s%n", sqlId);
            System.out.printf("  æ‰§è¡Œæ¬¡æ•°: %d (æˆåŠŸ: %d, å¤±è´¥: %d)%n", 
                             stats.getTotalCount(), stats.getSuccessCount(), stats.getFailureCount());
            System.out.printf("  æ€»æ‰§è¡Œæ—¶é—´: %d ms%n", stats.getTotalTime());
            System.out.printf("  å¹³å‡æ‰§è¡Œæ—¶é—´: %.2f ms%n", stats.getAverageTime());
            System.out.printf("  æœ€å¤§æ‰§è¡Œæ—¶é—´: %d ms%n", stats.getMaxTime());
            System.out.printf("  æœ€å°æ‰§è¡Œæ—¶é—´: %d ms%n", stats.getMinTime());
            System.out.println();
        });
    }
    
    /**
     * æ¸…é™¤ç»Ÿè®¡æ•°æ®
     */
    public void clearStatistics() {
        statisticsMap.clear();
    }
    
    @Override
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    @Override
    public void setProperties(Properties properties) {
        String threshold = properties.getProperty("slowQueryThreshold");
        if (threshold != null) {
            this.slowQueryThreshold = Long.parseLong(threshold);
        }
    }
    
    /**
     * SQLæ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
     */
    private static class SqlStatistics {
        private final AtomicLong totalCount = new AtomicLong(0);
        private final AtomicLong successCount = new AtomicLong(0);
        private final AtomicLong failureCount = new AtomicLong(0);
        private final AtomicLong totalTime = new AtomicLong(0);
        private final AtomicLong maxTime = new AtomicLong(0);
        private final AtomicLong minTime = new AtomicLong(Long.MAX_VALUE);
        
        public void addExecution(long executionTime, boolean success) {
            totalCount.incrementAndGet();
            totalTime.addAndGet(executionTime);
            
            if (success) {
                successCount.incrementAndGet();
            } else {
                failureCount.incrementAndGet();
            }
            
            // æ›´æ–°æœ€å¤§å€¼
            maxTime.updateAndGet(current -> Math.max(current, executionTime));
            
            // æ›´æ–°æœ€å°å€¼
            minTime.updateAndGet(current -> Math.min(current, executionTime));
        }
        
        public long getTotalCount() { return totalCount.get(); }
        public long getSuccessCount() { return successCount.get(); }
        public long getFailureCount() { return failureCount.get(); }
        public long getTotalTime() { return totalTime.get(); }
        public long getMaxTime() { return maxTime.get(); }
        public long getMinTime() { 
            long min = minTime.get();
            return min == Long.MAX_VALUE ? 0 : min;
        }
        
        public double getAverageTime() {
            long count = totalCount.get();
            return count == 0 ? 0 : (double) totalTime.get() / count;
        }
    }
}
```

### ç¤ºä¾‹4ï¼šé…ç½®æ–‡ä»¶

#### mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- æ’ä»¶é…ç½® -->
    <plugins>
        <plugin interceptor="com.example.executor.monitor.PerformanceMonitorInterceptor">
            <property name="slowQueryThreshold" value="500"/>
        </plugin>
    </plugins>
    
    <!-- è®¾ç½® -->
    <settings>
        <!-- å¯ç”¨äºŒçº§ç¼“å­˜ -->
        <setting name="cacheEnabled" value="true"/>
        <!-- é»˜è®¤æ‰§è¡Œå™¨ç±»å‹ -->
        <setting name="defaultExecutorType" value="SIMPLE"/>
        <!-- ä¸€çº§ç¼“å­˜èŒƒå›´ -->
        <setting name="localCacheScope" value="SESSION"/>
        <!-- æ—¥å¿—å®ç° -->
        <setting name="logImpl" value="STDOUT_LOGGING"/>
    </settings>
    
    <!-- ç¯å¢ƒé…ç½® -->
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="org.h2.Driver"/>
                <property name="url" value="jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1"/>
                <property name="username" value="sa"/>
                <property name="password" value=""/>
            </dataSource>
        </environment>
    </environments>
    
    <!-- Mapperæ³¨å†Œ -->
    <mappers>
        <mapper class="com.example.executor.mapper.UserMapper"/>
    </mappers>
</configuration>
```

#### æµ‹è¯•è¿è¡Œç¤ºä¾‹

```java
package com.example.executor;

import com.example.executor.monitor.PerformanceMonitorInterceptor;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.InputStream;

/**
 * æ‰§è¡Œå™¨ç¤ºä¾‹è¿è¡Œç±»
 */
public class ExecutorExampleRunner {
    
    public static void main(String[] args) throws Exception {
        // 1. åˆ›å»ºSqlSessionFactory
        String resource = "mybatis-config.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);
        
        // 2. è¿è¡Œæ€§èƒ½æµ‹è¯•
        runPerformanceTests(factory);
        
        // 3. è¿è¡Œç¼“å­˜æµ‹è¯•
        runCacheTests(factory);
        
        // 4. æ‰“å°æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š
        printPerformanceReport(factory);
    }
    
    private static void runPerformanceTests(SqlSessionFactory factory) {
        System.out.println("å¼€å§‹æ‰§è¡Œæ€§èƒ½æµ‹è¯•...");
        // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¹‹å‰ç¼–å†™çš„æ€§èƒ½æµ‹è¯•æ–¹æ³•
    }
    
    private static void runCacheTests(SqlSessionFactory factory) {
        System.out.println("å¼€å§‹æ‰§è¡Œç¼“å­˜æµ‹è¯•...");
        // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¹‹å‰ç¼–å†™çš„ç¼“å­˜æµ‹è¯•æ–¹æ³•
    }
    
    private static void printPerformanceReport(SqlSessionFactory factory) {
        // è·å–æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨å¹¶æ‰“å°æŠ¥å‘Š
        // æ³¨æ„ï¼šè¿™éœ€è¦é€šè¿‡Configurationè·å–æ’ä»¶å®ä¾‹
        System.out.println("æ€§èƒ½æµ‹è¯•å®Œæˆï¼ŒæŸ¥çœ‹ä¸Šè¿°æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚");
    }
}
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â””â”€â”€ com/example/executor/
â”‚   â”‚       â”œâ”€â”€ model/
â”‚   â”‚       â”‚   â””â”€â”€ User.java
â”‚   â”‚       â”œâ”€â”€ mapper/
â”‚   â”‚       â”‚   â””â”€â”€ UserMapper.java
â”‚   â”‚       â”œâ”€â”€ monitor/
â”‚   â”‚       â”‚   â””â”€â”€ PerformanceMonitorInterceptor.java
â”‚   â”‚       â””â”€â”€ ExecutorExampleRunner.java
â”‚   â””â”€â”€ resources/
â”‚       â”œâ”€â”€ mybatis-config.xml
â”‚       â””â”€â”€ logback.xml
â””â”€â”€ test/
    â””â”€â”€ java/
        â””â”€â”€ com/example/executor/
            â”œâ”€â”€ performance/
            â”‚   â””â”€â”€ ExecutorPerformanceTest.java
            â””â”€â”€ cache/
                â””â”€â”€ CacheAnalysisTest.java
```

## ğŸš€ è¿è¡Œè¯´æ˜

1. **ç¯å¢ƒè¦æ±‚**ï¼š
   - JDK 8+
   - Maven 3.6+
   - MyBatis 3.5.17

2. **ä¾èµ–é…ç½®**ï¼š
```xml
<dependencies>
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.5.17</version>
    </dependency>
    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <version>2.1.214</version>
    </dependency>
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <version>5.8.2</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```

3. **è¿è¡Œæ­¥éª¤**ï¼š
   - ç¼–è¯‘é¡¹ç›®ï¼š`mvn compile`
   - è¿è¡Œæµ‹è¯•ï¼š`mvn test`
   - è¿è¡Œç¤ºä¾‹ï¼š`java com.example.executor.ExecutorExampleRunner`

---

**è¿™äº›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å°†å¸®åŠ©ä½ æ·±å…¥ç†è§£Executorçš„å·¥ä½œåŸç†ï¼** ğŸ”§