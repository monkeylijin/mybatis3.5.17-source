# ParameterHandlerå‚æ•°å¤„ç†æœºåˆ¶ä»£ç ç¤ºä¾‹é›†åˆ

## ğŸ“š ä»£ç ç¤ºä¾‹è¯´æ˜

æœ¬æ–‡æ¡£åŒ…å«ç¬¬7ç¯‡ã€ŠParameterHandlerå‚æ•°å¤„ç†æœºåˆ¶ã€‹çš„æ‰€æœ‰å®è·µä»£ç ç¤ºä¾‹ï¼Œæ¶µç›–äº†ä»åŸºç¡€ä½¿ç”¨åˆ°é«˜çº§æ‰©å±•çš„å®Œæ•´æ¡ˆä¾‹ã€‚

## ğŸ”§ åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

### 1. ä¸åŒå‚æ•°ç±»å‹å¤„ç†ç¤ºä¾‹

#### 1.1 åŸºæœ¬ç±»å‹å‚æ•°å¤„ç†
```java
package com.example.parameter.basic;

import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.junit.Test;

/**
 * åŸºæœ¬ç±»å‹å‚æ•°å¤„ç†ç¤ºä¾‹
 * æ¼”ç¤ºMyBatiså¦‚ä½•å¤„ç†ä¸åŒç±»å‹çš„åŸºæœ¬å‚æ•°
 */
public class BasicParameterExample {
    
    /**
     * å•ä¸ªåŸºæœ¬ç±»å‹å‚æ•°
     * SQL: SELECT * FROM user WHERE id = ?
     */
    @Test
    public void testSingleBasicParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // å‚æ•°ç›´æ¥ä¼ é€’ï¼ŒMyBatisä¼šè¯†åˆ«ä¸ºåŸºæœ¬ç±»å‹
            System.out.println("=== å•ä¸ªåŸºæœ¬ç±»å‹å‚æ•°æµ‹è¯• ===");
            User user = mapper.findById(123L);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
            
            // éªŒè¯ï¼šparameterObjectå°±æ˜¯ä¼ å…¥çš„Longå€¼
            // DefaultParameterHandlerä¼šæ£€æµ‹åˆ°Longç±»å‹æœ‰å¯¹åº”çš„TypeHandler
            // å› æ­¤ç›´æ¥ä½¿ç”¨parameterObjectä½œä¸ºå‚æ•°å€¼
        }
    }
    
    /**
     * å¤šä¸ªåŸºæœ¬ç±»å‹å‚æ•°
     * SQL: SELECT * FROM user WHERE id = ? AND status = ?
     * MyBatisä¼šè‡ªåŠ¨åŒ…è£…ä¸ºParamMap
     */
    @Test
    public void testMultipleBasicParameters() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            System.out.println("=== å¤šä¸ªåŸºæœ¬ç±»å‹å‚æ•°æµ‹è¯• ===");
            List<User> users = mapper.findByIdAndStatus(123L, "ACTIVE");
            System.out.println("æŸ¥è¯¢ç»“æœæ•°é‡: " + users.size());
            
            // å†…éƒ¨å¤„ç†ï¼šMyBatisä¼šå°†å‚æ•°åŒ…è£…ä¸ºMap
            // {arg0=123L, arg1="ACTIVE", param1=123L, param2="ACTIVE"}
            // DefaultParameterHandleré€šè¿‡å±æ€§åarg0, arg1è·å–å‚æ•°å€¼
        }
    }
    
    /**
     * ä½¿ç”¨@Paramæ³¨è§£çš„å‚æ•°
     * æä¾›æ˜ç¡®çš„å‚æ•°åç§°
     */
    @Test
    public void testNamedParameters() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            System.out.println("=== å‘½åå‚æ•°æµ‹è¯• ===");
            List<User> users = mapper.findByNameAndAge("å¼ ä¸‰", 25);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + users);
            
            // @Paramæ³¨è§£æä¾›æ˜ç¡®çš„å‚æ•°å
            // å‚æ•°æ˜ å°„: #{name} -> "å¼ ä¸‰", #{age} -> 25
        }
    }
}

/**
 * UserMapperæ¥å£å®šä¹‰
 */
interface UserMapper {
    
    // å•ä¸ªå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨
    User findById(Long id);
    
    // å¤šä¸ªå‚æ•°ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºParamMap
    List<User> findByIdAndStatus(Long id, String status);
    
    // ä½¿ç”¨@Paramæ³¨è§£æ˜ç¡®å‚æ•°å
    List<User> findByNameAndAge(@Param("name") String name, @Param("age") Integer age);
}
```

#### 1.2 å¤æ‚å¯¹è±¡å‚æ•°å¤„ç†
```java
package com.example.parameter.complex;

import org.apache.ibatis.reflection.MetaObject;
import org.apache.ibatis.session.Configuration;
import org.junit.Test;

/**
 * å¤æ‚å¯¹è±¡å‚æ•°å¤„ç†ç¤ºä¾‹
 * æ¼”ç¤ºPOJOå¯¹è±¡ã€åµŒå¥—å¯¹è±¡å’ŒMapå‚æ•°çš„å¤„ç†
 */
public class ComplexParameterExample {
    
    /**
     * POJOå¯¹è±¡å‚æ•°å¤„ç†
     * SQL: INSERT INTO user (name, email, age) VALUES (?, ?, ?)
     */
    @Test
    public void testPojoParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // åˆ›å»ºPOJOå‚æ•°å¯¹è±¡
            User user = new User();
            user.setName("å¼ ä¸‰");
            user.setEmail("zhangsan@example.com");
            user.setAge(25);
            
            System.out.println("=== POJOå¯¹è±¡å‚æ•°æµ‹è¯• ===");
            System.out.println("æ’å…¥ç”¨æˆ·: " + user);
            
            int result = mapper.insertUser(user);
            System.out.println("æ’å…¥ç»“æœ: " + result);
            
            session.commit();
            
            // å†…éƒ¨å¤„ç†è¿‡ç¨‹æ¼”ç¤º
            demonstrateMetaObjectUsage(user);
        }
    }
    
    /**
     * åµŒå¥—å¯¹è±¡å‚æ•°å¤„ç†
     * SQL: SELECT * FROM order WHERE user_id = ? AND user_name = ?
     */
    @Test
    public void testNestedObjectParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            OrderMapper mapper = session.getMapper(OrderMapper.class);
            
            // åˆ›å»ºåµŒå¥—å¯¹è±¡
            User user = new User();
            user.setId(123L);
            user.setName("å¼ ä¸‰");
            
            Order order = new Order();
            order.setUser(user);
            
            System.out.println("=== åµŒå¥—å¯¹è±¡å‚æ•°æµ‹è¯• ===");
            List<Order> orders = mapper.findOrdersByUser(order);
            System.out.println("æŸ¥è¯¢åˆ°è®¢å•æ•°é‡: " + orders.size());
            
            // å‚æ•°æ˜ å°„: #{user.id} -> 123L, #{user.name} -> "å¼ ä¸‰"
            // DefaultParameterHandleré€šè¿‡MetaObject.getValue("user.id")è·å–å€¼
        }
    }
    
    /**
     * Mapå‚æ•°å¤„ç†
     * çµæ´»çš„å‚æ•°ä¼ é€’æ–¹å¼
     */
    @Test
    public void testMapParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // ä½¿ç”¨Mapä¼ é€’å‚æ•°
            Map<String, Object> params = new HashMap<>();
            params.put("name", "å¼ ä¸‰");
            params.put("minAge", 18);
            params.put("maxAge", 65);
            params.put("status", "ACTIVE");
            
            System.out.println("=== Mapå‚æ•°æµ‹è¯• ===");
            List<User> users = mapper.findByConditions(params);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + users.size() + " ä¸ªç”¨æˆ·");
            
            // Mapå‚æ•°å¤„ç†ï¼šç›´æ¥é€šè¿‡keyè·å–value
            // #{name} -> params.get("name")
        }
    }
    
    /**
     * æ¼”ç¤ºMetaObjectçš„ä½¿ç”¨
     */
    private void demonstrateMetaObjectUsage(User user) {
        System.out.println("--- MetaObjectä½¿ç”¨æ¼”ç¤º ---");
        
        Configuration configuration = new Configuration();
        MetaObject metaObject = configuration.newMetaObject(user);
        
        // è·å–ç®€å•å±æ€§
        Object name = metaObject.getValue("name");
        Object email = metaObject.getValue("email");
        Object age = metaObject.getValue("age");
        
        System.out.println("é€šè¿‡MetaObjectè·å–å±æ€§:");
        System.out.println("name: " + name);
        System.out.println("email: " + email);
        System.out.println("age: " + age);
        
        // æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨
        boolean hasName = metaObject.hasGetter("name");
        boolean hasAddress = metaObject.hasGetter("address");
        
        System.out.println("hasGetter('name'): " + hasName);
        System.out.println("hasGetter('address'): " + hasAddress);
    }
}

/**
 * ç›¸å…³Mapperæ¥å£
 */
interface UserMapper {
    int insertUser(User user);
    List<User> findByConditions(Map<String, Object> params);
}

interface OrderMapper {
    List<Order> findOrdersByUser(Order order);
}

/**
 * å®ä½“ç±»å®šä¹‰
 */
class User {
    private Long id;
    private String name;
    private String email;
    private Integer age;
    private String status;
    
    // getterå’Œsetteræ–¹æ³•...
}

class Order {
    private Long id;
    private User user;
    private Date createTime;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

### 2. é›†åˆç±»å‹å‚æ•°å¤„ç†ç¤ºä¾‹

```java
package com.example.parameter.collection;

import org.apache.ibatis.mapping.BoundSql;
import org.apache.ibatis.mapping.ParameterMapping;
import org.junit.Test;

/**
 * é›†åˆç±»å‹å‚æ•°å¤„ç†ç¤ºä¾‹
 * æ¼”ç¤ºListã€Arrayã€Setç­‰é›†åˆå‚æ•°çš„å¤„ç†æœºåˆ¶
 */
public class CollectionParameterExample {
    
    /**
     * Listå‚æ•°å¤„ç†
     * ä½¿ç”¨foreachæ ‡ç­¾å¤„ç†Listé›†åˆ
     */
    @Test
    public void testListParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // å‡†å¤‡Listå‚æ•°
            List<Long> userIds = Arrays.asList(1L, 2L, 3L, 4L, 5L);
            
            System.out.println("=== Listå‚æ•°æµ‹è¯• ===");
            System.out.println("æŸ¥è¯¢ç”¨æˆ·IDåˆ—è¡¨: " + userIds);
            
            List<User> users = mapper.findByIds(userIds);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + users.size() + " ä¸ªç”¨æˆ·");
            
            // æ¼”ç¤ºforeachå¤„ç†è¿‡ç¨‹
            demonstrateForeachProcessing(userIds);
        }
    }
    
    /**
     * Arrayå‚æ•°å¤„ç†
     */
    @Test
    public void testArrayParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // å‡†å¤‡Arrayå‚æ•°
            String[] statuses = {"ACTIVE", "PENDING", "SUSPENDED"};
            
            System.out.println("=== Arrayå‚æ•°æµ‹è¯• ===");
            System.out.println("çŠ¶æ€æ•°ç»„: " + Arrays.toString(statuses));
            
            List<User> users = mapper.findByStatuses(statuses);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + users.size() + " ä¸ªç”¨æˆ·");
        }
    }
    
    /**
     * å¤æ‚å¯¹è±¡Listå‚æ•°å¤„ç†
     */
    @Test
    public void testObjectListParameter() {
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // å‡†å¤‡å¤æ‚å¯¹è±¡List
            List<User> users = Arrays.asList(
                new User("å¼ ä¸‰", "zhangsan@example.com"),
                new User("æå››", "lisi@example.com"),
                new User("ç‹äº”", "wangwu@example.com")
            );
            
            System.out.println("=== å¤æ‚å¯¹è±¡Listå‚æ•°æµ‹è¯• ===");
            int result = mapper.batchInsertUsers(users);
            System.out.println("æ‰¹é‡æ’å…¥ç»“æœ: " + result);
            
            session.commit();
        }
    }
    
    /**
     * æ¼”ç¤ºforeachå¤„ç†è¿‡ç¨‹ä¸­é¢å¤–å‚æ•°çš„ç”Ÿæˆ
     */
    private void demonstrateForeachProcessing(List<Long> userIds) {
        System.out.println("--- Foreachå¤„ç†è¿‡ç¨‹æ¼”ç¤º ---");
        
        // æ¨¡æ‹Ÿforeachæ ‡ç­¾çš„å¤„ç†è¿‡ç¨‹
        // åŸå§‹SQLæ¨¡æ¿: SELECT * FROM user WHERE id IN <foreach collection="list" item="id" open="(" separator="," close=")">#{id}</foreach>
        // å¤„ç†åSQL: SELECT * FROM user WHERE id IN (?, ?, ?, ?, ?)
        
        System.out.println("åŸå§‹å‚æ•°: list=" + userIds);
        
        // foreachä¼šä¸ºæ¯ä¸ªå…ƒç´ ç”Ÿæˆé¢å¤–å‚æ•°
        Map<String, Object> additionalParameters = new HashMap<>();
        for (int i = 0; i < userIds.size(); i++) {
            String paramKey = "__frch_id_" + i;
            additionalParameters.put(paramKey, userIds.get(i));
        }
        
        System.out.println("ç”Ÿæˆçš„é¢å¤–å‚æ•°:");
        additionalParameters.forEach((key, value) -> 
            System.out.println("  " + key + " = " + value));
        
        // è¿™äº›é¢å¤–å‚æ•°ä¼šè¢«æ·»åŠ åˆ°BoundSqlä¸­
        // DefaultParameterHandleråœ¨è·å–å‚æ•°å€¼æ—¶ï¼Œä¼šä¼˜å…ˆä»é¢å¤–å‚æ•°ä¸­è·å–
        System.out.println("å‚æ•°è·å–ä¼˜å…ˆçº§: é¢å¤–å‚æ•° > åŸå§‹å‚æ•°");
    }
}

/**
 * UserMapperæ¥å£ - é›†åˆå‚æ•°ç›¸å…³æ–¹æ³•
 */
interface UserMapper {
    
    /**
     * é€šè¿‡IDåˆ—è¡¨æŸ¥è¯¢ç”¨æˆ·
     */
    @Select("""
        SELECT * FROM user WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        """)
    List<User> findByIds(List<Long> userIds);
    
    /**
     * é€šè¿‡çŠ¶æ€æ•°ç»„æŸ¥è¯¢ç”¨æˆ·
     */
    @Select("""
        SELECT * FROM user WHERE status IN
        <foreach collection="array" item="status" open="(" separator="," close=")">
            #{status}
        </foreach>
        """)
    List<User> findByStatuses(String[] statuses);
    
    /**
     * æ‰¹é‡æ’å…¥ç”¨æˆ·
     */
    @Insert("""
        INSERT INTO user (name, email) VALUES
        <foreach collection="list" item="user" separator=",">
            (#{user.name}, #{user.email})
        </foreach>
        """)
    int batchInsertUsers(List<User> users);
}
```

## ğŸ›¡ï¸ å®‰å…¨ä¸æ‰©å±•ç¤ºä¾‹

### 3. å‚æ•°åŠ å¯†å¤„ç†å™¨

```java
package com.example.parameter.security;

import org.apache.ibatis.executor.parameter.ParameterHandler;
import org.apache.ibatis.mapping.BoundSql;
import org.apache.ibatis.mapping.MappedStatement;
import org.apache.ibatis.mapping.ParameterMapping;
import org.apache.ibatis.mapping.ParameterMode;
import org.apache.ibatis.reflection.MetaObject;
import org.apache.ibatis.scripting.defaults.DefaultParameterHandler;
import org.apache.ibatis.session.Configuration;
import org.apache.ibatis.type.JdbcType;
import org.apache.ibatis.type.TypeHandler;
import org.apache.ibatis.type.TypeHandlerRegistry;

import javax.crypto.Cipher;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.StandardCharsets;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.Base64;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * å‚æ•°åŠ å¯†å¤„ç†å™¨
 * è‡ªåŠ¨å¯¹æ•æ„Ÿå­—æ®µè¿›è¡ŒAESåŠ å¯†
 */
public class EncryptionParameterHandler implements ParameterHandler {
    
    private final DefaultParameterHandler delegate;
    private final Configuration configuration;
    private final TypeHandlerRegistry typeHandlerRegistry;
    private final MappedStatement mappedStatement;
    private final Object parameterObject;
    private final BoundSql boundSql;
    
    // éœ€è¦åŠ å¯†çš„å­—æ®µåé›†åˆ
    private static final Set<String> ENCRYPT_FIELDS = new HashSet<>();
    
    // AESåŠ å¯†å¯†é’¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
    private static final String ENCRYPT_KEY = "MyBatis123456789"; // 16ä½å¯†é’¥
    
    static {
        // é…ç½®éœ€è¦åŠ å¯†çš„å­—æ®µ
        ENCRYPT_FIELDS.add("password");
        ENCRYPT_FIELDS.add("idCard");
        ENCRYPT_FIELDS.add("phone");
        ENCRYPT_FIELDS.add("bankCard");
    }
    
    public EncryptionParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) {
        this.delegate = new DefaultParameterHandler(mappedStatement, parameterObject, boundSql);
        this.configuration = mappedStatement.getConfiguration();
        this.typeHandlerRegistry = configuration.getTypeHandlerRegistry();
        this.mappedStatement = mappedStatement;
        this.parameterObject = parameterObject;
        this.boundSql = boundSql;
    }
    
    @Override
    public Object getParameterObject() {
        return delegate.getParameterObject();
    }
    
    @Override
    public void setParameters(PreparedStatement ps) throws SQLException {
        System.out.println("=== ä½¿ç”¨åŠ å¯†å‚æ•°å¤„ç†å™¨ ===");
        
        List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
        
        if (parameterMappings != null) {
            MetaObject metaObject = null;
            
            for (int i = 0; i < parameterMappings.size(); i++) {
                ParameterMapping parameterMapping = parameterMappings.get(i);
                
                if (parameterMapping.getMode() != ParameterMode.OUT) {
                    Object value;
                    String propertyName = parameterMapping.getProperty();
                    
                    // è·å–åŸå§‹å‚æ•°å€¼ï¼ˆä½¿ç”¨ä¸DefaultParameterHandlerç›¸åŒçš„é€»è¾‘ï¼‰
                    if (boundSql.hasAdditionalParameter(propertyName)) {
                        value = boundSql.getAdditionalParameter(propertyName);
                    } else if (parameterObject == null) {
                        value = null;
                    } else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
                        value = parameterObject;
                    } else {
                        if (metaObject == null) {
                            metaObject = configuration.newMetaObject(parameterObject);
                        }
                        value = metaObject.getValue(propertyName);
                    }
                    
                    // å¯¹æ•æ„Ÿå­—æ®µè¿›è¡ŒåŠ å¯†
                    if (needEncryption(propertyName, value)) {
                        String originalValue = (String) value;
                        value = encryptValue(originalValue);
                        System.out.println(String.format("å­—æ®µ [%s] åŠ å¯†: %s -> %s", 
                            propertyName, maskSensitiveValue(originalValue), value));
                    }
                    
                    // è®¾ç½®å‚æ•°
                    TypeHandler typeHandler = parameterMapping.getTypeHandler();
                    JdbcType jdbcType = parameterMapping.getJdbcType();
                    
                    if (value == null && jdbcType == null) {
                        jdbcType = configuration.getJdbcTypeForNull();
                    }
                    
                    try {
                        typeHandler.setParameter(ps, i + 1, value, jdbcType);
                    } catch (Exception e) {
                        throw new SQLException("Could not set parameter: " + e.getMessage(), e);
                    }
                }
            }
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ å¯†
     */
    private boolean needEncryption(String propertyName, Object value) {
        return value instanceof String && 
               ENCRYPT_FIELDS.contains(propertyName) && 
               !((String) value).isEmpty();
    }
    
    /**
     * AESåŠ å¯†
     */
    private String encryptValue(String value) {
        try {
            SecretKeySpec secretKey = new SecretKeySpec(ENCRYPT_KEY.getBytes(StandardCharsets.UTF_8), "AES");
            Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");
            cipher.init(Cipher.ENCRYPT_MODE, secretKey);
            
            byte[] encryptedBytes = cipher.doFinal(value.getBytes(StandardCharsets.UTF_8));
            return Base64.getEncoder().encodeToString(encryptedBytes);
        } catch (Exception e) {
            throw new RuntimeException("å‚æ•°åŠ å¯†å¤±è´¥: " + e.getMessage(), e);
        }
    }
    
    /**
     * æ©ç æ˜¾ç¤ºæ•æ„Ÿå€¼
     */
    private String maskSensitiveValue(String value) {
        if (value == null || value.length() <= 4) {
            return "****";
        }
        return value.substring(0, 2) + "****" + value.substring(value.length() - 2);
    }
    
    /**
     * æ·»åŠ åŠ å¯†å­—æ®µ
     */
    public static void addEncryptField(String fieldName) {
        ENCRYPT_FIELDS.add(fieldName);
    }
    
    /**
     * ç§»é™¤åŠ å¯†å­—æ®µ
     */
    public static void removeEncryptField(String fieldName) {
        ENCRYPT_FIELDS.remove(fieldName);
    }
}

/**
 * åŠ å¯†è¯­è¨€é©±åŠ¨å™¨
 * åˆ›å»ºåŠ å¯†å‚æ•°å¤„ç†å™¨
 */
public class EncryptionLanguageDriver extends XMLLanguageDriver implements LanguageDriver {
    
    @Override
    public ParameterHandler createParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) {
        // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦ä½¿ç”¨åŠ å¯†å¤„ç†å™¨
        Configuration configuration = mappedStatement.getConfiguration();
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨åŠ å¯†ï¼ˆå¯ä»¥é€šè¿‡é…ç½®æˆ–æ³¨è§£æ§åˆ¶ï¼‰
        if (isEncryptionEnabled(mappedStatement)) {
            System.out.println("åˆ›å»ºåŠ å¯†å‚æ•°å¤„ç†å™¨ for: " + mappedStatement.getId());
            return new EncryptionParameterHandler(mappedStatement, parameterObject, boundSql);
        } else {
            // ä½¿ç”¨é»˜è®¤å‚æ•°å¤„ç†å™¨
            return super.createParameterHandler(mappedStatement, parameterObject, boundSql);
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦å¯ç”¨åŠ å¯†
     */
    private boolean isEncryptionEnabled(MappedStatement mappedStatement) {
        String statementId = mappedStatement.getId();
        
        // ç¤ºä¾‹ï¼šå¯¹åŒ…å«"User"çš„Mapperå¯ç”¨åŠ å¯†
        return statementId.contains("User");
    }
}

/**
 * åŠ å¯†å‚æ•°å¤„ç†å™¨æµ‹è¯•
 */
public class EncryptionParameterTest {
    
    @Test
    public void testEncryptionParameterHandler() {
        System.out.println("=== æµ‹è¯•å‚æ•°åŠ å¯†åŠŸèƒ½ ===");
        
        SqlSessionFactory factory = MyBatisUtils.getSqlSessionFactory();
        
        try (SqlSession session = factory.openSession()) {
            UserMapper mapper = session.getMapper(UserMapper.class);
            
            // åˆ›å»ºåŒ…å«æ•æ„Ÿä¿¡æ¯çš„ç”¨æˆ·å¯¹è±¡
            User user = new User();
            user.setUsername("testuser");
            user.setPassword("mypassword123");      // æ•æ„Ÿä¿¡æ¯ï¼Œä¼šè¢«åŠ å¯†
            user.setIdCard("123456789012345678");   // æ•æ„Ÿä¿¡æ¯ï¼Œä¼šè¢«åŠ å¯†
            user.setPhone("13812345678");           // æ•æ„Ÿä¿¡æ¯ï¼Œä¼šè¢«åŠ å¯†
            user.setEmail("test@example.com");      // æ™®é€šå­—æ®µï¼Œä¸åŠ å¯†
            
            System.out.println(">>> æ’å…¥ç”¨æˆ·å‰");
            System.out.println("åŸå§‹å¯†ç : " + user.getPassword());
            System.out.println("åŸå§‹èº«ä»½è¯: " + user.getIdCard());
            System.out.println("åŸå§‹æ‰‹æœºå·: " + user.getPhone());
            
            // æ’å…¥ç”¨æˆ·ï¼ˆæ•æ„Ÿå­—æ®µä¼šè‡ªåŠ¨åŠ å¯†ï¼‰
            int result = mapper.insertUser(user);
            
            System.out.println(">>> æ’å…¥ç»“æœ: " + result);
            
            session.commit();
        }
    }
}
```

### 4. å‚æ•°éªŒè¯å¤„ç†å™¨

```java
package com.example.parameter.validation;

import org.apache.ibatis.executor.parameter.ParameterHandler;
import org.apache.ibatis.mapping.BoundSql;
import org.apache.ibatis.mapping.MappedStatement;
import org.apache.ibatis.mapping.ParameterMapping;
import org.apache.ibatis.mapping.ParameterMode;
import org.apache.ibatis.reflection.MetaObject;
import org.apache.ibatis.scripting.defaults.DefaultParameterHandler;
import org.apache.ibatis.session.Configuration;
import org.apache.ibatis.type.TypeHandlerRegistry;

import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Predicate;
import java.util.regex.Pattern;

/**
 * å‚æ•°éªŒè¯å¤„ç†å™¨
 * åœ¨è®¾ç½®å‚æ•°å‰è¿›è¡Œæ•°æ®éªŒè¯
 */
public class ValidationParameterHandler implements ParameterHandler {
    
    private final DefaultParameterHandler delegate;
    private final Configuration configuration;
    private final TypeHandlerRegistry typeHandlerRegistry;
    private final MappedStatement mappedStatement;
    private final Object parameterObject;
    private final BoundSql boundSql;
    
    // éªŒè¯è§„åˆ™æ˜ å°„
    private static final Map<String, Validator> VALIDATION_RULES = new HashMap<>();
    
    static {
        // é…ç½®éªŒè¯è§„åˆ™
        VALIDATION_RULES.put("email", new EmailValidator());
        VALIDATION_RULES.put("phone", new PhoneValidator());
        VALIDATION_RULES.put("username", new UsernameValidator());
        VALIDATION_RULES.put("password", new PasswordValidator());
        VALIDATION_RULES.put("age", new AgeValidator());
    }
    
    public ValidationParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) {
        this.delegate = new DefaultParameterHandler(mappedStatement, parameterObject, boundSql);
        this.configuration = mappedStatement.getConfiguration();
        this.typeHandlerRegistry = configuration.getTypeHandlerRegistry();
        this.mappedStatement = mappedStatement;
        this.parameterObject = parameterObject;
        this.boundSql = boundSql;
    }
    
    @Override
    public Object getParameterObject() {
        return delegate.getParameterObject();
    }
    
    @Override
    public void setParameters(PreparedStatement ps) throws SQLException {
        System.out.println("=== ä½¿ç”¨éªŒè¯å‚æ•°å¤„ç†å™¨ ===");
        
        // é¦–å…ˆè¿›è¡Œå‚æ•°éªŒè¯
        validateParameters();
        
        // éªŒè¯é€šè¿‡åï¼Œå§”æ‰˜ç»™é»˜è®¤å¤„ç†å™¨
        delegate.setParameters(ps);
    }
    
    /**
     * éªŒè¯æ‰€æœ‰å‚æ•°
     */
    private void validateParameters() {
        List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
        
        if (parameterMappings != null) {
            MetaObject metaObject = null;
            
            for (ParameterMapping parameterMapping : parameterMappings) {
                if (parameterMapping.getMode() != ParameterMode.OUT) {
                    Object value;
                    String propertyName = parameterMapping.getProperty();
                    
                    // è·å–å‚æ•°å€¼
                    if (boundSql.hasAdditionalParameter(propertyName)) {
                        value = boundSql.getAdditionalParameter(propertyName);
                    } else if (parameterObject == null) {
                        value = null;
                    } else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
                        value = parameterObject;
                    } else {
                        if (metaObject == null) {
                            metaObject = configuration.newMetaObject(parameterObject);
                        }
                        value = metaObject.getValue(propertyName);
                    }
                    
                    // æ‰§è¡ŒéªŒè¯
                    validateParameter(propertyName, value);
                }
            }
        }
    }
    
    /**
     * éªŒè¯å•ä¸ªå‚æ•°
     */
    private void validateParameter(String propertyName, Object value) {
        Validator validator = VALIDATION_RULES.get(propertyName);
        
        if (validator != null) {
            ValidationResult result = validator.validate(value);
            
            if (!result.isValid()) {
                String message = String.format("å‚æ•°éªŒè¯å¤±è´¥ [%s]: %s (å€¼: %s)", 
                    propertyName, result.getMessage(), value);
                System.err.println(message);
                throw new IllegalArgumentException(message);
            } else {
                System.out.println(String.format("å‚æ•°éªŒè¯é€šè¿‡ [%s]: %s", propertyName, value));
            }
        }
    }
    
    /**
     * æ·»åŠ éªŒè¯è§„åˆ™
     */
    public static void addValidationRule(String propertyName, Validator validator) {
        VALIDATION_RULES.put(propertyName, validator);
    }
    
    /**
     * ç§»é™¤éªŒè¯è§„åˆ™
     */
    public static void removeValidationRule(String propertyName) {
        VALIDATION_RULES.remove(propertyName);
    }
}

/**
 * éªŒè¯å™¨æ¥å£
 */
interface Validator {
    ValidationResult validate(Object value);
}

/**
 * éªŒè¯ç»“æœç±»
 */
class ValidationResult {
    private final boolean valid;
    private final String message;
    
    private ValidationResult(boolean valid, String message) {
        this.valid = valid;
        this.message = message;
    }
    
    public static ValidationResult valid() {
        return new ValidationResult(true, null);
    }
    
    public static ValidationResult invalid(String message) {
        return new ValidationResult(false, message);
    }
    
    public boolean isValid() { return valid; }
    public String getMessage() { return message; }
}

/**
 * é‚®ç®±éªŒè¯å™¨
 */
class EmailValidator implements Validator {
    private static final Pattern EMAIL_PATTERN = 
        Pattern.compile("^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$");
    
    @Override
    public ValidationResult validate(Object value) {
        if (value == null) {
            return ValidationResult.valid();
        }
        
        String email = value.toString();
        boolean isValid = EMAIL_PATTERN.matcher(email).matches();
        return isValid ? ValidationResult.valid() : 
            ValidationResult.invalid("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
    }
}

/**
 * æ‰‹æœºå·éªŒè¯å™¨
 */
class PhoneValidator implements Validator {
    private static final Pattern PHONE_PATTERN = Pattern.compile("^1[3-9]\\d{9}$");
    
    @Override
    public ValidationResult validate(Object value) {
        if (value == null) {
            return ValidationResult.valid();
        }
        
        String phone = value.toString();
        boolean isValid = PHONE_PATTERN.matcher(phone).matches();
        return isValid ? ValidationResult.valid() : 
            ValidationResult.invalid("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
    }
}

/**
 * ç”¨æˆ·åéªŒè¯å™¨
 */
class UsernameValidator implements Validator {
    @Override
    public ValidationResult validate(Object value) {
        if (value == null) {
            return ValidationResult.invalid("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        
        String username = value.toString();
        if (username.length() < 3) {
            return ValidationResult.invalid("ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä½");
        }
        if (username.length() > 20) {
            return ValidationResult.invalid("ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡20ä½");
        }
        
        return ValidationResult.valid();
    }
}

/**
 * å¯†ç éªŒè¯å™¨
 */
class PasswordValidator implements Validator {
    @Override
    public ValidationResult validate(Object value) {
        if (value == null) {
            return ValidationResult.invalid("å¯†ç ä¸èƒ½ä¸ºç©º");
        }
        
        String password = value.toString();
        if (password.length() < 8) {
            return ValidationResult.invalid("å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½");
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«å­—æ¯å’Œæ•°å­—
        boolean hasLetter = Pattern.matches(".*[A-Za-z].*", password);
        boolean hasDigit = Pattern.matches(".*\\d.*", password);
        
        if (!hasLetter) {
            return ValidationResult.invalid("å¯†ç å¿…é¡»åŒ…å«å­—æ¯");
        }
        if (!hasDigit) {
            return ValidationResult.invalid("å¯†ç å¿…é¡»åŒ…å«æ•°å­—");
        }
        
        return ValidationResult.valid();
    }
}

/**
 * å¹´é¾„éªŒè¯å™¨
 */
class AgeValidator implements Validator {
    @Override
    public ValidationResult validate(Object value) {
        if (value == null) {
            return ValidationResult.valid();
        }
        
        Integer age;
        try {
            age = Integer.valueOf(value.toString());
        } catch (NumberFormatException e) {
            return ValidationResult.invalid("å¹´é¾„å¿…é¡»æ˜¯æ•°å­—");
        }
        
        if (age < 0) {
            return ValidationResult.invalid("å¹´é¾„ä¸èƒ½å°äº0");
        }
        if (age > 150) {
            return ValidationResult.invalid("å¹´é¾„ä¸èƒ½å¤§äº150");
        }
        
        return ValidationResult.valid();
    }
}

/**
 * éªŒè¯å‚æ•°å¤„ç†å™¨æµ‹è¯•
 */
public class ValidationParameterTest {
    
    @Test
    public void testValidationParameterHandler() {
        System.out.println("=== æµ‹è¯•å‚æ•°éªŒè¯åŠŸèƒ½ ===");
        
        testValidUserData();
        testInvalidUserData();
    }
    
    private void testValidUserData() {
        System.out.println(">>> æµ‹è¯•æœ‰æ•ˆç”¨æˆ·æ•°æ®");
        
        User user = new User();
        user.setUsername("validuser");
        user.setPassword("validpass123");
        user.setEmail("valid@example.com");
        user.setPhone("13812345678");
        user.setAge(25);
        
        try {
            // æ¨¡æ‹Ÿå‚æ•°éªŒè¯è¿‡ç¨‹
            simulateParameterValidation(user);
            System.out.println("âœ“ æœ‰æ•ˆæ•°æ®éªŒè¯é€šè¿‡");
        } catch (Exception e) {
            System.err.println("âœ— æœ‰æ•ˆæ•°æ®éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void testInvalidUserData() {
        System.out.println(">>> æµ‹è¯•æ— æ•ˆç”¨æˆ·æ•°æ®");
        
        // æµ‹è¯•å„ç§æ— æ•ˆæ•°æ®
        testInvalidEmail();
        testInvalidPhone();
        testInvalidUsername();
        testInvalidPassword();
        testInvalidAge();
    }
    
    private void testInvalidEmail() {
        User user = new User();
        user.setEmail("invalid-email");
        
        try {
            simulateParameterValidation(user);
            System.err.println("âœ— æ— æ•ˆé‚®ç®±åº”è¯¥éªŒè¯å¤±è´¥");
        } catch (Exception e) {
            System.out.println("âœ“ æ— æ•ˆé‚®ç®±éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void testInvalidPhone() {
        User user = new User();
        user.setPhone("12345");
        
        try {
            simulateParameterValidation(user);
            System.err.println("âœ— æ— æ•ˆæ‰‹æœºå·åº”è¯¥éªŒè¯å¤±è´¥");
        } catch (Exception e) {
            System.out.println("âœ“ æ— æ•ˆæ‰‹æœºå·éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void testInvalidUsername() {
        User user = new User();
        user.setUsername("ab"); // é•¿åº¦ä¸å¤Ÿ
        
        try {
            simulateParameterValidation(user);
            System.err.println("âœ— æ— æ•ˆç”¨æˆ·ååº”è¯¥éªŒè¯å¤±è´¥");
        } catch (Exception e) {
            System.out.println("âœ“ æ— æ•ˆç”¨æˆ·åéªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void testInvalidPassword() {
        User user = new User();
        user.setPassword("123456"); // æ²¡æœ‰å­—æ¯
        
        try {
            simulateParameterValidation(user);
            System.err.println("âœ— æ— æ•ˆå¯†ç åº”è¯¥éªŒè¯å¤±è´¥");
        } catch (Exception e) {
            System.out.println("âœ“ æ— æ•ˆå¯†ç éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void testInvalidAge() {
        User user = new User();
        user.setAge(-5); // è´Ÿæ•°å¹´é¾„
        
        try {
            simulateParameterValidation(user);
            System.err.println("âœ— æ— æ•ˆå¹´é¾„åº”è¯¥éªŒè¯å¤±è´¥");
        } catch (Exception e) {
            System.out.println("âœ“ æ— æ•ˆå¹´é¾„éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æ¨¡æ‹Ÿå‚æ•°éªŒè¯è¿‡ç¨‹
     */
    private void simulateParameterValidation(User user) {
        Configuration config = new Configuration();
        MetaObject metaObject = config.newMetaObject(user);
        
        // éªŒè¯æ¯ä¸ªå­—æ®µ
        String[] fields = {"username", "password", "email", "phone", "age"};
        
        for (String field : fields) {
            if (metaObject.hasGetter(field)) {
                Object value = metaObject.getValue(field);
                
                Validator validator = VALIDATION_RULES.get(field);
                if (validator != null) {
                    ValidationResult result = validator.validate(value);
                    if (!result.isValid()) {
                        throw new IllegalArgumentException(String.format("å­—æ®µ %s éªŒè¯å¤±è´¥: %s", field, result.getMessage()));
                    }
                }
            }
        }
    }
}
```

## ğŸ”§ è°ƒè¯•ä¸å·¥å…·ç¤ºä¾‹

### 5. ParameterHandlerè°ƒè¯•å·¥å…·

```java
package com.example.parameter.debug;

import org.apache.ibatis.executor.parameter.ParameterHandler;
import org.apache.ibatis.mapping.BoundSql;
import org.apache.ibatis.mapping.MappedStatement;
import org.apache.ibatis.mapping.ParameterMapping;
import org.apache.ibatis.reflection.MetaObject;
import org.apache.ibatis.scripting.defaults.DefaultParameterHandler;
import org.apache.ibatis.session.Configuration;
import org.apache.ibatis.type.TypeHandler;

import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.List;

/**
 * å‚æ•°å¤„ç†è°ƒè¯•å™¨
 * æä¾›è¯¦ç»†çš„å‚æ•°å¤„ç†è¿‡ç¨‹æ—¥å¿—
 */
public class ParameterHandlerDebugger implements ParameterHandler {
    
    private final DefaultParameterHandler delegate;
    private final Configuration configuration;
    private final MappedStatement mappedStatement;
    private final Object parameterObject;
    private final BoundSql boundSql;
    
    public ParameterHandlerDebugger(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) {
        this.delegate = new DefaultParameterHandler(mappedStatement, parameterObject, boundSql);
        this.configuration = mappedStatement.getConfiguration();
        this.mappedStatement = mappedStatement;
        this.parameterObject = parameterObject;
        this.boundSql = boundSql;
    }
    
    @Override
    public Object getParameterObject() {
        Object result = delegate.getParameterObject();
        System.out.println("ğŸ“„ getParameterObject() = " + (result != null ? result.getClass().getSimpleName() + ": " + result : "null"));
        return result;
    }
    
    @Override
    public void setParameters(PreparedStatement ps) throws SQLException {
        System.out.println("ğŸ” === ParameterHandler è°ƒè¯•ä¿¡æ¯ ===");
        System.out.println("ğŸ“‹ MappedStatement ID: " + mappedStatement.getId());
        System.out.println("ğŸ“‹ SQL: " + boundSql.getSql());
        System.out.println("ğŸ“‹ å‚æ•°å¯¹è±¡ç±»å‹: " + (parameterObject != null ? parameterObject.getClass().getSimpleName() : "null"));
        System.out.println("ğŸ“‹ å‚æ•°å¯¹è±¡å€¼: " + parameterObject);
        
        debugParameterMappings();
        debugAdditionalParameters();
        debugParameterProcessing();
        
        // æ‰§è¡Œå®é™…çš„å‚æ•°è®¾ç½®
        delegate.setParameters(ps);
        
        System.out.println("âœ… å‚æ•°è®¾ç½®å®Œæˆ");
        System.out.println("ğŸ” === è°ƒè¯•ä¿¡æ¯ç»“æŸ ===");
    }
    
    /**
     * è°ƒè¯•å‚æ•°æ˜ å°„ä¿¡æ¯
     */
    private void debugParameterMappings() {
        List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
        
        System.out.println("ğŸ“Š å‚æ•°æ˜ å°„ä¿¡æ¯:");
        if (parameterMappings == null || parameterMappings.isEmpty()) {
            System.out.println("   æ— å‚æ•°æ˜ å°„");
            return;
        }
        
        for (int i = 0; i < parameterMappings.size(); i++) {
            ParameterMapping pm = parameterMappings.get(i);
            System.out.println(String.format("   [%d] property=%s, javaType=%s, jdbcType=%s, mode=%s", 
                i + 1, 
                pm.getProperty(), 
                pm.getJavaType().getSimpleName(), 
                pm.getJdbcType(), 
                pm.getMode()));
        }
    }
    
    /**
     * è°ƒè¯•é¢å¤–å‚æ•°ä¿¡æ¯
     */
    private void debugAdditionalParameters() {
        System.out.println("ğŸ”— é¢å¤–å‚æ•°ä¿¡æ¯:");
        
        // é€šè¿‡åå°„è·å–additionalParametersï¼ˆå› ä¸ºå®ƒæ˜¯ç§æœ‰çš„ï¼‰
        try {
            java.lang.reflect.Field field = boundSql.getClass().getDeclaredField("additionalParameters");
            field.setAccessible(true);
            @SuppressWarnings("unchecked")
            java.util.Map<String, Object> additionalParams = (java.util.Map<String, Object>) field.get(boundSql);
            
            if (additionalParams == null || additionalParams.isEmpty()) {
                System.out.println("   æ— é¢å¤–å‚æ•°");
            } else {
                additionalParams.forEach((key, value) -> 
                    System.out.println("   " + key + " = " + value + " (" + (value != null ? value.getClass().getSimpleName() : "null") + ")"));
            }
        } catch (Exception e) {
            System.out.println("   æ— æ³•è·å–é¢å¤–å‚æ•°ä¿¡æ¯: " + e.getMessage());
        }
    }
    
    /**
     * è°ƒè¯•å‚æ•°å¤„ç†è¿‡ç¨‹
     */
    private void debugParameterProcessing() {
        System.out.println("âš™ï¸ å‚æ•°å¤„ç†è¿‡ç¨‹:");
        
        List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
        if (parameterMappings == null) {
            return;
        }
        
        MetaObject metaObject = null;
        
        for (int i = 0; i < parameterMappings.size(); i++) {
            ParameterMapping parameterMapping = parameterMappings.get(i);
            String propertyName = parameterMapping.getProperty();
            
            System.out.println(String.format("   å¤„ç†å‚æ•° [%d]: %s", i + 1, propertyName));
            
            // æ¨¡æ‹ŸDefaultParameterHandlerçš„å‚æ•°è·å–é€»è¾‘
            Object value = null;
            String source = "";
            
            if (boundSql.hasAdditionalParameter(propertyName)) {
                value = boundSql.getAdditionalParameter(propertyName);
                source = "é¢å¤–å‚æ•°";
            } else if (parameterObject == null) {
                value = null;
                source = "å‚æ•°å¯¹è±¡ä¸ºnull";
            } else if (configuration.getTypeHandlerRegistry().hasTypeHandler(parameterObject.getClass())) {
                value = parameterObject;
                source = "åŸºæœ¬ç±»å‹å‚æ•°å¯¹è±¡";
            } else {
                if (metaObject == null) {
                    metaObject = configuration.newMetaObject(parameterObject);
                }
                value = metaObject.getValue(propertyName);
                source = "MetaObjectåå°„è·å–";
            }
            
            TypeHandler<?> typeHandler = parameterMapping.getTypeHandler();
            
            System.out.println(String.format("     æ¥æº: %s", source));
            System.out.println(String.format("     å€¼: %s (%s)", value, value != null ? value.getClass().getSimpleName() : "null"));
            System.out.println(String.format("     TypeHandler: %s", typeHandler.getClass().getSimpleName()));
        }
    }
}

/**
 * è°ƒè¯•è¯­è¨€é©±åŠ¨å™¨
 */
public class DebugLanguageDriver extends XMLLanguageDriver {
    
    @Override
    public ParameterHandler createParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) {
        return new ParameterHandlerDebugger(mappedStatement, parameterObject, boundSql);
    }
}

/**
 * å‚æ•°å¤„ç†è°ƒè¯•æµ‹è¯•
 */
public class ParameterDebugTest {
    
    @Test
    public void testParameterHandlerDebug() {
        System.out.println("=== ParameterHandler è°ƒè¯•æµ‹è¯• ===");
        
        testBasicTypeParameter();
        testComplexObjectParameter();
        testCollectionParameter();
    }
    
    private void testBasicTypeParameter() {
        System.out.println("\n>>> åŸºæœ¬ç±»å‹å‚æ•°è°ƒè¯•");
        
        // åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
        Configuration config = new Configuration();
        config.setDefaultScriptingLanguage(DebugLanguageDriver.class);
        
        // æ¨¡æ‹ŸSQLæ‰§è¡Œ
        // è¿™é‡Œéœ€è¦å®Œæ•´çš„MyBatisç¯å¢ƒï¼Œç®€åŒ–ä¸ºæ¼”ç¤º
        simulateBasicParameter();
    }
    
    private void testComplexObjectParameter() {
        System.out.println("\n>>> å¤æ‚å¯¹è±¡å‚æ•°è°ƒè¯•");
        simulateComplexObjectParameter();
    }
    
    private void testCollectionParameter() {
        System.out.println("\n>>> é›†åˆå‚æ•°è°ƒè¯•");
        simulateCollectionParameter();
    }
    
    private void simulateBasicParameter() {
        // æ¨¡æ‹ŸåŸºæœ¬ç±»å‹å‚æ•°çš„å¤„ç†è¿‡ç¨‹
        System.out.println("æ¨¡æ‹Ÿå¤„ç†åŸºæœ¬ç±»å‹å‚æ•°: Long id = 123L");
        
        Long parameterObject = 123L;
        Configuration config = new Configuration();
        
        // æ£€æŸ¥ç±»å‹å¤„ç†å™¨
        boolean hasTypeHandler = config.getTypeHandlerRegistry().hasTypeHandler(parameterObject.getClass());
        System.out.println("hasTypeHandler(Long.class): " + hasTypeHandler);
        
        if (hasTypeHandler) {
            System.out.println("å‚æ•°è·å–ç­–ç•¥: ç›´æ¥ä½¿ç”¨parameterObject");
            System.out.println("å‚æ•°å€¼: " + parameterObject);
        }
    }
    
    private void simulateComplexObjectParameter() {
        // æ¨¡æ‹Ÿå¤æ‚å¯¹è±¡å‚æ•°çš„å¤„ç†è¿‡ç¨‹
        User user = new User();
        user.setId(123L);
        user.setName("å¼ ä¸‰");
        user.setEmail("zhangsan@example.com");
        
        System.out.println("æ¨¡æ‹Ÿå¤„ç†å¤æ‚å¯¹è±¡å‚æ•°: " + user);
        
        Configuration config = new Configuration();
        boolean hasTypeHandler = config.getTypeHandlerRegistry().hasTypeHandler(user.getClass());
        System.out.println("hasTypeHandler(User.class): " + hasTypeHandler);
        
        if (!hasTypeHandler) {
            System.out.println("å‚æ•°è·å–ç­–ç•¥: ä½¿ç”¨MetaObjectåå°„");
            MetaObject metaObject = config.newMetaObject(user);
            
            String[] properties = {"id", "name", "email"};
            for (String property : properties) {
                if (metaObject.hasGetter(property)) {
                    Object value = metaObject.getValue(property);
                    System.out.println("metaObject.getValue(\"" + property + "\"): " + value);
                }
            }
        }
    }
    
    private void simulateCollectionParameter() {
        // æ¨¡æ‹Ÿé›†åˆå‚æ•°çš„å¤„ç†è¿‡ç¨‹ï¼ˆé¢å¤–å‚æ•°ï¼‰
        List<Long> ids = Arrays.asList(1L, 2L, 3L);
        System.out.println("æ¨¡æ‹Ÿå¤„ç†é›†åˆå‚æ•°: " + ids);
        
        // æ¨¡æ‹Ÿforeachç”Ÿæˆçš„é¢å¤–å‚æ•°
        Map<String, Object> additionalParams = new HashMap<>();
        for (int i = 0; i < ids.size(); i++) {
            String paramKey = "__frch_id_" + i;
            additionalParams.put(paramKey, ids.get(i));
        }
        
        System.out.println("ç”Ÿæˆçš„é¢å¤–å‚æ•°:");
        additionalParams.forEach((key, value) -> 
            System.out.println("  " + key + " = " + value));
        
        System.out.println("å‚æ•°è·å–ç­–ç•¥: ä¼˜å…ˆä»é¢å¤–å‚æ•°è·å–");
    }
}
```

---

## ğŸ“ˆ æ€»ç»“

æœ¬ä»£ç ç¤ºä¾‹é›†åˆæ¶µç›–äº†ParameterHandlerå‚æ•°å¤„ç†æœºåˆ¶çš„å®Œæ•´å®è·µæ¡ˆä¾‹ï¼š

### ğŸ”¹ åŸºç¡€ä½¿ç”¨
- åŸºæœ¬ç±»å‹å‚æ•°å¤„ç†ï¼ˆå•ä¸ª/å¤šä¸ª/å‘½åå‚æ•°ï¼‰
- å¤æ‚å¯¹è±¡å‚æ•°å¤„ç†ï¼ˆPOJO/åµŒå¥—å¯¹è±¡/Mapï¼‰
- é›†åˆç±»å‹å‚æ•°å¤„ç†ï¼ˆList/Array/foreachï¼‰

### ğŸ”¹ å®‰å…¨æ‰©å±•
- å‚æ•°åŠ å¯†å¤„ç†å™¨ï¼ˆAESåŠ å¯†æ•æ„Ÿå­—æ®µï¼‰
- å‚æ•°éªŒè¯å¤„ç†å™¨ï¼ˆæ•°æ®æ ¼å¼å’Œä¸šåŠ¡è§„åˆ™éªŒè¯ï¼‰

### ğŸ”¹ è°ƒè¯•å·¥å…·
- å‚æ•°å¤„ç†è°ƒè¯•å™¨ï¼ˆè¯¦ç»†çš„å¤„ç†è¿‡ç¨‹æ—¥å¿—ï¼‰
- å‚æ•°è·å–ç­–ç•¥æ¼”ç¤ºï¼ˆä¼˜å…ˆçº§é€»è¾‘è¯´æ˜ï¼‰

### ğŸ”¹ å…³é”®å­¦ä¹ ç‚¹
1. **å‚æ•°è·å–ä¼˜å…ˆçº§**ï¼šé¢å¤–å‚æ•° > ç©ºå‚æ•° > åŸºæœ¬ç±»å‹ > å¤æ‚å¯¹è±¡
2. **TypeHandleråä½œ**ï¼šParameterHandlerè´Ÿè´£è·å–ï¼ŒTypeHandlerè´Ÿè´£è½¬æ¢
3. **MetaObjectä½¿ç”¨**ï¼šå¤æ‚å¯¹è±¡å±æ€§è®¿é—®çš„æ ¸å¿ƒå·¥å…·
4. **æ‰©å±•å¼€å‘æ¨¡å¼**ï¼šè£…é¥°å™¨æ¨¡å¼å’Œè´£ä»»é“¾æ¨¡å¼çš„åº”ç”¨

è¿™äº›ç¤ºä¾‹ä»£ç å¯ä»¥ç›´æ¥è¿è¡Œå’Œè°ƒè¯•ï¼Œå¸®åŠ©æ·±å…¥ç†è§£MyBatis ParameterHandlerçš„å·¥ä½œæœºåˆ¶ã€‚