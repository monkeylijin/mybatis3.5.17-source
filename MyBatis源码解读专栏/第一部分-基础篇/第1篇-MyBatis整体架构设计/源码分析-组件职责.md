# ç¬¬1ç¯‡ï¼šMyBatis ç»„ä»¶èŒè´£åˆ†æ

## ğŸ” ä»ç®€å•ç¤ºä¾‹çœ‹ MyBatis ç»„ä»¶

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢ç¤ºä¾‹æ¥åˆ†æ MyBatis å„ä¸ªç»„ä»¶çš„èŒè´£ï¼š

```java
// 1. åˆ›å»º SqlSessionFactory
SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

// 2. åˆ›å»º SqlSession
SqlSession session = sqlSessionFactory.openSession();

// 3. æ‰§è¡ŒæŸ¥è¯¢
User user = session.selectOne("com.example.UserMapper.selectById", 1);
```

## ğŸ“‹ ç»„ä»¶èŒè´£åˆ†æ

### 1. SqlSessionFactoryBuilder

**èŒè´£**ï¼šæ„å»º SqlSessionFactory å®ä¾‹

**æºç ä½ç½®**ï¼š`org.apache.ibatis.session.SqlSessionFactoryBuilder`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public SqlSessionFactory build(InputStream inputStream) {
    return build(inputStream, null, null);
}

public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {
    try {
        XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);
        return build(parser.parse());
    } catch (Exception e) {
        throw ExceptionFactory.wrapException("Error building SqlSession.", e);
    } finally {
        ErrorContext.instance().reset();
        try {
            inputStream.close();
        } catch (IOException e) {
            // Intentionally ignore. Prefer previous error.
        }
    }
}
```

**å·¥ä½œæµç¨‹**ï¼š
1. åˆ›å»º XMLConfigBuilder è§£æé…ç½®æ–‡ä»¶
2. è°ƒç”¨ parser.parse() è§£æé…ç½®
3. è¿”å› SqlSessionFactory å®ä¾‹

### 2. SqlSessionFactory

**èŒè´£**ï¼šåˆ›å»º SqlSession å®ä¾‹çš„å·¥å‚

**æºç ä½ç½®**ï¼š`org.apache.ibatis.session.SqlSessionFactory`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public interface SqlSessionFactory {
    SqlSession openSession();
    SqlSession openSession(boolean autoCommit);
    SqlSession openSession(Connection connection);
    SqlSession openSession(TransactionIsolationLevel level);
    SqlSession openSession(ExecutorType execType);
    SqlSession openSession(ExecutorType execType, boolean autoCommit);
    SqlSession openSession(ExecutorType execType, TransactionIsolationLevel level);
    SqlSession openSession(ExecutorType execType, Connection connection);
    Configuration getConfiguration();
}
```

**å®ç°ç±»**ï¼š`DefaultSqlSessionFactory`

**å·¥ä½œæµç¨‹**ï¼š
1. æ ¹æ®å‚æ•°åˆ›å»º Executor
2. åˆ›å»º SqlSession å®ä¾‹
3. è¿”å› SqlSession

### 3. SqlSession

**èŒè´£**ï¼šä¸æ•°æ®åº“äº¤äº’çš„ä¼šè¯æ¥å£

**æºç ä½ç½®**ï¼š`org.apache.ibatis.session.SqlSession`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public interface SqlSession extends Closeable {
    <T> T selectOne(String statement);
    <T> T selectOne(String statement, Object parameter);
    <E> List<E> selectList(String statement);
    <E> List<E> selectList(String statement, Object parameter);
    int insert(String statement);
    int insert(String statement, Object parameter);
    int update(String statement);
    int update(String statement, Object parameter);
    int delete(String statement);
    int delete(String statement, Object parameter);
    void commit();
    void rollback();
    <T> T getMapper(Class<T> type);
}
```

**å®ç°ç±»**ï¼š`DefaultSqlSession`

**å·¥ä½œæµç¨‹**ï¼š
1. æ¥æ”¶ç”¨æˆ·è¯·æ±‚
2. å§”æ‰˜ç»™ Executor æ‰§è¡Œ
3. è¿”å›æ‰§è¡Œç»“æœ

### 4. Executor

**èŒè´£**ï¼šSQL æ‰§è¡Œå™¨ï¼Œè´Ÿè´£ SQL çš„æ‰§è¡Œå’Œç¼“å­˜ç®¡ç†

**æºç ä½ç½®**ï¼š`org.apache.ibatis.executor.Executor`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public interface Executor {
    int update(MappedStatement ms, Object parameter) throws SQLException;
    <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, 
                     ResultHandler resultHandler) throws SQLException;
    void commit(boolean required) throws SQLException;
    void rollback(boolean required) throws SQLException;
    CacheKey createCacheKey(MappedStatement ms, Object parameterObject, 
                           RowBounds rowBounds, BoundSql boundSql);
    boolean isCached(MappedStatement ms, CacheKey key);
    void clearLocalCache();
}
```

**å®ç°ç±»**ï¼š
- `SimpleExecutor`ï¼šç®€å•æ‰§è¡Œå™¨
- `ReuseExecutor`ï¼šé‡ç”¨æ‰§è¡Œå™¨
- `BatchExecutor`ï¼šæ‰¹å¤„ç†æ‰§è¡Œå™¨
- `CachingExecutor`ï¼šç¼“å­˜æ‰§è¡Œå™¨

**å·¥ä½œæµç¨‹**ï¼š
1. æ£€æŸ¥ç¼“å­˜
2. åˆ›å»º StatementHandler
3. æ‰§è¡Œ SQL
4. å¤„ç†ç»“æœ

### 5. StatementHandler

**èŒè´£**ï¼šå¤„ç† SQL è¯­å¥

**æºç ä½ç½®**ï¼š`org.apache.ibatis.executor.statement.StatementHandler`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public interface StatementHandler {
    Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException;
    void parameterize(Statement statement) throws SQLException;
    void batch(Statement statement) throws SQLException;
    int update(Statement statement) throws SQLException;
    <E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException;
    BoundSql getBoundSql();
    ParameterHandler getParameterHandler();
}
```

**å®ç°ç±»**ï¼š
- `PreparedStatementHandler`ï¼šé¢„ç¼–è¯‘è¯­å¥å¤„ç†å™¨
- `SimpleStatementHandler`ï¼šç®€å•è¯­å¥å¤„ç†å™¨
- `CallableStatementHandler`ï¼šå­˜å‚¨è¿‡ç¨‹è¯­å¥å¤„ç†å™¨
- `RoutingStatementHandler`ï¼šè·¯ç”±è¯­å¥å¤„ç†å™¨

**å·¥ä½œæµç¨‹**ï¼š
1. å‡†å¤‡ Statement
2. å‚æ•°åŒ–å¤„ç†
3. æ‰§è¡Œ SQL
4. å¤„ç†ç»“æœ

### 6. ParameterHandler

**èŒè´£**ï¼šå¤„ç† SQL å‚æ•°

**æºç ä½ç½®**ï¼š`org.apache.ibatis.executor.parameter.ParameterHandler`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public interface ParameterHandler {
    Object getParameterObject();
    void setParameters(PreparedStatement ps) throws SQLException;
}
```

**å®ç°ç±»**ï¼š`DefaultParameterHandler`

**å·¥ä½œæµç¨‹**ï¼š
1. è·å–å‚æ•°å¯¹è±¡
2. è®¾ç½® PreparedStatement å‚æ•°

### 7. ResultSetHandler

**èŒè´£**ï¼šå¤„ç†æŸ¥è¯¢ç»“æœé›†

**æºç ä½ç½®**ï¼š`org.apache.ibatis.executor.resultset.ResultSetHandler`

**ä¸»è¦æ–¹æ³•**ï¼š
```java
public interface ResultSetHandler {
    <E> List<E> handleResultSets(Statement stmt) throws SQLException;
    <E> Cursor<E> handleCursorResultSets(Statement stmt) throws SQLException;
    void handleOutputParameters(CallableStatement cs) throws SQLException;
}
```

**å®ç°ç±»**ï¼š`DefaultResultSetHandler`

**å·¥ä½œæµç¨‹**ï¼š
1. å¤„ç† ResultSet
2. æ˜ å°„åˆ° Java å¯¹è±¡
3. è¿”å›ç»“æœ

### 8. Configuration

**èŒè´£**ï¼šMyBatis çš„é…ç½®ä¸­å¿ƒ

**æºç ä½ç½®**ï¼š`org.apache.ibatis.session.Configuration`

**ä¸»è¦å±æ€§**ï¼š
```java
public class Configuration {
    protected Environment environment;
    protected boolean safeRowBoundsEnabled;
    protected boolean safeResultHandlerEnabled;
    protected boolean mapUnderscoreToCamelCase;
    protected boolean aggressiveLazyLoading;
    protected boolean multipleResultSetsEnabled;
    protected boolean useGeneratedKeys;
    protected boolean useColumnLabel;
    protected boolean cacheEnabled;
    protected boolean callSettersOnNulls;
    protected boolean useActualParamName;
    protected boolean returnInstanceForEmptyRow;
    
    protected String logPrefix;
    protected Class<? extends Log> logImpl;
    protected Class<? extends VFS> vfsImpl;
    protected LocalCacheScope localCacheScope;
    protected JdbcType jdbcTypeForNull;
    protected Set<String> lazyLoadTriggerMethods;
    protected Integer defaultStatementTimeout;
    protected Integer defaultFetchSize;
    protected ResultSetType defaultResultSetType;
    protected ExecutorType defaultExecutorType;
    protected AutoMappingBehavior autoMappingBehavior;
    protected AutoMappingUnknownColumnBehavior autoMappingUnknownColumnBehavior;
    
    protected Properties variables;
    protected ReflectorFactory reflectorFactory;
    protected ObjectFactory objectFactory;
    protected ObjectWrapperFactory objectWrapperFactory;
    protected MapperRegistry mapperRegistry;
    protected InterceptorChain interceptorChain;
    protected TypeHandlerRegistry typeHandlerRegistry;
    protected TypeAliasRegistry typeAliasRegistry;
    protected LanguageDriverRegistry languageRegistry;
    protected Map<String, MappedStatement> mappedStatements;
    protected Map<String, Cache> caches;
    protected Map<String, ResultMap> resultMaps;
    protected Map<String, ParameterMap> parameterMaps;
    protected Map<String, KeyGenerator> keyGenerators;
    protected Set<String> loadedResources;
    protected String databaseId;
    protected Class<?> configurationFactory;
    protected Map<String, String> cacheRefMap;
}
```

**å·¥ä½œæµç¨‹**ï¼š
1. è§£æé…ç½®æ–‡ä»¶
2. æ³¨å†Œå„ç§ç»„ä»¶
3. ç®¡ç†å…¨å±€é…ç½®

## ğŸ”„ ç»„ä»¶åä½œå…³ç³»

### 1. åˆ›å»ºé˜¶æ®µ
```
SqlSessionFactoryBuilder â†’ XMLConfigBuilder â†’ Configuration â†’ SqlSessionFactory
```

### 2. ä½¿ç”¨é˜¶æ®µ
```
SqlSessionFactory â†’ SqlSession â†’ Executor â†’ StatementHandler â†’ ParameterHandler + ResultSetHandler
```

### 3. æ•°æ®æµè½¬
```
ç”¨æˆ·è¯·æ±‚ â†’ SqlSession â†’ Executor â†’ StatementHandler â†’ æ•°æ®åº“
æ•°æ®åº“ â†’ ResultSetHandler â†’ Executor â†’ SqlSession â†’ ç”¨æˆ·
```

## ğŸ’¡ å…³é”®ç†è§£ç‚¹

1. **åˆ†å±‚è®¾è®¡**ï¼šMyBatis é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œæ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£
2. **æ¥å£æŠ½è±¡**ï¼šå¤§é‡ä½¿ç”¨æ¥å£ï¼Œä¾¿äºæ‰©å±•å’Œæµ‹è¯•
3. **å·¥å‚æ¨¡å¼**ï¼šä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è±¡
4. **ä»£ç†æ¨¡å¼**ï¼šä½¿ç”¨åŠ¨æ€ä»£ç†å®ç° Mapper æ¥å£
5. **è£…é¥°å™¨æ¨¡å¼**ï¼šä½¿ç”¨è£…é¥°å™¨æ¨¡å¼å®ç°åŠŸèƒ½å¢å¼º

## ğŸ¯ å­¦ä¹ é‡ç‚¹

1. **ç†è§£å„ç»„ä»¶çš„èŒè´£**ï¼šæ¯ä¸ªç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„èŒè´£åˆ†å·¥
2. **æŒæ¡ç»„ä»¶åä½œå…³ç³»**ï¼šç†è§£ç»„ä»¶ä¹‹é—´æ˜¯å¦‚ä½•åä½œçš„
3. **å­¦ä¼šè·Ÿè¸ªæ‰§è¡Œæµç¨‹**ï¼šèƒ½å¤Ÿè·Ÿè¸ªä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´æ‰§è¡Œæµç¨‹
4. **ç†è§£è®¾è®¡æ¨¡å¼åº”ç”¨**ï¼šç†è§£å„ç§è®¾è®¡æ¨¡å¼åœ¨ MyBatis ä¸­çš„åº”ç”¨

## ğŸ“ å®è·µå»ºè®®

1. **é˜…è¯»æºç **ï¼šä»”ç»†é˜…è¯»å„ä¸ªç»„ä»¶çš„æºç 
2. **è·Ÿè¸ªæ‰§è¡Œæµç¨‹**ï¼šä½¿ç”¨è°ƒè¯•å™¨è·Ÿè¸ªæ‰§è¡Œæµç¨‹
3. **ç»˜åˆ¶æ¶æ„å›¾**ï¼šç»˜åˆ¶ç»„ä»¶å…³ç³»å›¾
4. **ç¼–å†™ç¤ºä¾‹ä»£ç **ï¼šç¼–å†™ç®€å•çš„ç¤ºä¾‹ä»£ç éªŒè¯ç†è§£

