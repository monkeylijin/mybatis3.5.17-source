# æˆ‘çš„ç»„ä»¶èŒè´£åˆ†æ

## ğŸ” ä»»åŠ¡è¯´æ˜

è¿™æ˜¯ç¬¬1ç¯‡çš„å®è·µä»»åŠ¡ï¼šåˆ†æç»„ä»¶èŒè´£

**è¦æ±‚åˆ†æä»¥ä¸‹ç»„ä»¶**ï¼š
1. **SqlSession**ï¼šä¼šè¯ç®¡ç†
2. **Executor**ï¼šSQL æ‰§è¡Œ
3. **StatementHandler**ï¼šè¯­å¥å¤„ç†
4. **Configuration**ï¼šé…ç½®ç®¡ç†

## ğŸ“‹ ç»„ä»¶èŒè´£åˆ†æ

### 1. SqlSession èŒè´£åˆ†æ

#### ä¸»è¦èŒè´£

**ä¼šè¯ç®¡ç†**ï¼š
- ä»£è¡¨ä¸æ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯
- ç®¡ç†ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºã€ä½¿ç”¨ã€å…³é—­ï¼‰
- æä¾›äº‹åŠ¡ç®¡ç†åŠŸèƒ½ï¼ˆcommitã€rollbackï¼‰

**æ•°æ®è®¿é—®æ¥å£**ï¼š
- æä¾› CRUD æ“ä½œçš„ç»Ÿä¸€æ¥å£
- æ”¯æŒæŸ¥è¯¢æ“ä½œï¼ˆselectOneã€selectListï¼‰
- æ”¯æŒä¿®æ”¹æ“ä½œï¼ˆinsertã€updateã€deleteï¼‰
- æ”¯æŒæ‰¹é‡æ“ä½œ

**Mapper ç®¡ç†**ï¼š
- æä¾› Mapper æ¥å£çš„è·å–æ–¹æ³•
- é€šè¿‡åŠ¨æ€ä»£ç†å®ç° Mapper æ¥å£
- ç®¡ç† Mapper ä¸ SQL çš„æ˜ å°„å…³ç³»

#### æ ¸å¿ƒæ–¹æ³•åˆ†æ

```java
// æŸ¥è¯¢æ–¹æ³•
<T> T selectOne(String statement);
<T> T selectOne(String statement, Object parameter);
<E> List<E> selectList(String statement);
<E> List<E> selectList(String statement, Object parameter);

// ä¿®æ”¹æ–¹æ³•
int insert(String statement);
int insert(String statement, Object parameter);
int update(String statement);
int update(String statement, Object parameter);
int delete(String statement);
int delete(String statement, Object parameter);

// äº‹åŠ¡ç®¡ç†
void commit();
void rollback();

// Mapper ç®¡ç†
<T> T getMapper(Class<T> type);

// ç”Ÿå‘½å‘¨æœŸç®¡ç†
void close();
```

#### è®¾è®¡æ€æƒ³

1. **ç»Ÿä¸€å…¥å£**ï¼šä½œä¸º MyBatis çš„ä¸»è¦å…¥å£ï¼Œå°è£…å¤æ‚çš„æ•°æ®åº“æ“ä½œ
2. **ç®€æ´API**ï¼šæä¾›ç®€æ´æ˜“ç”¨çš„ APIï¼Œéšè—åº•å±‚å¤æ‚æ€§
3. **ä¼šè¯æŠ½è±¡**ï¼šæŠ½è±¡æ•°æ®åº“ä¼šè¯æ¦‚å¿µï¼Œæä¾›ç»Ÿä¸€çš„æ“ä½œæ¥å£
4. **äº‹åŠ¡æ”¯æŒ**ï¼šå†…ç½®äº‹åŠ¡ç®¡ç†ï¼Œç®€åŒ–äº‹åŠ¡æ“ä½œ

#### ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»

- **ä¾èµ– Executor**ï¼šå§”æ‰˜ SQL æ‰§è¡Œç»™ Executor
- **ä¾èµ– Configuration**ï¼šä» Configuration è·å–é…ç½®ä¿¡æ¯
- **è¢« Mapper ä½¿ç”¨**ï¼šMapper æ¥å£é€šè¿‡ SqlSession æ‰§è¡Œæ“ä½œ

### 2. Executor èŒè´£åˆ†æ

#### ä¸»è¦èŒè´£

**SQL æ‰§è¡Œ**ï¼š
- æ‰§è¡Œ SQL è¯­å¥ï¼ˆæŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ã€æ’å…¥ï¼‰
- ç®¡ç† SQL æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸ
- æ”¯æŒä¸åŒçš„æ‰§è¡Œç­–ç•¥

**ç¼“å­˜ç®¡ç†**ï¼š
- ç®¡ç†ä¸€çº§ç¼“å­˜ï¼ˆLocal Cacheï¼‰
- æä¾›ç¼“å­˜é”®ç”ŸæˆåŠŸèƒ½
- æ”¯æŒç¼“å­˜å¤±æ•ˆå’Œæ¸…ç†

**äº‹åŠ¡ç®¡ç†**ï¼š
- å¤„ç†äº‹åŠ¡çš„æäº¤å’Œå›æ»š
- ç®¡ç†äº‹åŠ¡çš„è¾¹ç•Œ
- æ”¯æŒäº‹åŠ¡çš„ä¼ æ’­

#### æ ¸å¿ƒæ–¹æ³•åˆ†æ

```java
// SQL æ‰§è¡Œ
int update(MappedStatement ms, Object parameter) throws SQLException;
<E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, 
                 ResultHandler resultHandler) throws SQLException;

// äº‹åŠ¡ç®¡ç†
void commit(boolean required) throws SQLException;
void rollback(boolean required) throws SQLException;

// ç¼“å­˜ç®¡ç†
CacheKey createCacheKey(MappedStatement ms, Object parameterObject, 
                       RowBounds rowBounds, BoundSql boundSql);
boolean isCached(MappedStatement ms, CacheKey key);
void clearLocalCache();
```

#### æ‰§è¡Œå™¨ç±»å‹

1. **SimpleExecutor**ï¼šç®€å•æ‰§è¡Œå™¨ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½åˆ›å»ºæ–°çš„ Statement
2. **ReuseExecutor**ï¼šé‡ç”¨æ‰§è¡Œå™¨ï¼Œé‡ç”¨ Statement å¯¹è±¡
3. **BatchExecutor**ï¼šæ‰¹å¤„ç†æ‰§è¡Œå™¨ï¼Œæ”¯æŒæ‰¹é‡æ“ä½œ
4. **CachingExecutor**ï¼šç¼“å­˜æ‰§è¡Œå™¨ï¼Œæä¾›ç¼“å­˜åŠŸèƒ½

#### è®¾è®¡æ€æƒ³

1. **ç­–ç•¥æ¨¡å¼**ï¼šæ”¯æŒä¸åŒçš„æ‰§è¡Œç­–ç•¥
2. **æ¨¡æ¿æ–¹æ³•**ï¼šå®šä¹‰æ‰§è¡Œæµç¨‹çš„æ¨¡æ¿
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šé€šè¿‡ç¼“å­˜æé«˜æ€§èƒ½
4. **äº‹åŠ¡æ”¯æŒ**ï¼šå†…ç½®äº‹åŠ¡ç®¡ç†åŠŸèƒ½

#### ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»

- **ä¾èµ– StatementHandler**ï¼šå§”æ‰˜ SQL å¤„ç†ç»™ StatementHandler
- **ä¾èµ– Configuration**ï¼šä» Configuration è·å–é…ç½®
- **è¢« SqlSession ä½¿ç”¨**ï¼šSqlSession å§”æ‰˜æ‰§è¡Œç»™ Executor

### 3. StatementHandler èŒè´£åˆ†æ

#### ä¸»è¦èŒè´£

**SQL è¯­å¥å¤„ç†**ï¼š
- å¤„ç†ä¸åŒç±»å‹çš„ SQL è¯­å¥
- ç®¡ç† Statement å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ
- æ”¯æŒé¢„ç¼–è¯‘å’Œç®€å•è¯­å¥

**å‚æ•°ç»‘å®š**ï¼š
- å¤„ç† SQL å‚æ•°çš„ç»‘å®š
- æ”¯æŒä¸åŒç±»å‹çš„å‚æ•°æ˜ å°„
- æä¾›å‚æ•°éªŒè¯åŠŸèƒ½

**ç»“æœé›†å¤„ç†**ï¼š
- å¤„ç†æŸ¥è¯¢ç»“æœé›†
- æ”¯æŒç»“æœé›†çš„æ˜ å°„
- æä¾›ç»“æœé›†è½¬æ¢åŠŸèƒ½

#### æ ¸å¿ƒæ–¹æ³•åˆ†æ

```java
// Statement ç®¡ç†
Statement prepare(Connection connection, Integer transactionTimeout) throws SQLException;

// å‚æ•°å¤„ç†
void parameterize(Statement statement) throws SQLException;

// æ‰¹é‡å¤„ç†
void batch(Statement statement) throws SQLException;

// SQL æ‰§è¡Œ
int update(Statement statement) throws SQLException;
<E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException;

// è·å–ä¿¡æ¯
BoundSql getBoundSql();
ParameterHandler getParameterHandler();
```

#### å¤„ç†å™¨ç±»å‹

1. **PreparedStatementHandler**ï¼šé¢„ç¼–è¯‘è¯­å¥å¤„ç†å™¨
2. **SimpleStatementHandler**ï¼šç®€å•è¯­å¥å¤„ç†å™¨
3. **CallableStatementHandler**ï¼šå­˜å‚¨è¿‡ç¨‹è¯­å¥å¤„ç†å™¨
4. **RoutingStatementHandler**ï¼šè·¯ç”±è¯­å¥å¤„ç†å™¨

#### è®¾è®¡æ€æƒ³

1. **ç­–ç•¥æ¨¡å¼**ï¼šæ”¯æŒä¸åŒç±»å‹çš„ Statement å¤„ç†
2. **æ¨¡æ¿æ–¹æ³•**ï¼šå®šä¹‰å¤„ç†æµç¨‹çš„æ¨¡æ¿
3. **èŒè´£åˆ†ç¦»**ï¼šåˆ†ç¦»å‚æ•°å¤„ç†å’Œç»“æœå¤„ç†
4. **JDBC å°è£…**ï¼šå°è£… JDBC çš„å¤æ‚æ€§

#### ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»

- **ä¾èµ– ParameterHandler**ï¼šå§”æ‰˜å‚æ•°å¤„ç†
- **ä¾èµ– ResultSetHandler**ï¼šå§”æ‰˜ç»“æœé›†å¤„ç†
- **è¢« Executor ä½¿ç”¨**ï¼šExecutor å§”æ‰˜å¤„ç†ç»™ StatementHandler

### 4. Configuration èŒè´£åˆ†æ

#### ä¸»è¦èŒè´£

**é…ç½®ç®¡ç†**ï¼š
- å­˜å‚¨æ‰€æœ‰ MyBatis é…ç½®ä¿¡æ¯
- æä¾›é…ç½®é¡¹çš„è®¿é—®æ¥å£
- æ”¯æŒé…ç½®çš„éªŒè¯å’Œé»˜è®¤å€¼å¤„ç†

**æ˜ å°„ç®¡ç†**ï¼š
- ç®¡ç† MappedStatement å¯¹è±¡
- ç®¡ç† ResultMap å’Œ ParameterMap
- ç®¡ç† Cache å’Œ KeyGenerator

**æ³¨å†Œè¡¨ç®¡ç†**ï¼š
- ç®¡ç† MapperRegistry
- ç®¡ç† TypeHandlerRegistry
- ç®¡ç† TypeAliasRegistry

#### æ ¸å¿ƒæ–¹æ³•åˆ†æ

```java
// æ˜ å°„ç®¡ç†
void addMappedStatement(MappedStatement ms);
MappedStatement getMappedStatement(String id);
void removeMappedStatement(String id);

// Mapper ç®¡ç†
<T> void addMapper(Class<T> type);
<T> T getMapper(Class<T> type, SqlSession sqlSession);

// é…ç½®ç®¡ç†
void setVariables(Properties variables);
Properties getVariables();
void addLoadedResource(String resource);
boolean isResourceLoaded(String resource);

// é…ç½®éªŒè¯
void validate();
```

#### è®¾è®¡æ€æƒ³

1. **é…ç½®ä¸­å¿ƒ**ï¼šä½œä¸ºæ‰€æœ‰é…ç½®çš„ä¸­å¿ƒ
2. **ç»Ÿä¸€ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†å„ç§é…ç½®é¡¹
3. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨æ³›å‹ç¡®ä¿ç±»å‹å®‰å…¨
4. **éªŒè¯æœºåˆ¶**ï¼šæä¾›é…ç½®éªŒè¯åŠŸèƒ½

#### ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»

- **è¢«æ‰€æœ‰ç»„ä»¶ä¾èµ–**ï¼šæ‰€æœ‰ç»„ä»¶éƒ½ä¾èµ– Configuration
- **æä¾›é…ç½®ä¿¡æ¯**ï¼šä¸ºå…¶ä»–ç»„ä»¶æä¾›é…ç½®ä¿¡æ¯
- **ç®¡ç†ç»„ä»¶æ³¨å†Œ**ï¼šç®¡ç†å„ç§ç»„ä»¶çš„æ³¨å†Œ

## ğŸ” ç»„ä»¶åä½œå…³ç³»åˆ†æ

### æ•´ä½“åä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ SqlSession â†’ Executor â†’ StatementHandler â†’ JDBC â†’ æ•°æ®åº“
         â†‘                                                    â†“
         â† ResultSetHandler â† StatementHandler â† Executor â† ç»“æœé›†
```

### è¯¦ç»†åä½œå…³ç³»

1. **SqlSession ä¸ Executor**ï¼š
   - SqlSession å§”æ‰˜ SQL æ‰§è¡Œç»™ Executor
   - Executor è¿”å›æ‰§è¡Œç»“æœç»™ SqlSession

2. **Executor ä¸ StatementHandler**ï¼š
   - Executor å§”æ‰˜ SQL å¤„ç†ç»™ StatementHandler
   - StatementHandler å¤„ç†å…·ä½“çš„ SQL æ“ä½œ

3. **StatementHandler ä¸ ParameterHandler/ResultSetHandler**ï¼š
   - StatementHandler å§”æ‰˜å‚æ•°å¤„ç†ç»™ ParameterHandler
   - StatementHandler å§”æ‰˜ç»“æœå¤„ç†ç»™ ResultSetHandler

4. **æ‰€æœ‰ç»„ä»¶ä¸ Configuration**ï¼š
   - æ‰€æœ‰ç»„ä»¶éƒ½ä» Configuration è·å–é…ç½®ä¿¡æ¯
   - Configuration ç®¡ç†æ‰€æœ‰ç»„ä»¶çš„æ³¨å†Œ

## ğŸ¯ è®¾è®¡æ¨¡å¼åˆ†æ

### 1. ç­–ç•¥æ¨¡å¼

- **Executor ä½“ç³»**ï¼šä¸åŒçš„æ‰§è¡Œå™¨å®ç°ä¸åŒçš„æ‰§è¡Œç­–ç•¥
- **StatementHandler ä½“ç³»**ï¼šä¸åŒçš„å¤„ç†å™¨å¤„ç†ä¸åŒç±»å‹çš„ Statement

### 2. æ¨¡æ¿æ–¹æ³•æ¨¡å¼

- **BaseExecutor**ï¼šå®šä¹‰æ‰§è¡Œæµç¨‹çš„æ¨¡æ¿
- **BaseStatementHandler**ï¼šå®šä¹‰å¤„ç†æµç¨‹çš„æ¨¡æ¿

### 3. å·¥å‚æ¨¡å¼

- **SqlSessionFactory**ï¼šåˆ›å»º SqlSession å®ä¾‹
- **ObjectFactory**ï¼šåˆ›å»ºå¯¹è±¡å®ä¾‹

### 4. ä»£ç†æ¨¡å¼

- **MapperProxy**ï¼šä¸º Mapper æ¥å£åˆ›å»ºåŠ¨æ€ä»£ç†
- **Plugin**ï¼šä¸ºæ‹¦æˆªå™¨åˆ›å»ºåŠ¨æ€ä»£ç†

## ğŸ“Š å­¦ä¹ æ€»ç»“

### æ ¸å¿ƒç†è§£

1. **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„èŒè´£
2. **åä½œå…³ç³»**ï¼šç»„ä»¶é—´é€šè¿‡æ¥å£åä½œ
3. **è®¾è®¡æ¨¡å¼**ï¼šå¤§é‡ä½¿ç”¨è®¾è®¡æ¨¡å¼
4. **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡é…ç½®é©±åŠ¨æ•´ä¸ªç³»ç»Ÿ

### è®¾è®¡ä¼˜åŠ¿

1. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒåŠŸèƒ½æ‰©å±•
2. **å¯ç»´æŠ¤æ€§**ï¼šèŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
3. **å¯æµ‹è¯•æ€§**ï¼šç»„ä»¶ç‹¬ç«‹ï¼Œæ˜“äºæµ‹è¯•
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ”¯æŒç¼“å­˜å’Œä¼˜åŒ–ç­–ç•¥

### å­¦ä¹ æ”¶è·

1. **æ·±å…¥ç†è§£äº† MyBatis çš„æ¶æ„è®¾è®¡**
2. **æŒæ¡äº†ç»„ä»¶èŒè´£çš„åˆ†ææ–¹æ³•**
3. **å­¦ä¹ äº†è®¾è®¡æ¨¡å¼çš„åº”ç”¨**
4. **åŸ¹å…»äº†æ¶æ„æ€ç»´**

## ğŸ“ åç»­å­¦ä¹ è®¡åˆ’

1. **æ·±å…¥æºç **ï¼šåŸºäºèŒè´£ç†è§£æ·±å…¥å­¦ä¹ æºç 
2. **å®è·µåº”ç”¨**ï¼šå°†ç†è§£åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­
3. **æŒç»­æ”¹è¿›**ï¼šä¸æ–­å®Œå–„å¯¹æ¶æ„çš„ç†è§£

---

**åˆ†ææ—¶é—´**ï¼š[å¡«å†™æ—¶é—´]  
**å­¦ä¹ çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…  
**æŒæ¡ç¨‹åº¦**ï¼šâ­â­â­â­â­

