# ç¬¬3ç¯‡ï¼šSqlSessionçš„åˆ›å»ºä¸ç”Ÿå‘½å‘¨æœŸ

## 1. å­¦ä¹ ç›®æ ‡ç¡®è®¤

### 1.0 ç¬¬2ç¯‡æ€è€ƒé¢˜è§£ç­”

åœ¨æ·±å…¥å­¦ä¹ SqlSessionä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå›é¡¾å¹¶è§£ç­”ç¬¬2ç¯‡ä¸­æå‡ºçš„æ€è€ƒé¢˜ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£SqlSessionåœ¨æ•´ä¸ªæ¶æ„ä¸­çš„ä½œç”¨ã€‚

#### æ€è€ƒé¢˜1ï¼šä¸ºä»€ä¹ˆMyBatisè¦è®¾è®¡å¦‚æ­¤å¤æ‚çš„é…ç½®ç³»ç»Ÿï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**ï¼š

- **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰é…ç½®é¡¹é›†ä¸­ç®¡ç†ï¼Œé¿å…é…ç½®åˆ†æ•£å’Œé‡å¤
- **çµæ´»æ€§**ï¼šæ”¯æŒXMLã€æ³¨è§£ã€ä»£ç ä¸‰ç§é…ç½®æ–¹å¼ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚
- **å¯æ‰©å±•æ€§**ï¼šé€šè¿‡æ’ä»¶ç³»ç»Ÿå’Œè‡ªå®šä¹‰é…ç½®æ”¯æŒåŠŸèƒ½æ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé…ç½®ç¼“å­˜ã€æ‡’åŠ è½½ç­‰æœºåˆ¶æå‡æ€§èƒ½
- **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹é…ç½®å‡å°‘è¿è¡Œæ—¶é”™è¯¯

**SqlSessionçš„ä½œç”¨**ï¼šSqlSessionä½œä¸ºé…ç½®ç³»ç»Ÿçš„ä½¿ç”¨è€…ï¼Œé€šè¿‡Configurationè·å–æ‰€æœ‰å¿…è¦çš„é…ç½®ä¿¡æ¯ã€‚

#### æ€è€ƒé¢˜2ï¼šé…ç½®ç³»ç»Ÿçš„æ‰©å±•æ€§ä½“ç°åœ¨å“ªäº›æ–¹é¢ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**ï¼š

- **æ’ä»¶æ‰©å±•**ï¼šInterceptoræ¥å£æ”¯æŒåŠŸèƒ½æ‰©å±•
- **ç±»å‹å¤„ç†å™¨æ‰©å±•**ï¼šTypeHandleræ¥å£æ”¯æŒè‡ªå®šä¹‰ç±»å‹è½¬æ¢
- **å¯¹è±¡å·¥å‚æ‰©å±•**ï¼šObjectFactoryæ¥å£æ”¯æŒè‡ªå®šä¹‰å¯¹è±¡åˆ›å»º
- **æ•°æ®æºæ‰©å±•**ï¼šDataSourceæ¥å£æ”¯æŒè‡ªå®šä¹‰æ•°æ®æº
- **äº‹åŠ¡ç®¡ç†æ‰©å±•**ï¼šTransactionFactoryæ¥å£æ”¯æŒè‡ªå®šä¹‰äº‹åŠ¡ç®¡ç†

**SqlSessionçš„æ‰©å±•æ€§**ï¼šSqlSessioné€šè¿‡Executorã€StatementHandlerç­‰ç»„ä»¶å®ç°åŠŸèƒ½æ‰©å±•ã€‚

#### æ€è€ƒé¢˜3ï¼šå¦‚ä½•ä¼˜åŒ–é…ç½®è§£æçš„æ€§èƒ½ï¼Ÿ

**ç­”æ¡ˆè¦ç‚¹**ï¼š

- **ç¼“å­˜æœºåˆ¶**ï¼šè§£æåçš„é…ç½®å¯¹è±¡ç¼“å­˜ï¼Œé¿å…é‡å¤è§£æ
- **æ‡’åŠ è½½**ï¼šéå¿…éœ€é…ç½®å»¶è¿ŸåŠ è½½ï¼Œå‡å°‘å¯åŠ¨æ—¶é—´
- **æ‰¹é‡å¤„ç†**ï¼šç›¸å…³é…ç½®é¡¹æ‰¹é‡è§£æï¼Œæé«˜æ•ˆç‡
- **å†…å­˜ä¼˜åŒ–**ï¼šä¼˜åŒ–é…ç½®å¯¹è±¡çš„å†…å­˜ä½¿ç”¨ï¼Œå‡å°‘GCå‹åŠ›

**SqlSessionçš„æ€§èƒ½**ï¼šSqlSessioné€šè¿‡Executorç¼“å­˜ã€è¿æ¥æ± ç­‰æŠ€æœ¯ä¼˜åŒ–æ€§èƒ½ã€‚

#### æ€è€ƒé¢˜4ï¼šåŸºäºé…ç½®ç³»ç»Ÿçš„ç†è§£ï¼Œåº”è¯¥ä»å“ªä¸ªç»„ä»¶å¼€å§‹æ·±å…¥æºç åˆ†æï¼Ÿ

**æ¨èé¡ºåº**ï¼šSqlSession â†’ Executor â†’ StatementHandler â†’ ParameterHandler + ResultSetHandler

**ä»SqlSessionå¼€å§‹çš„åŸå› **ï¼š

- SqlSessionæ˜¯é…ç½®ç³»ç»Ÿçš„ç›´æ¥ä½¿ç”¨è€…
- ç†è§£SqlSessionæœ‰åŠ©äºç†è§£æ•´ä¸ªæ‰§è¡Œæµç¨‹
- ä¸ºåç»­å­¦ä¹ Executorç­‰ç»„ä»¶å¥ å®šåŸºç¡€

### 1.1 SqlSessionæ¦‚è¿°ï¼ˆåŸºäºMyBatis 3.5.xï¼‰

SqlSessionæ˜¯MyBatisçš„æ ¸å¿ƒæ¥å£ï¼Œä»£è¡¨ä¸æ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯ã€‚å®ƒæ˜¯MyBatisæ¶æ„ä¸­æ¥å£å±‚çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç®€æ´çš„APIæ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œã€‚

**SqlSessionçš„æ ¸å¿ƒèŒè´£**ï¼š

1. **æ•°æ®åº“æ“ä½œ**ï¼šæä¾›CRUDæ“ä½œçš„ç»Ÿä¸€æ¥å£
2. **äº‹åŠ¡ç®¡ç†**ï¼šç®¡ç†æ•°æ®åº“äº‹åŠ¡çš„æäº¤å’Œå›æ»š
3. **Mapperç®¡ç†**ï¼šè·å–Mapperæ¥å£çš„åŠ¨æ€ä»£ç†å¯¹è±¡
4. **ä¼šè¯ç®¡ç†**ï¼šç®¡ç†ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸå’Œèµ„æºé‡Šæ”¾

**é‡è¦æç¤º**ï¼šç†è§£SqlSessionçš„è®¾è®¡å’Œå®ç°æ˜¯æ·±å…¥MyBatisæºç çš„å…³é”®ï¼Œåç»­çš„Executorã€StatementHandlerç­‰ç»„ä»¶éƒ½å›´ç»•SqlSessionå±•å¼€ã€‚

## 2. SqlSessionæ¥å£è®¾è®¡åˆ†æ

### 2.1 SqlSessionæ¥å£ç»“æ„

è®©æˆ‘ä»¬æ·±å…¥åˆ†æSqlSessionæ¥å£çš„è®¾è®¡ï¼š

```java
package org.apache.ibatis.session;

import java.io.Closeable;
import java.sql.Connection;
import java.util.List;
import java.util.Map;
import org.apache.ibatis.cursor.Cursor;
import org.apache.ibatis.executor.BatchResult;
import org.apache.ibatis.executor.result.ResultHandler;

public interface SqlSession extends Closeable {
    // æŸ¥è¯¢æ“ä½œ
    <T> T selectOne(String statement);
    <T> T selectOne(String statement, Object parameter);
    <E> List<E> selectList(String statement);
    <E> List<E> selectList(String statement, Object parameter);
    <E> List<E> selectList(String statement, Object parameter, RowBounds rowBounds);
  
    // MapæŸ¥è¯¢æ“ä½œ
    <K, V> Map<K, V> selectMap(String statement, String mapKey);
    <K, V> Map<K, V> selectMap(String statement, Object parameter, String mapKey);
    <K, V> Map<K, V> selectMap(String statement, Object parameter, String mapKey, RowBounds rowBounds);
  
    // æ¸¸æ ‡æŸ¥è¯¢
    <T> Cursor<T> selectCursor(String statement);
    <T> Cursor<T> selectCursor(String statement, Object parameter);
    <T> Cursor<T> selectCursor(String statement, Object parameter, RowBounds rowBounds);
  
    // è‡ªå®šä¹‰ç»“æœå¤„ç†ï¼ˆæµå¼ç»“æœï¼‰
    void select(String statement, Object parameter, ResultHandler handler);
    void select(String statement, ResultHandler handler);
    void select(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler);
  
    // æ›´æ–°æ“ä½œ
    int insert(String statement);
    int insert(String statement, Object parameter);
    int update(String statement);
    int update(String statement, Object parameter);
    int delete(String statement);
    int delete(String statement, Object parameter);
  
    // äº‹åŠ¡ç®¡ç†
    void commit();
    void commit(boolean force);
    void rollback();
    void rollback(boolean force);
  
    // æ‰¹é‡æ“ä½œ
    List<BatchResult> flushStatements();
  
    // Mapperè·å–
    <T> T getMapper(Class<T> type);
  
    // è¿æ¥ç®¡ç†
    Connection getConnection();
  
    // é…ç½®è·å–
    Configuration getConfiguration();
  
    // ç¼“å­˜ç®¡ç†
    void clearCache();
}
```

### 2.2 æ¥å£è®¾è®¡ç‰¹ç‚¹åˆ†æ

#### 2.2.1 æ³›å‹è®¾è®¡

```java
// æ³›å‹è®¾è®¡æä¾›äº†ç±»å‹å®‰å…¨
<T> T selectOne(String statement, Object parameter);
<E> List<E> selectList(String statement, Object parameter);
```

**ä¼˜åŠ¿**ï¼š

- **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œé¿å…è¿è¡Œæ—¶ç±»å‹è½¬æ¢é”™è¯¯
- **ä»£ç ç®€æ´**ï¼šæ— éœ€æ‰‹åŠ¨ç±»å‹è½¬æ¢
- **IDEæ”¯æŒ**ï¼šæ›´å¥½çš„ä»£ç æç¤ºå’Œé‡æ„æ”¯æŒ

#### 2.2.2 ResultHandlerè‡ªå®šä¹‰ç»“æœå¤„ç†

```java
// æ”¯æŒè‡ªå®šä¹‰ç»“æœå¤„ç†ï¼Œé€‚ç”¨äºæµå¼ç»“æœå¤„ç†
void select(String statement, Object parameter, ResultHandler handler);
void select(String statement, ResultHandler handler);
void select(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler);
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- **æµå¼å¤„ç†**ï¼šå¤„ç†å¤§é‡æ•°æ®æ—¶é¿å…å†…å­˜æº¢å‡º
- **è‡ªå®šä¹‰è½¬æ¢**ï¼šå¯¹ç»“æœè¿›è¡Œè‡ªå®šä¹‰å¤„ç†
- **å®æ—¶å¤„ç†**ï¼šè¾¹æŸ¥è¯¢è¾¹å¤„ç†ç»“æœ

**ç¤ºä¾‹ç”¨æ³•**ï¼š

```java
// æµå¼å¤„ç†å¤§é‡æ•°æ®
session.select("selectAllUsers", null, new ResultHandler<User>() {
    @Override
    public void handleResult(ResultContext<? extends User> resultContext) {
        User user = resultContext.getResultObject();
        // å®æ—¶å¤„ç†æ¯ä¸ªç”¨æˆ·æ•°æ®
        processUser(user);
    }
});
```

#### 2.2.3 æ–¹æ³•é‡è½½è®¾è®¡

```java
// æ”¯æŒä¸åŒå‚æ•°ç»„åˆ
<T> T selectOne(String statement);
<T> T selectOne(String statement, Object parameter);
<E> List<E> selectList(String statement, Object parameter);
<E> List<E> selectList(String statement, Object parameter, RowBounds rowBounds);
```

**ä¼˜åŠ¿**ï¼š

- **ä½¿ç”¨çµæ´»**ï¼šæ”¯æŒä¸åŒä½¿ç”¨åœºæ™¯
- **å‘åå…¼å®¹**ï¼šä¿æŒAPIçš„å‘åå…¼å®¹æ€§
- **æ¸è¿›å¼å­¦ä¹ **ï¼šä»ç®€å•åˆ°å¤æ‚çš„ä½¿ç”¨æ–¹å¼

#### 2.2.4 èµ„æºç®¡ç†è®¾è®¡

```java
public interface SqlSession extends Closeable {
    // ç»§æ‰¿Closeableæ¥å£ï¼Œæ”¯æŒtry-with-resourcesè¯­æ³•
}
```

**ä¼˜åŠ¿**ï¼š

- **è‡ªåŠ¨èµ„æºç®¡ç†**ï¼šæ”¯æŒtry-with-resourcesè¯­æ³•
- **é˜²æ­¢èµ„æºæ³„æ¼**ï¼šç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
- **ä»£ç ç®€æ´**ï¼šå‡å°‘æ ·æ¿ä»£ç 

## 3. SqlSessionFactoryå·¥å‚æ¨¡å¼åˆ†æ

### 3.1 SqlSessionFactoryæ¥å£è®¾è®¡

SqlSessionFactoryæ˜¯åˆ›å»ºSqlSessionçš„å·¥å‚æ¥å£ï¼Œé‡‡ç”¨å·¥å‚æ¨¡å¼è®¾è®¡ï¼š

```java
package org.apache.ibatis.session;

import java.sql.Connection;

public interface SqlSessionFactory {
    // åŸºæœ¬åˆ›å»ºæ–¹æ³•
    SqlSession openSession();
    SqlSession openSession(boolean autoCommit);
    SqlSession openSession(Connection connection);
  
    // æ‰§è¡Œå™¨ç±»å‹æŒ‡å®š
    SqlSession openSession(ExecutorType execType);
    SqlSession openSession(ExecutorType execType, boolean autoCommit);
    SqlSession openSession(ExecutorType execType, TransactionIsolationLevel level);
    SqlSession openSession(ExecutorType execType, Connection connection);
  
    // äº‹åŠ¡éš”ç¦»çº§åˆ«æŒ‡å®š
    SqlSession openSession(TransactionIsolationLevel level);
  
    // é…ç½®è·å–
    Configuration getConfiguration();
}
```

### 3.2 DefaultSqlSessionFactoryå®ç°åˆ†æ

DefaultSqlSessionFactoryæ˜¯SqlSessionFactoryçš„é»˜è®¤å®ç°ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ†æå…¶æºç ï¼š

```java
package org.apache.ibatis.session.defaults;

import org.apache.ibatis.executor.Executor;
import org.apache.ibatis.session.Configuration;
import org.apache.ibatis.session.ExecutorType;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.TransactionIsolationLevel;
import org.apache.ibatis.transaction.Transaction;
import org.apache.ibatis.transaction.TransactionFactory;
import org.apache.ibatis.transaction.managed.ManagedTransactionFactory;
import org.apache.ibatis.mapping.Environment;
import org.apache.ibatis.exceptions.ExceptionFactory;
import org.apache.ibatis.executor.ErrorContext;

public class DefaultSqlSessionFactory implements SqlSessionFactory {
    private final Configuration configuration;
  
    public DefaultSqlSessionFactory(Configuration configuration) {
        this.configuration = configuration;
    }
  
    @Override
    public SqlSession openSession() {
        return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);
    }
  
    @Override
    public SqlSession openSession(boolean autoCommit) {
        return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, autoCommit);
    }
  
    @Override
    public SqlSession openSession(ExecutorType execType) {
        return openSessionFromDataSource(execType, null, false);
    }
  
    // æ ¸å¿ƒåˆ›å»ºæ–¹æ³•
    private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
        Transaction tx = null;
        try {
            // 1. è·å–ç¯å¢ƒé…ç½®
            final Environment environment = configuration.getEnvironment();
        
            // 2. è·å–äº‹åŠ¡å·¥å‚
            final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);
        
            // 3. åˆ›å»ºäº‹åŠ¡
            tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
        
            // 4. åˆ›å»ºæ‰§è¡Œå™¨
            final Executor executor = configuration.newExecutor(tx, execType);
        
            // 5. åˆ›å»ºSqlSession
            return createSqlSession(configuration, executor, autoCommit);
        } catch (Exception e) {
            closeTransaction(tx);
            throw ExceptionFactory.wrapException("Error opening session.  Cause: " + e, e);
        } finally {
            ErrorContext.instance().reset();
        }
    }
  
    protected SqlSession createSqlSession(Configuration configuration, Executor executor, boolean autoCommit) {
        return new DefaultSqlSession(configuration, executor, autoCommit);
    }
}
```

### 3.3 å·¥å‚æ¨¡å¼çš„ä¼˜åŠ¿

#### 3.3.1 å°è£…å¤æ‚æ€§

```java
// ç”¨æˆ·åªéœ€è¦è°ƒç”¨ç®€å•çš„æ–¹æ³•
SqlSession session = sqlSessionFactory.openSession();

// å†…éƒ¨å¤æ‚çš„åˆ›å»ºè¿‡ç¨‹è¢«å°è£…
// 1. ç¯å¢ƒé…ç½®è·å–
// 2. äº‹åŠ¡å·¥å‚åˆ›å»º
// 3. äº‹åŠ¡å¯¹è±¡åˆ›å»º
// 4. æ‰§è¡Œå™¨åˆ›å»º
// 5. SqlSessionåˆ›å»º
```

#### 3.3.2 å‚æ•°çµæ´»æ€§

```java
// æ”¯æŒå¤šç§å‚æ•°ç»„åˆ
SqlSession session1 = sqlSessionFactory.openSession(); // é»˜è®¤é…ç½®
SqlSession session2 = sqlSessionFactory.openSession(true); // è‡ªåŠ¨æäº¤
SqlSession session3 = sqlSessionFactory.openSession(ExecutorType.BATCH); // æ‰¹å¤„ç†æ‰§è¡Œå™¨
```

#### 3.3.3 é…ç½®é©±åŠ¨

```java
// åŸºäºConfigurationé…ç½®åˆ›å»ºSqlSession
final Executor executor = configuration.newExecutor(tx, execType);
```

## 4. SqlSessionç”Ÿå‘½å‘¨æœŸç®¡ç†

### 4.1 ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ

SqlSessionçš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

```mermaid
graph TD
    A["ğŸ”„ åˆ›å»ºé˜¶æ®µ"] -->|openSession| B["âš¡ ä½¿ç”¨é˜¶æ®µ"]
    B -->|commit/rollback| C["ğŸ”’ äº‹åŠ¡ç®¡ç†é˜¶æ®µ"]
    C -->|close| D["ğŸ§¹ èµ„æºé‡Šæ”¾é˜¶æ®µ"]
  
    A1["ğŸ“‹ è·å–é…ç½®"] -->|Environment| A2["ğŸ—ï¸ åˆ›å»ºäº‹åŠ¡"]
    A2 -->|Transaction| A3["âš™ï¸ åˆ›å»ºæ‰§è¡Œå™¨"]
    A3 -->|Executor| A4["ğŸ¯ åˆ›å»ºSqlSession"]
  
    B1["ğŸ’¾ æ‰§è¡ŒSQL"] -->|select/update| B2["ğŸ“Š ç»“æœå¤„ç†"]
    B2 -->|getMapper| B3["ğŸ”— Mapperè°ƒç”¨"]
  
    C1["ğŸš€ äº‹åŠ¡å¼€å§‹"] -->|æ“ä½œå®Œæˆ| C2["âœ… æäº¤/å›æ»š"]
    C2 -->|ç»“æŸäº‹åŠ¡| C3["ğŸ äº‹åŠ¡ç»“æŸ"]
  
    D1["ğŸ”§ å…³é—­æ‰§è¡Œå™¨"] -->|executor.close| D2["ğŸ” å…³é—­äº‹åŠ¡"]
    D2 -->|tx.close| D3["ğŸ”Œ å…³é—­è¿æ¥"]
    D3 -->|clearCache| D4["ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜"]
  
    classDef createPhase fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef usePhase fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef transactionPhase fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef releasePhase fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
  
    class A,A1,A2,A3,A4 createPhase
    class B,B1,B2,B3 usePhase
    class C,C1,C2,C3 transactionPhase
    class D,D1,D2,D3,D4 releasePhase
```

### 4.2 åˆ›å»ºé˜¶æ®µè¯¦ç»†åˆ†æ

#### 4.2.1 é…ç½®è·å–

```java
// ä»Configurationè·å–ç¯å¢ƒé…ç½®
final Environment environment = configuration.getEnvironment();
```

**EnvironmentåŒ…å«**ï¼š

- **DataSource**ï¼šæ•°æ®æºé…ç½®
- **TransactionFactory**ï¼šäº‹åŠ¡å·¥å‚é…ç½®
- **Id**ï¼šç¯å¢ƒæ ‡è¯†

#### 4.2.2 äº‹åŠ¡åˆ›å»º

```java
// åˆ›å»ºäº‹åŠ¡å¯¹è±¡
final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);
tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
```

**äº‹åŠ¡åˆ›å»ºè¿‡ç¨‹**ï¼š

1. **è·å–äº‹åŠ¡å·¥å‚**ï¼šä»ç¯å¢ƒé…ç½®è·å–TransactionFactory
2. **åˆ›å»ºäº‹åŠ¡å¯¹è±¡**ï¼šä½¿ç”¨DataSourceå’Œå‚æ•°åˆ›å»ºTransaction
3. **è®¾ç½®äº‹åŠ¡å±æ€§**ï¼šéš”ç¦»çº§åˆ«ã€è‡ªåŠ¨æäº¤ç­‰

#### 4.2.3 æ‰§è¡Œå™¨åˆ›å»º

```java
// åˆ›å»ºæ‰§è¡Œå™¨
final Executor executor = configuration.newExecutor(tx, execType);
```

**æ‰§è¡Œå™¨åˆ›å»ºè¿‡ç¨‹**ï¼š

1. **æ‰§è¡Œå™¨ç±»å‹é€‰æ‹©**ï¼šæ ¹æ®ExecutorTypeé€‰æ‹©å…·ä½“å®ç°
2. **ç¼“å­˜åŒ…è£…**ï¼šå¦‚æœå¯ç”¨ç¼“å­˜ï¼Œç”¨CachingExecutoråŒ…è£…
3. **æ’ä»¶åº”ç”¨**ï¼šåº”ç”¨æ‰€æœ‰é…ç½®çš„æ’ä»¶

#### 4.2.4 SqlSessionåˆ›å»º

```java
// åˆ›å»ºSqlSessionå¯¹è±¡
return new DefaultSqlSession(configuration, executor, autoCommit);
```

### 4.3 ä½¿ç”¨é˜¶æ®µåˆ†æ

#### 4.3.1 SQLæ‰§è¡Œæµç¨‹

```java
// ç”¨æˆ·è°ƒç”¨
User user = session.selectOne("selectUser", 1);

// å†…éƒ¨æ‰§è¡Œæµç¨‹
public <T> T selectOne(String statement, Object parameter) {
    List<T> list = this.selectList(statement, parameter);
    if (list.size() == 1) {
        return list.get(0);
    }
    if (list.size() > 1) {
        throw new TooManyResultsException("Expected one result...");
    } else {
        return null;
    }
}
```

#### 4.3.2 Mapperè·å–æµç¨‹

```java
// ç”¨æˆ·è°ƒç”¨
UserMapper mapper = session.getMapper(UserMapper.class);

// å†…éƒ¨å®ç°
@Override
public <T> T getMapper(Class<T> type) {
    return configuration.getMapper(type, this);
}
```

### 4.4 èµ„æºé‡Šæ”¾é˜¶æ®µ

#### 4.4.1 æ‰‹åŠ¨å…³é—­

```java
// æ‰‹åŠ¨å…³é—­SqlSession
session.close();

// å†…éƒ¨å…³é—­æµç¨‹
@Override
public void close() {
    try {
        executor.close(isCommitOrRollbackRequired(false));
    } catch (SQLException e) {
        throw ExceptionFactory.wrapException("Error closing SqlSession.  Cause: " + e, e);
    } finally {
        // æ¸…ç†èµ„æº
        dirty = false;
        executor = null;
        configuration = null;
    }
}
```

#### 4.4.2 è‡ªåŠ¨å…³é—­

```java
// ä½¿ç”¨try-with-resourcesè¯­æ³•
try (SqlSession session = sqlSessionFactory.openSession()) {
    User user = session.selectOne("selectUser", 1);
    // è‡ªåŠ¨å…³é—­
}
```

## 5. DefaultSqlSessionå®ç°åˆ†æ

### 5.1 DefaultSqlSessionç±»ç»“æ„

```java
public class DefaultSqlSession implements SqlSession {
    private final Configuration configuration;
    private final Executor executor;
    private final boolean autoCommit;
    private boolean dirty;
    private List<Cursor<?>> cursorList;
  
    public DefaultSqlSession(Configuration configuration, Executor executor, boolean autoCommit) {
        this.configuration = configuration;
        this.executor = executor;
        this.dirty = false;
        this.autoCommit = autoCommit;
    }
}
```

### 5.2 æ ¸å¿ƒæ–¹æ³•å®ç°åˆ†æ

#### 5.2.1 selectOneæ–¹æ³•å®ç°

```java
@Override
public <T> T selectOne(String statement, Object parameter) {
    // è°ƒç”¨selectListè·å–ç»“æœ
    List<T> list = this.selectList(statement, parameter);
  
    // ç»“æœæ•°é‡éªŒè¯
    if (list.size() == 1) {
        return list.get(0);
    }
    if (list.size() > 1) {
        throw new TooManyResultsException(
            "Expected one result (or null) to be returned by selectOne(), but found: " + list.size());
    } else {
        return null;
    }
}
```

**è®¾è®¡äº®ç‚¹**ï¼š

- **å¤ç”¨selectList**ï¼šé¿å…ä»£ç é‡å¤
- **ç»“æœéªŒè¯**ï¼šç¡®ä¿è¿”å›å•ä¸ªç»“æœ
- **å¼‚å¸¸å¤„ç†**ï¼šç»“æœè¿‡å¤šæ—¶æŠ›å‡ºå¼‚å¸¸

#### 5.2.2 selectListæ–¹æ³•å®ç°

```java
@Override
public <E> List<E> selectList(String statement, Object parameter, RowBounds rowBounds) {
    try {
        // 1. è·å–MappedStatement
        MappedStatement ms = configuration.getMappedStatement(statement);
    
        // 2. å§”æ‰˜ç»™Executoræ‰§è¡Œ
        return executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);
    } catch (Exception e) {
        throw ExceptionFactory.wrapException("Error querying database.  Cause: " + e, e);
    } finally {
        ErrorContext.instance().reset();
    }
}
```

**æ‰§è¡Œæµç¨‹**ï¼š

1. **è·å–æ˜ å°„è¯­å¥**ï¼šä»Configurationè·å–MappedStatement
2. **å‚æ•°åŒ…è£…**ï¼šå¤„ç†é›†åˆå‚æ•°
3. **å§”æ‰˜æ‰§è¡Œ**ï¼šå§”æ‰˜ç»™Executoræ‰§è¡ŒæŸ¥è¯¢
4. **å¼‚å¸¸å¤„ç†**ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†
5. **èµ„æºæ¸…ç†**ï¼šé‡ç½®é”™è¯¯ä¸Šä¸‹æ–‡

#### 5.2.3 updateæ–¹æ³•å®ç°

```java
@Override
public int update(String statement, Object parameter) {
    try {
        // 1. æ ‡è®°ä¸ºè„æ•°æ®
        dirty = true;
    
        // 2. è·å–MappedStatement
        MappedStatement ms = configuration.getMappedStatement(statement);
    
        // 3. å§”æ‰˜ç»™Executoræ‰§è¡Œ
        return executor.update(ms, wrapCollection(parameter));
    } catch (Exception e) {
        throw ExceptionFactory.wrapException("Error updating database.  Cause: " + e, e);
    } finally {
        ErrorContext.instance().reset();
    }
}
```

**è®¾è®¡ç‰¹ç‚¹**ï¼š

- **è„æ•°æ®æ ‡è®°**ï¼šæ ‡è®°SqlSessionä¸ºè„çŠ¶æ€
- **ç»Ÿä¸€å¤„ç†**ï¼šinsertã€updateã€deleteéƒ½ä½¿ç”¨ç›¸åŒé€»è¾‘

#### 5.2.4 äº‹åŠ¡ç®¡ç†æ–¹æ³•

```java
@Override
public void commit() {
    commit(false);
}

@Override
public void commit(boolean force) {
    try {
        executor.commit(isCommitOrRollbackRequired(force));
        dirty = false;
    } catch (Exception e) {
        throw ExceptionFactory.wrapException("Error committing transaction.  Cause: " + e, e);
    } finally {
        ErrorContext.instance().reset();
    }
}

@Override
public void rollback() {
    rollback(false);
}

@Override
public void rollback(boolean force) {
    try {
        executor.rollback(isCommitOrRollbackRequired(force));
        dirty = false;
    } catch (Exception e) {
        throw ExceptionFactory.wrapException("Error rolling back transaction.  Cause: " + e, e);
    } finally {
        ErrorContext.instance().reset();
    }
}
```

**äº‹åŠ¡ç®¡ç†ç‰¹ç‚¹**ï¼š

- **æ¡ä»¶æäº¤**ï¼šæ ¹æ®dirtyçŠ¶æ€å†³å®šæ˜¯å¦éœ€è¦æäº¤
- **å¼ºåˆ¶é€‰é¡¹**ï¼šæ”¯æŒå¼ºåˆ¶æäº¤/å›æ»š
- **çŠ¶æ€é‡ç½®**ï¼šæäº¤/å›æ»šåé‡ç½®dirtyçŠ¶æ€

## 6. Executoræ‰§è¡Œå™¨ä½“ç³»åˆ†æ

### 6.1 Executoræ¥å£è®¾è®¡

Executoræ˜¯MyBatisæ‰§è¡Œå™¨çš„æ ¸å¿ƒæ¥å£ï¼Œå…¶ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š

```mermaid
classDiagram
    class Executor {
        <<interface>>
        +update()
        +query()
        +queryCursor()
        +flushStatements()
        +commit()
        +rollback()
        +createCacheKey()
        +clearLocalCache()
    }
    class BaseExecutor {
        <<abstract>>
        #doQuery()
        #doUpdate()
        #doFlushStatements()
    }
    class SimpleExecutor {
        +doQuery()
        +doUpdate()
    }
    class ReuseExecutor {
        +doQuery()
        +doUpdate()
        -Map~String,Statement~ statementMap
    }
    class BatchExecutor {
        +doQuery()
        +doUpdate()
        -List~Statement~ statementList
        -List~BatchResult~ batchResultList
    }
    class CachingExecutor {
        +query()
        +update()
        -Executor delegate
        -TransactionalCacheManager tcm
    }
    Executor <|.. BaseExecutor
    BaseExecutor <|-- SimpleExecutor
    BaseExecutor <|-- ReuseExecutor
    BaseExecutor <|-- BatchExecutor
    Executor <|.. CachingExecutor
```

Executoræ˜¯MyBatisæ‰§è¡Œå™¨çš„æ ¸å¿ƒæ¥å£ï¼š

```java
public interface Executor {
    // æŸ¥è¯¢æ“ä½œ
    <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException;
    <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql) throws SQLException;
    <E> Cursor<E> queryCursor(MappedStatement ms, Object parameter, RowBounds rowBounds) throws SQLException;
  
    // æ›´æ–°æ“ä½œ
    int update(MappedStatement ms, Object parameter) throws SQLException;
  
    // äº‹åŠ¡ç®¡ç†
    void commit(boolean required) throws SQLException;
    void rollback(boolean required) throws SQLException;
  
    // ç¼“å­˜ç®¡ç†
    CacheKey createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql);
    boolean isCached(MappedStatement ms, CacheKey key);
    void clearLocalCache();
  
    // å»¶è¿ŸåŠ è½½
    void deferLoad(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class<?> targetType);
  
    // æ‰¹é‡æ“ä½œ
    List<BatchResult> flushStatements() throws SQLException;
  
    // èµ„æºç®¡ç†
    Transaction getTransaction();
    void close(boolean forceRollback);
    boolean isClosed();
}
```

### 6.2 BaseExecutoræŠ½è±¡åŸºç±»

BaseExecutoræ˜¯Executorçš„æŠ½è±¡åŸºç±»ï¼Œå®ç°äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼š

```java
public abstract class BaseExecutor implements Executor {
    protected Transaction transaction;
    protected Executor wrapper;
    protected PerpetualCache localCache;
    protected PerpetualCache localOutputParameterCache;
    protected Configuration configuration;
    protected int queryStack;
    private boolean closed;
  
    // æ¨¡æ¿æ–¹æ³•ï¼šæŸ¥è¯¢æ“ä½œ
    @Override
    public <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException {
        BoundSql boundSql = ms.getBoundSql(parameter);
        CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);
        return query(ms, parameter, rowBounds, resultHandler, key, boundSql);
    }
  
    @Override
    public <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql) throws SQLException {
        ErrorContext.instance().resource(ms.getResource()).activity("executing a query").object(ms.getId());
        if (closed) {
            throw new ExecutorException("Executor was closed.");
        }
        if (queryStack == 0 && ms.isFlushCacheRequired()) {
            clearLocalCache();
        }
        List<E> list;
        try {
            queryStack++;
            list = resultHandler == null ? (List<E>) localCache.getObject(cacheKey) : null;
            if (list != null) {
                handleLocallyCachedOutputParameters(ms, cacheKey, parameter, boundSql);
            } else {
                list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, cacheKey, boundSql);
            }
        } finally {
            queryStack--;
        }
        if (queryStack == 0) {
            for (DeferredLoad deferredLoad : deferredLoads) {
                deferredLoad.load();
            }
            deferredLoads.clear();
            if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
                clearLocalCache();
            }
        }
        return list;
    }
  
    // æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å®ç°å…·ä½“çš„æ•°æ®åº“æŸ¥è¯¢
    protected abstract <E> List<E> doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException;
  
    // æ¨¡æ¿æ–¹æ³•ï¼šæ›´æ–°æ“ä½œ
    @Override
    public int update(MappedStatement ms, Object parameter) throws SQLException {
        ErrorContext.instance().resource(ms.getResource()).activity("executing an update").object(ms.getId());
        if (closed) {
            throw new ExecutorException("Executor was closed.");
        }
        clearLocalCache();
        return doUpdate(ms, parameter);
    }
  
    // æŠ½è±¡æ–¹æ³•ï¼šå­ç±»å®ç°å…·ä½“çš„æ•°æ®åº“æ›´æ–°
    protected abstract int doUpdate(MappedStatement ms, Object parameter) throws SQLException;
}
```

### 6.3 å…·ä½“æ‰§è¡Œå™¨å®ç°

#### 6.3.1 SimpleExecutor

```java
public class SimpleExecutor extends BaseExecutor {
  
    public SimpleExecutor(Configuration configuration, Transaction transaction) {
        super(configuration, transaction);
    }
  
    @Override
    public <E> List<E> doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException {
        Statement stmt = null;
        try {
            Configuration configuration = ms.getConfiguration();
            StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
            stmt = prepareStatement(handler, ms.getStatementLog());
            return handler.query(stmt, resultHandler);
        } finally {
            closeStatement(stmt);
        }
    }
  
    @Override
    public int doUpdate(MappedStatement ms, Object parameter) throws SQLException {
        Statement stmt = null;
        try {
            Configuration configuration = ms.getConfiguration();
            StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);
            stmt = prepareStatement(handler, ms.getStatementLog());
            return handler.update(stmt);
        } finally {
            closeStatement(stmt);
        }
    }
  
    private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException {
        Statement stmt;
        Connection connection = getConnection(statementLog);
        stmt = handler.prepare(connection, transaction.getTimeout());
        handler.parameterize(stmt);
        return stmt;
    }
}
```

**ç‰¹ç‚¹**ï¼š

- **ç®€å•å®ç°**ï¼šæ¯æ¬¡æ‰§è¡Œéƒ½åˆ›å»ºæ–°çš„Statement
- **èµ„æºç®¡ç†**ï¼šåŠæ—¶å…³é—­Statementå’ŒConnection
- **æ€§èƒ½è€ƒè™‘**ï¼šé€‚åˆå•æ¬¡æ‰§è¡Œåœºæ™¯

#### 6.3.2 ReuseExecutor

```java
public class ReuseExecutor extends BaseExecutor {
    private final Map<String, Statement> statementMap = new HashMap<>();
  
    @Override
    public <E> List<E> doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException {
        Configuration configuration = ms.getConfiguration();
        StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
        Statement stmt = prepareStatement(handler, ms.getStatementLog());
        return handler.query(stmt, resultHandler);
    }
  
    private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException {
        Statement stmt;
        BoundSql boundSql = handler.getBoundSql();
        String sql = boundSql.getSql();
        if (hasStatementFor(sql)) {
            stmt = getStatement(sql);
            applyTransactionTimeout(stmt);
        } else {
            Connection connection = getConnection(statementLog);
            stmt = handler.prepare(connection, transaction.getTimeout());
            putStatement(sql, stmt);
        }
        handler.parameterize(stmt);
        return stmt;
    }
  
    private boolean hasStatementFor(String sql) {
        return statementMap.containsKey(sql);
    }
  
    private Statement getStatement(String sql) {
        return statementMap.get(sql);
    }
  
    private void putStatement(String sql, Statement stmt) {
        statementMap.put(sql, stmt);
    }
}
```

**ç‰¹ç‚¹**ï¼š

- **Statementé‡ç”¨**ï¼šç›¸åŒSQLé‡ç”¨Statementå¯¹è±¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘Statementåˆ›å»ºå¼€é”€
- **å†…å­˜ç®¡ç†**ï¼šéœ€è¦ç®¡ç†Statementç¼“å­˜

#### 6.3.3 BatchExecutor

```java
public class BatchExecutor extends BaseExecutor {
    private final List<Statement> statementList = new ArrayList<>();
    private final List<BatchResult> batchResultList = new ArrayList<>();
    private String currentSql;
    private MappedStatement currentStatement;
  
    @Override
    public int doUpdate(MappedStatement ms, Object parameter) throws SQLException {
        final Configuration configuration = ms.getConfiguration();
        final StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);
        final BoundSql boundSql = handler.getBoundSql();
        final String sql = boundSql.getSql();
        final StatementType statementType = ms.getStatementType();
    
        if (sql.equals(currentSql) && statementType == currentStatement.getStatementType()) {
            // ç›¸åŒSQLï¼Œé‡ç”¨Statement
            final Statement stmt = statementList.get(statementList.size() - 1);
            applyTransactionTimeout(stmt);
            handler.parameterize(stmt);
            BatchResult batchResult = batchResultList.get(batchResultList.size() - 1);
            batchResult.addParameterObject(parameter);
            return BATCH_UPDATE_RETURN_VALUE;
        } else {
            // ä¸åŒSQLï¼Œåˆ›å»ºæ–°Statement
            final Statement stmt;
            if (sql.equals(currentSql) && ms.getStatementType() == currentStatement.getStatementType()) {
                int last = statementList.size() - 1;
                stmt = statementList.get(last);
                applyTransactionTimeout(stmt);
                handler.parameterize(stmt);
                BatchResult batchResult = batchResultList.get(last);
                batchResult.addParameterObject(parameter);
            } else {
                Connection connection = getConnection(ms.getStatementLog());
                stmt = handler.prepare(connection, transaction.getTimeout());
                handler.parameterize(stmt);
                currentSql = sql;
                currentStatement = ms;
                statementList.add(stmt);
                batchResultList.add(new BatchResult(ms, sql, parameter));
            }
            handler.batch(stmt);
            return BATCH_UPDATE_RETURN_VALUE;
        }
    }
}
```

**ç‰¹ç‚¹**ï¼š

- **æ‰¹é‡æ‰§è¡Œ**ï¼šæ”¶é›†å¤šä¸ªSQLè¯­å¥æ‰¹é‡æ‰§è¡Œ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
- **ç»“æœç®¡ç†**ï¼šç®¡ç†æ‰¹é‡æ‰§è¡Œçš„ç»“æœ

### 6.4 CachingExecutorç¼“å­˜è£…é¥°å™¨

```java
public class CachingExecutor implements Executor {
    private final Executor delegate;
    private final TransactionalCacheManager tcm = new TransactionalCacheManager();
  
    public CachingExecutor(Executor delegate) {
        this.delegate = delegate;
        delegate.setExecutorWrapper(this);
    }
  
    @Override
    public <E> List<E> query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        Cache cache = ms.getCache();
        if (cache != null) {
            flushCacheIfRequired(ms);
            if (ms.isUseCache() && resultHandler == null) {
                ensureNoOutParams(ms, boundSql);
                @SuppressWarnings("unchecked")
                List<E> list = (List<E>) tcm.getObject(cache, key);
                if (list == null) {
                    list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
                    tcm.putObject(cache, key, list);
                }
                return list;
            }
        }
        return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }
  
    @Override
    public int update(MappedStatement ms, Object parameterObject) throws SQLException {
        flushCacheIfRequired(ms);
        return delegate.update(ms, parameterObject);
    }
  
    private void flushCacheIfRequired(MappedStatement ms) {
        Cache cache = ms.getCache();
        if (cache != null && ms.isFlushCacheRequired()) {
            tcm.clear(cache);
        }
    }
}
```

**ç‰¹ç‚¹**ï¼š

- **è£…é¥°å™¨æ¨¡å¼**ï¼šåŒ…è£…å…¶ä»–æ‰§è¡Œå™¨ï¼Œæ·»åŠ ç¼“å­˜åŠŸèƒ½
- **äºŒçº§ç¼“å­˜**ï¼šæ”¯æŒè·¨SqlSessionçš„ç¼“å­˜
- **ç¼“å­˜ç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç†ç¼“å­˜çš„åˆ·æ–°å’Œæ¸…ç†

### 6.4 Executorç±»å‹æ€»ç»“

| æ‰§è¡Œå™¨ç±»å‹                | ç‰¹ç‚¹                    | é€‚ç”¨åœºæ™¯             | æ€§èƒ½ç‰¹ç‚¹                 |
| ------------------------- | ----------------------- | -------------------- | ------------------------ |
| **SimpleExecutor**  | æ¯æ¬¡æ‰§è¡Œåˆ›å»ºæ–°Statement | å•æ¬¡æ‰§è¡Œã€ç®€å•æŸ¥è¯¢   | ç®€å•ç›´æ¥ï¼Œé€‚åˆè½»é‡çº§æ“ä½œ |
| **ReuseExecutor**   | é‡ç”¨ç›¸åŒSQLçš„Statement  | é‡å¤æ‰§è¡Œç›¸åŒSQL      | å‡å°‘Statementåˆ›å»ºå¼€é”€    |
| **BatchExecutor**   | æ‰¹é‡æ‰§è¡Œå¤šä¸ªSQL         | æ‰¹é‡æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ | å¤§å¹…å‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°   |
| **CachingExecutor** | è£…é¥°å™¨æ¨¡å¼ï¼Œæ·»åŠ ç¼“å­˜    | éœ€è¦ç¼“å­˜çš„æŸ¥è¯¢åœºæ™¯   | é¿å…é‡å¤æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½   |

**é€‰æ‹©å»ºè®®**ï¼š

- **é»˜è®¤åœºæ™¯**ï¼šä½¿ç”¨SimpleExecutorï¼Œç®€å•å¯é 
- **é‡å¤SQL**ï¼šä½¿ç”¨ReuseExecutorï¼Œæå‡æ€§èƒ½
- **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨BatchExecutorï¼Œå¤§å¹…æå‡æ‰¹é‡æ“ä½œæ€§èƒ½
- **ç¼“å­˜éœ€æ±‚**ï¼šé…åˆCachingExecutorï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

## 7. å®è·µæ¡ˆä¾‹

### 7.1 è·Ÿè¸ªSqlSessionåˆ›å»ºæµç¨‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥è·Ÿè¸ªSqlSessionçš„åˆ›å»ºæµç¨‹ï¼š

#### 7.1.1 mybatis-config.xmlé…ç½®æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis_test"/>
                <property name="username" value="root"/>
                <property name="password" value="password"/>
            </dataSource>
        </environment>
    </environments>
  
    <mappers>
        <mapper resource="UserMapper.xml"/>
    </mappers>
</configuration>
```

#### 7.1.2 UserMapper.javaæ¥å£

```java
package com.example.mapper;

import com.example.model.User;
import java.util.List;

public interface UserMapper {
    User selectUser(int id);
    List<User> selectAllUsers();
    int insertUser(User user);
    int updateUser(User user);
    int deleteUser(int id);
}
```

#### 7.1.3 SqlSessionåˆ›å»ºç¤ºä¾‹

```java
package com.example;

import com.example.mapper.UserMapper;
import com.example.model.User;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;

public class SqlSessionCreationExample {
    public static void main(String[] args) throws IOException {
        // 1. åˆ›å»ºSqlSessionFactoryBuilder
        SqlSessionFactoryBuilder builder = new SqlSessionFactoryBuilder();
    
        // 2. è§£æé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºSqlSessionFactory
        String resource = "mybatis-config.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory sqlSessionFactory = builder.build(inputStream);
    
        // 3. åˆ›å»ºSqlSession
        SqlSession session = sqlSessionFactory.openSession();
    
        // 4. ä½¿ç”¨SqlSession
        User user = session.selectOne("selectUser", 1);
        System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
      
        // 5. ä½¿ç”¨Mapperæ¥å£
        UserMapper userMapper = session.getMapper(UserMapper.class);
        User user2 = userMapper.selectUser(1);
        System.out.println("MapperæŸ¥è¯¢ç»“æœ: " + user2);
    
        // 6. å…³é—­SqlSession
        session.close();
    }
}
```

**æ‰§è¡Œæµç¨‹åˆ†æ**ï¼š

1. **SqlSessionFactoryBuilder.build()**ï¼š

   - åˆ›å»ºXMLConfigBuilder
   - è§£æé…ç½®æ–‡ä»¶
   - åˆ›å»ºConfigurationå¯¹è±¡
   - åˆ›å»ºDefaultSqlSessionFactory
2. **DefaultSqlSessionFactory.openSession()**ï¼š

   - è°ƒç”¨openSessionFromDataSource()
   - è·å–Environmenté…ç½®
   - åˆ›å»ºTransactionFactory
   - åˆ›å»ºTransactionå¯¹è±¡
   - åˆ›å»ºExecutor
   - åˆ›å»ºDefaultSqlSession
3. **DefaultSqlSessionä½¿ç”¨**ï¼š

   - è°ƒç”¨selectOne()æ–¹æ³•
   - å†…éƒ¨è°ƒç”¨selectList()
   - å§”æ‰˜ç»™Executoræ‰§è¡Œ
   - è¿”å›æŸ¥è¯¢ç»“æœ
4. **èµ„æºé‡Šæ”¾**ï¼š

   - è°ƒç”¨session.close()
   - å…³é—­Executor
   - å…³é—­Transaction
   - å…³é—­Connection

### 7.2 åˆ†æä¸åŒExecutorç±»å‹çš„ä½¿ç”¨åœºæ™¯

```java
public class ExecutorTypeExample {
    public static void main(String[] args) {
        SqlSessionFactory sqlSessionFactory = createSqlSessionFactory();
    
        // 1. ä½¿ç”¨SimpleExecutorï¼ˆé»˜è®¤ï¼‰
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.SIMPLE)) {
            System.out.println("ä½¿ç”¨SimpleExecutoræ‰§è¡ŒæŸ¥è¯¢");
            User user = session.selectOne("selectUser", 1);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
        }
    
        // 2. ä½¿ç”¨ReuseExecutor
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.REUSE)) {
            System.out.println("ä½¿ç”¨ReuseExecutoræ‰§è¡ŒæŸ¥è¯¢");
            User user = session.selectOne("selectUser", 1);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
        }
    
        // 3. ä½¿ç”¨BatchExecutor
        try (SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH)) {
            System.out.println("ä½¿ç”¨BatchExecutoræ‰§è¡Œæ‰¹é‡æ›´æ–°");
        
            // æ‰¹é‡æ’å…¥
            for (int i = 1; i <= 10; i++) {
                User user = new User(i, "User" + i, "user" + i + "@example.com");
                session.insert("insertUser", user);
            }
        
            // æ‰§è¡Œæ‰¹é‡æ“ä½œ
            List<BatchResult> results = session.flushStatements();
            System.out.println("æ‰¹é‡æ‰§è¡Œç»“æœæ•°é‡: " + results.size());
        
            // æäº¤äº‹åŠ¡
            session.commit();
        }
    }
}
```

### 7.3 åˆ†æSqlSessionçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

```java
public class SqlSessionLifecycleExample {
    public static void main(String[] args) {
        SqlSessionFactory sqlSessionFactory = createSqlSessionFactory();
    
        // 1. æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
        SqlSession session = sqlSessionFactory.openSession();
        try {
            // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            User user = session.selectOne("selectUser", 1);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
        
            // æäº¤äº‹åŠ¡
            session.commit();
        } catch (Exception e) {
            // å›æ»šäº‹åŠ¡
            session.rollback();
            e.printStackTrace();
        } finally {
            // å…³é—­ä¼šè¯
            session.close();
        }
    
        // 2. è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼ˆæ¨èæ–¹å¼ï¼‰
        try (SqlSession session2 = sqlSessionFactory.openSession()) {
            User user = session2.selectOne("selectUser", 1);
            System.out.println("æŸ¥è¯¢ç»“æœ: " + user);
            session2.commit();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 8. æºç å­¦ä¹ è·¯å¾„

### 8.1 åç»­æ–‡ç« è§„åˆ’

åŸºäºSqlSessionçš„ç†è§£ï¼Œåç»­æˆ‘ä»¬å°†æ·±å…¥åˆ†æï¼š

1. **ç¬¬4ç¯‡**ï¼šMapperæ¥å£çš„åŠ¨æ€ä»£ç†æœºåˆ¶

   - MapperProxyæºç åˆ†æ
   - æ¥å£æ–¹æ³•è§£æ
   - å‚æ•°ç»‘å®šå’Œç»“æœæ˜ å°„
2. **ç¬¬5ç¯‡**ï¼šExecutoræ‰§è¡Œå™¨ä½“ç³»è¯¦è§£

   - BaseExecutoræ¨¡æ¿æ–¹æ³•æ¨¡å¼
   - StatementHandlerè¯­å¥å¤„ç†å™¨
   - ParameterHandlerå‚æ•°å¤„ç†å™¨
   - ResultSetHandlerç»“æœé›†å¤„ç†å™¨
3. **ç¬¬6ç¯‡**ï¼šStatementHandlerè¯­å¥å¤„ç†å™¨

   - RoutingStatementHandlerè·¯ç”±æœºåˆ¶
   - PreparedStatementHandlerå®ç°
   - SQLé¢„å¤„ç†å’Œå‚æ•°ç»‘å®š

### 8.2 å­¦ä¹ å»ºè®®

1. **æ·±å…¥ç†è§£**ï¼šæ·±å…¥ç†è§£SqlSessionçš„è®¾è®¡æ€æƒ³å’Œå®ç°åŸç†
2. **å®è·µéªŒè¯**ï¼šé€šè¿‡è°ƒè¯•éªŒè¯å¯¹SqlSessionçš„ç†è§£
3. **æºç åˆ†æ**ï¼šåˆ†æå…³é”®æ–¹æ³•çš„æºç å®ç°
4. **æ‰©å±•å¼€å‘**ï¼šå°è¯•å¼€å‘ç®€å•çš„SqlSessionæ‰©å±•åŠŸèƒ½

### 8.3 å®è·µè¦æ±‚

1. **ç¯å¢ƒæ­å»º**ï¼šç¡®ä¿èƒ½å¤Ÿè°ƒè¯•SqlSessionç›¸å…³æºç 
2. **æºç åˆ†æ**ï¼šåˆ†æDefaultSqlSessionå’ŒDefaultSqlSessionFactoryçš„æºç 
3. **å®è·µéªŒè¯**ï¼šé€šè¿‡è°ƒè¯•éªŒè¯SqlSessionåˆ›å»ºå’Œä½¿ç”¨æµç¨‹
4. **ç¬”è®°è®°å½•**ï¼šè®°å½•æºç åˆ†æçš„å¿ƒå¾—ä½“ä¼š

## æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†MyBatis SqlSessionçš„æ ¸å¿ƒæœºåˆ¶ï¼š

1. **SqlSessionæ¥å£**ï¼šæä¾›äº†å®Œæ•´çš„æ•°æ®åº“æ“ä½œAPIï¼Œæ”¯æŒæŸ¥è¯¢ã€æ›´æ–°ã€äº‹åŠ¡ç®¡ç†ç­‰åŠŸèƒ½
2. **SqlSessionFactory**ï¼šé‡‡ç”¨å·¥å‚æ¨¡å¼ï¼Œå°è£…äº†SqlSessionçš„åˆ›å»ºå¤æ‚æ€§
3. **DefaultSqlSession**ï¼šSqlSessionçš„é»˜è®¤å®ç°ï¼Œæ˜¯ç”¨æˆ·æ“ä½œæ•°æ®åº“çš„ä¸»è¦å…¥å£
4. **Executoræ‰§è¡Œå™¨**ï¼šSqlSessionçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å…·ä½“çš„SQLæ‰§è¡Œ
5. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä»åˆ›å»ºåˆ°é”€æ¯çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†

**é‡è¦æç¤º**ï¼šSqlSessionæ˜¯MyBatisæ¶æ„çš„æ ¸å¿ƒï¼Œç†è§£SqlSessionå¯¹äºåç»­çš„æºç å­¦ä¹ è‡³å…³é‡è¦ã€‚é€šè¿‡æºç åˆ†æï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ›´æ·±å…¥åœ°ç†è§£MyBatisçš„è®¾è®¡æ€æƒ³å’Œå®ç°ç»†èŠ‚ã€‚

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†åŸºäºSqlSessionçš„ç†è§£ï¼Œæ·±å…¥åˆ†æMapperæ¥å£çš„åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œäº†è§£MyBatisæ˜¯å¦‚ä½•å®ç°æ¥å£ä»£ç†çš„ã€‚

---

**æ€è€ƒé¢˜**ï¼š

1. **ä¸ºä»€ä¹ˆMyBatisè¦è®¾è®¡SqlSessionæ¥å£ï¼Ÿè¿™ç§è®¾è®¡æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ**

   **æç¤ºç­”æ¡ˆ**ï¼š

   - **ç»Ÿä¸€æŠ½è±¡**ï¼šæä¾›ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œæ¥å£ï¼Œéšè—åº•å±‚å¤æ‚æ€§
   - **èµ„æºç®¡ç†**ï¼šé›†ä¸­ç®¡ç†æ•°æ®åº“è¿æ¥ã€äº‹åŠ¡ç­‰èµ„æº
   - **çº¿ç¨‹å®‰å…¨**ï¼šSqlSessionæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå»ºè®®åœ¨æ–¹æ³•ä½œç”¨åŸŸä½¿ç”¨ï¼Œé¿å…å¹¶å‘é—®é¢˜
   - **ç”Ÿå‘½å‘¨æœŸæ§åˆ¶**ï¼šæ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
   - **æ‰©å±•æ€§**ï¼šæ¥å£è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•å’Œå®šåˆ¶
2. **SqlSessionFactoryçš„å·¥å‚æ¨¡å¼è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**

   **æç¤ºç­”æ¡ˆ**ï¼š

   - **å°è£…å¤æ‚æ€§**ï¼šéšè—SqlSessionåˆ›å»ºçš„å¤æ‚è¿‡ç¨‹
   - **å‚æ•°çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§å‚æ•°ç»„åˆåˆ›å»ºä¸åŒç±»å‹çš„SqlSession
   - **é…ç½®é©±åŠ¨**ï¼šåŸºäºConfigurationé…ç½®åˆ›å»ºSqlSession
   - **å•ä¾‹æ¨¡å¼**ï¼šSqlSessionFactoryé€šå¸¸ä¸ºå•ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
   - **è§£è€¦è®¾è®¡**ï¼šå°†åˆ›å»ºé€»è¾‘ä¸ä½¿ç”¨é€»è¾‘åˆ†ç¦»
3. **ä¸åŒExecutorç±»å‹çš„é€‚ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é€‰æ‹©ï¼Ÿ**

   **æç¤ºç­”æ¡ˆ**ï¼š

   - **SimpleExecutor**ï¼šé»˜è®¤é€‰æ‹©ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼Œç®€å•å¯é 
   - **ReuseExecutor**ï¼šé€‚åˆé‡å¤æ‰§è¡Œç›¸åŒSQLçš„åœºæ™¯ï¼Œå¦‚å¾ªç¯æŸ¥è¯¢
   - **BatchExecutor**ï¼šé€‚åˆæ‰¹é‡æ“ä½œï¼Œå¦‚æ‰¹é‡æ’å…¥ã€æ›´æ–°ã€åˆ é™¤
   - **CachingExecutor**ï¼šè£…é¥°å™¨æ¨¡å¼ï¼Œä¸ºå…¶ä»–æ‰§è¡Œå™¨æ·»åŠ ç¼“å­˜åŠŸèƒ½
   - **é€‰æ‹©åŸåˆ™**ï¼šæ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯å’Œæ€§èƒ½éœ€æ±‚é€‰æ‹©
4. **SqlSessionçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†éœ€è¦æ³¨æ„å“ªäº›é—®é¢˜ï¼Ÿ**

   **æç¤ºç­”æ¡ˆ**ï¼š

   - **åŠæ—¶å…³é—­**ï¼šä½¿ç”¨å®Œæ¯•ååŠæ—¶è°ƒç”¨close()æ–¹æ³•
   - **å¼‚å¸¸å¤„ç†**ï¼šåœ¨finallyå—ä¸­ç¡®ä¿èµ„æºé‡Šæ”¾
   - **ä½œç”¨åŸŸæ§åˆ¶**ï¼šå»ºè®®åœ¨æ–¹æ³•ä½œç”¨åŸŸå†…ä½¿ç”¨ï¼Œé¿å…é•¿æ—¶é—´æŒæœ‰
   - **äº‹åŠ¡ç®¡ç†**ï¼šæ³¨æ„äº‹åŠ¡çš„æäº¤å’Œå›æ»šæ—¶æœº
   - **è¿æ¥æ³„æ¼**ï¼šé¿å…å¿˜è®°å…³é—­SqlSessionå¯¼è‡´è¿æ¥æ³„æ¼

**ä¸‹ç¯‡é¢„å‘Š**ï¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥åˆ†æMapperæ¥å£çš„åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œå¹¶è¯¦ç»†è§£ç­”ä»¥ä¸Šæ€è€ƒé¢˜ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£SqlSessionåœ¨æ•´ä¸ªæ¶æ„ä¸­çš„ä½œç”¨ã€‚
